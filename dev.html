<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <style>
        .glassmorphism {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .gradient-bg {
            background: linear-gradient(135deg, #6e45e2 0%, #88d3ce 100%);
        }
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #fff;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .login-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        .login-modal.active {
            opacity: 1;
            visibility: visible;
        }
        .login-content {
            background: linear-gradient(135deg, #6e3b9c 0%, #3b1d6c 50%, #1a0933 100%);
            border-radius: 16px;
            padding: 2rem;
            max-width: 400px;
            width: 90%;
            text-align: center;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }
        .login-modal.active .login-content {
            transform: scale(1);
        }
        .medal-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 1rem;
            background: linear-gradient(135deg, #FFD700 0%, #DAA520 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }
        .user-status-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .status-blacklisted {
            background-color: #ef4444;
            color: white;
        }
        .status-clean {
            background-color: #10b981;
            color: white;
        }
        /* Modal styles for trolling options */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background: linear-gradient(135deg, #6e3b9c 0%, #3b1d6c 50%, #1a0933 100%);
            border-radius: 16px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }
        
        .modal-overlay.active .modal-content {
            transform: scale(1);
        }
        
        .user-checkbox {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            border-radius: 0.5rem;
            margin-bottom: 0.25rem;
            transition: background-color 0.2s;
        }
        
        .user-checkbox:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        .status-warned {
            background-color: #f59e0b;
            color: white;
        }
        
        .warnings-badge {
            display: inline-flex;
            align-items: center;
            background-color: #f59e0b;
            color: white;
            border-radius: 9999px;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }
    </style>
</head>
<body class="min-h-screen gradient-bg text-white font-sans">
    <!-- Login Modal -->
    <div id="loginModal" class="login-modal">
        <div class="login-content">
            <div class="medal-icon">
                <i data-feather="award" class="w-10 h-10 text-white"></i>
            </div>
            <h2 class="text-2xl font-bold mb-4">Authentication Required</h2>
            <p class="text-gray-300 mb-6">You need to be logged in to access the admin management system.</p>
            <button onclick="redirectToLogin()" class="bg-purple-600 hover:bg-purple-700 py-3 px-6 rounded-lg font-medium w-full mb-4">
                Sign In
            </button>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50">
        <div class="glassmorphism rounded-xl p-8 max-w-md w-full mx-4 text-center">
            <div class="loading-spinner mb-4"></div>
            <h2 class="text-2xl font-bold mb-2">Verifying session...</h2>
            <p class="text-gray-300">Please wait while we verify your permissions</p>
        </div>
    </div>

    <!-- Trolling Options Modals -->
    <div id="broadcastModal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Broadcast Message</h2>
                <button onclick="closeModal('broadcastModal')" class="p-1 rounded-full hover:bg-purple-700">
                    <i data-feather="x" class="w-5 h-5"></i>
                </button>
            </div>
            
            <!-- Add sender type for broadcasts too -->
            <div class="mb-4">
                <label class="block text-gray-300 mb-2">Send As</label>
                <div class="flex space-x-4">
                    <label class="flex items-center">
                        <input type="radio" name="broadcastSenderType" value="user" checked class="mr-2">
                        <span>My Account</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="broadcastSenderType" value="system" class="mr-2">
                        <span>System</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="broadcastSenderType" value="anonymous" class="mr-2">
                        <span>Anonymous</span>
                    </label>
                </div>
            </div>
            
            <div class="mb-4">
                <label for="broadcastMessage" class="block text-gray-300 mb-2">Message</label>
                <textarea id="broadcastMessage" class="w-full bg-gray-800 bg-opacity-50 border border-gray-700 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500" rows="4" placeholder="Enter message to broadcast to all users"></textarea>
            </div>
            
            <div class="mb-4">
                <label for="broadcastDuration" class="block text-gray-300 mb-2">Duration (hours)</label>
                <select id="broadcastDuration" class="w-full bg-gray-800 bg-opacity-50 border border-gray-700 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                    <option value="1">1 hour</option>
                    <option value="6">6 hours</option>
                    <option value="24" selected>24 hours</option>
                    <option value="72">72 hours</option>
                    <option value="168">1 week</option>
                </select>
            </div>
            
            <button onclick="sendBroadcast()" class="bg-purple-600 hover:bg-purple-700 text-white py-2 px-6 rounded-lg font-medium w-full">
                Send Broadcast
            </button>
        </div>
    </div>

    <div id="specificMessageModal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Send Specific Message</h2>
                <button onclick="closeModal('specificMessageModal')" class="p-1 rounded-full hover:bg-purple-700">
                    <i data-feather="x" class="w-5 h-5"></i>
                </button>
            </div>
            
            <!-- Add sender type selection -->
            <div class="mb-4">
                <label class="block text-gray-300 mb-2">Send As</label>
                <div class="flex space-x-4">
                    <label class="flex items-center">
                        <input type="radio" name="senderType" value="user" checked class="mr-2" onchange="toggleCustomSender()">
                        <span>My Account</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="senderType" value="system" class="mr-2" onchange="toggleCustomSender()">
                        <span>System</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="senderType" value="anonymous" class="mr-2" onchange="toggleCustomSender()">
                        <span>Anonymous</span>
                    </label>
                </div>
            </div>
            
            <div class="mb-4">
                <label for="specificMessage" class="block text-gray-300 mb-2">Message</label>
                <textarea id="specificMessage" class="w-full bg-gray-800 bg-opacity-50 border border-gray-700 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500" rows="4" placeholder="Enter message to send to selected users"></textarea>
            </div>
            
            <div class="mb-4">
                <label class="block text-gray-300 mb-2">Select Recipients</label>
                <div class="max-h-48 overflow-y-auto bg-gray-800 bg-opacity-50 rounded-lg p-2" id="recipientsList">
                    <!-- Users will be populated here -->
                </div>
            </div>
            
            <div class="flex space-x-2 mb-4">
                <button onclick="selectAllUsers()" class="bg-gray-600 hover:bg-gray-700 text-white py-2 px-4 rounded-lg font-medium flex-1">
                    Select All
                </button>
                <button onclick="deselectAllUsers()" class="bg-gray-600 hover:bg-gray-700 text-white py-2 px-4 rounded-lg font-medium flex-1">
                    Deselect All
                </button>
            </div>
            
            <button onclick="sendSpecificMessage()" class="bg-purple-600 hover:bg-purple-700 text-white py-2 px-6 rounded-lg font-medium w-full">
                Send Message
            </button>
        </div>
    </div>

    <div id="warnModal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Warn User</h2>
                <button onclick="closeModal('warnModal')" class="p-1 rounded-full hover:bg-purple-700">
                    <i data-feather="x" class="w-5 h-5"></i>
                </button>
            </div>
            
            <!-- Add sender type selection for warnings -->
            <div class="mb-4">
                <label class="block text-gray-300 mb-2">Send As</label>
                <div class="flex space-x-4">
                    <label class="flex items-center">
                        <input type="radio" name="warnSenderType" value="user" checked class="mr-2">
                        <span>My Account</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="warnSenderType" value="system" class="mr-2">
                        <span>System</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="warnSenderType" value="anonymous" class="mr-2">
                        <span>Anonymous</span>
                    </label>
                </div>
            </div>
            
            <div class="mb-4">
                <label for="warnUsername" class="block text-gray-300 mb-2">Username</label>
                <input type="text" id="warnUsername" class="w-full bg-gray-800 bg-opacity-50 border border-gray-700 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="Enter username to warn">
            </div>
            <div class="mb-4">
                <label for="warnMessage" class="block text-gray-300 mb-2">Warning Message</label>
                <textarea id="warnMessage" class="w-full bg-gray-800 bg-opacity-50 border border-gray-700 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500" rows="4" placeholder="Enter warning message"></textarea>
            </div>
            <button onclick="sendWarning()" class="bg-red-600 hover:bg-red-700 text-white py-2 px-6 rounded-lg font-medium w-full">
                Send Warning
            </button>
        </div>
    </div>

    <!-- Remote Delete Modal -->
    <div id="remoteDeleteModal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Delete User Account</h2>
                <button onclick="closeModal('remoteDeleteModal')" class="p-1 rounded-full hover:bg-purple-700">
                    <i data-feather="x" class="w-5 h-5"></i>
                </button>
            </div>
            
            <div class="mb-4">
                <p class="text-gray-300 mb-2">You are about to delete the account of:</p>
                <p id="deleteUsernameDisplay" class="font-bold text-lg text-red-400"></p>
                <p id="deleteUserRole" class="text-sm text-gray-400"></p>
            </div>
            
            <div class="mb-4 p-3 bg-red-900 bg-opacity-30 border border-red-700 rounded-lg">
                <div class="flex items-center">
                    <i data-feather="alert-triangle" class="w-5 h-5 text-red-400 mr-2"></i>
                    <span class="text-red-300 font-medium">Warning: This action cannot be undone!</span>
                </div>
                <p class="text-sm text-red-200 mt-1">
                    All user data, warnings, and keys will be permanently deleted.
                </p>
            </div>
            
            <div class="mb-4">
                <label for="adminPassword" class="block text-gray-300 mb-2">
                    Confirm Your Password
                </label>
                <input type="password" id="adminPassword" 
                       class="w-full bg-gray-800 bg-opacity-50 border border-gray-700 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500" 
                       placeholder="Enter your password to confirm">
                <p class="text-xs text-gray-400 mt-1">
                    For security, please re-enter your password to confirm this action.
                </p>
            </div>
            
            <div class="flex space-x-2">
                <button onclick="closeModal('remoteDeleteModal')" 
                        class="bg-gray-600 hover:bg-gray-700 text-white py-2 px-4 rounded-lg font-medium flex-1">
                    Cancel
                </button>
                <button onclick="confirmRemoteDelete()" 
                        class="bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-lg font-medium flex-1">
                    Delete Account
                </button>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="relative z-10 min-h-screen flex flex-col">
        <!-- Header -->
        <header class="glassmorphism p-4 shadow-lg">
            <div class="container mx-auto flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <h1 class="text-2xl font-bold">Admin Management</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="logoutButton" class="p-2 rounded-full hover:bg-purple-700 transition">
                        <i data-feather="log-out"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 container mx-auto p-4 md:p-6">
            <!-- User Info -->
            <div id="userInfo" class="glassmorphism rounded-xl p-6 mb-6 hidden">
                <h2 class="text-xl font-semibold mb-4">Your Account</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <p class="text-gray-300">Username</p>
                        <p id="userUsername" class="font-medium"></p>
                    </div>
                    <div>
                        <p class="text-gray-300">Role</p>
                        <p id="userRole" class="font-medium"></p>
                    </div>
                </div>
            </div>

            <!-- Trolling Options -->
            <div class="glassmorphism rounded-xl p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">Admin Tools</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <button onclick="openModal('broadcastModal')" class="bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded-lg font-medium flex flex-col items-center justify-center">
                        <i data-feather="megaphone" class="w-8 h-8 mb-2"></i>
                        <span>Broadcast Message</span>
                    </button>
                    <button onclick="openModal('specificMessageModal')" class="bg-green-600 hover:bg-green-700 text-white py-3 px-4 rounded-lg font-medium flex flex-col items-center justify-center">
                        <i data-feather="mail" class="w-8 h-8 mb-2"></i>
                        <span>Specific Message</span>
                    </button>
                    <button onclick="openModal('warnModal')" class="bg-red-600 hover:bg-red-700 text-white py-3 px-4 rounded-lg font-medium flex flex-col items-center justify-center">
                        <i data-feather="alert-triangle" class="w-8 h-8 mb-2"></i>
                        <span>Warn User</span>
                    </button>
                </div>
            </div>

            <!-- Blacklist Form -->
            <div class="glassmorphism rounded-xl p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">Blacklist User</h2>
                <form id="blacklistForm" class="space-y-4">
                    <div>
                        <label for="username" class="block text-gray-300 mb-2">Username</label>
                        <input type="text" id="username" required class="w-full bg-gray-800 bg-opacity-50 border border-gray-700 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                    <div>
                        <label for="reason" class="block text-gray-300 mb-2">Reason</label>
                        <textarea id="reason" required class="w-full bg-gray-800 bg-opacity-50 border border-gray-700 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500" rows="3"></textarea>
                    </div>
                    <button type="submit" class="bg-red-600 hover:bg-red-700 text-white py-2 px-6 rounded-lg font-medium">
                        Blacklist User
                    </button>
                </form>
            </div>

            <!-- Role Management -->
            <div class="glassmorphism rounded-xl p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">Role Management</h2>
                <form id="roleForm" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="roleUsername" class="block text-gray-300 mb-2">Username</label>
                            <input type="text" id="roleUsername" required 
                                   class="w-full bg-gray-800 bg-opacity-50 border border-gray-700 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500"
                                   placeholder="Enter username">
                        </div>
                        <div>
                            <label for="userRole" class="block text-gray-300 mb-2">New Role</label>
                            <select id="userRole" required 
                                    class="w-full bg-gray-800 bg-opacity-50 border border-gray-700 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <option value="">Select a role</option>
                                <option value="Member">Member</option>
                                <option value="Moderator">Moderator</option>
                                <option value="Admin">Admin</option>
                                <option value="Owner">Owner</option>
                            </select>
                        </div>
                    </div>
                    <div id="roleHelp" class="text-sm text-gray-400 hidden">
                        <!-- Help text will be populated dynamically -->
                    </div>
                    <button type="submit" class="bg-purple-600 hover:bg-purple-700 text-white py-2 px-6 rounded-lg font-medium">
                        Assign Role
                    </button>
                </form>
            </div>

            <!-- Users List -->
            <div class="glassmorphism rounded-xl p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-semibold">All Users</h2>
                    <button id="refreshUsers" class="p-2 rounded-full hover:bg-purple-700 transition">
                        <i data-feather="refresh-cw"></i>
                    </button>
                </div>
                <div id="usersList" class="space-y-4">
                    <!-- Users will be loaded here -->
                </div>
            </div>
        </main>
    </div>

<script>
    // Initialize animations and icons
    AOS.init();
    feather.replace();

    // Server URL
    const SERVER_URL = "https://proxyforsigmi.onrender.com";

    // Global variables to track current user info
    let currentUser = '';
    let currentUserRole = '';

    // Function to escape special characters for HTML attributes
    function escapeHtml(unsafe) {
        return unsafe
            .replace(/'/g, "\\'")
            .replace(/"/g, '\\"')
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;");
    }

    // Function to check if user is logged in
    function isLoggedIn() {
        const token = getCookie('AuthToken');
        const storedUser = localStorage.getItem('currentUser');
        return !!(token && storedUser);
    }

    // Function to verify token with server
    async function verifyToken(token) {
        try {
            const response = await fetch(`${SERVER_URL}/api/verify-token`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
            
            if (response.status === 401) {
                return false;
            }
            
            if (!response.ok) {
                return false;
            }
            
            const data = await response.json();
            return data.valid === true;
        } catch (error) {
            console.error('Token verification error:', error);
            return false;
        }
    }

    // Function to get user info
    async function getUserInfo(token) {
        try {
            const response = await fetch(`${SERVER_URL}/api/user-info`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
            
            if (!response.ok) {
                throw new Error('Failed to get user info');
            }
            
            return await response.json();
        } catch (error) {
            console.error('Get user info error:', error);
            throw error;
        }
    }

    // Modal functions
    function openModal(modalId) {
        document.getElementById(modalId).classList.add('active');
        
        // If opening specific message modal, populate users list
        if (modalId === 'specificMessageModal') {
            populateRecipientsList();
        }
    }
    
    function closeModal(modalId) {
        document.getElementById(modalId).classList.remove('active');
    }
    
    // Populate recipients list for specific messages
    function populateRecipientsList() {
        const recipientsList = document.getElementById('recipientsList');
        const users = JSON.parse(localStorage.getItem('allUsers') || '[]');
        
        recipientsList.innerHTML = '';
        
        users.forEach(user => {
            const userDiv = document.createElement('div');
            userDiv.className = 'user-checkbox';
            userDiv.innerHTML = `
                <input type="checkbox" id="user-${user.username}" name="recipients" value="${escapeHtml(user.username)}" class="mr-2">
                <label for="user-${user.username}" class="cursor-pointer">${user.username} (${user.role})</label>
            `;
            recipientsList.appendChild(userDiv);
        });
    }
    
    // Select all users for messaging
    function selectAllUsers() {
        const checkboxes = document.querySelectorAll('input[name="recipients"]');
        checkboxes.forEach(checkbox => {
            checkbox.checked = true;
        });
    }
    
    // Deselect all users for messaging
    function deselectAllUsers() {
        const checkboxes = document.querySelectorAll('input[name="recipients"]');
        checkboxes.forEach(checkbox => {
            checkbox.checked = false;
        });
    }
    
    function toggleCustomSender() {
        // This can be expanded if you need custom sender names
    }

    // Update the sendBroadcast function
    async function sendBroadcast() {
        const message = document.getElementById('broadcastMessage').value.trim();
        const duration = parseInt(document.getElementById('broadcastDuration').value);
        const senderType = document.querySelector('input[name="broadcastSenderType"]:checked').value;
        
        if (!message) {
            alert('Please enter a message to broadcast');
            return;
        }
        
        try {
            const token = getCookie('AuthToken');
            const response = await fetch(`${SERVER_URL}/api/broadcast`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 
                    message, 
                    duration,
                    senderType // Add sender type to request
                })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Failed to send broadcast');
            }
            
            const result = await response.json();
            alert(`Broadcast sent successfully as ${senderType}! It will be active for ${duration} hours.`);
            closeModal('broadcastModal');
            document.getElementById('broadcastMessage').value = '';
            
        } catch (error) {
            console.error('Broadcast error:', error);
            alert(`Error: ${error.message}`);
        }
    }

    // Update the sendSpecificMessage function
    async function sendSpecificMessage() {
        const message = document.getElementById('specificMessage').value.trim();
        const checkboxes = document.querySelectorAll('input[name="recipients"]:checked');
        const recipients = Array.from(checkboxes).map(cb => cb.value);
        const senderType = document.querySelector('input[name="senderType"]:checked').value;
        
        if (!message) {
            alert('Please enter a message to send');
            return;
        }
        
        if (recipients.length === 0) {
            alert('Please select at least one recipient');
            return;
        }
        
        try {
            const token = getCookie('AuthToken');
            const response = await fetch(`${SERVER_URL}/api/messages/send`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 
                    message, 
                    recipients,
                    duration: 168, // 1 week default
                    senderType // Add sender type to request
                })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Failed to send message');
            }
            
            const result = await response.json();
            alert(`✅ Message sent as ${senderType} to ${result.recipients.length} user(s)!`);
            closeModal('specificMessageModal');
            document.getElementById('specificMessage').value = '';
            deselectAllUsers();
            
        } catch (error) {
            console.error('Message send error:', error);
            alert(`❌ Error: ${error.message}`);
        }
    }
    
    async function sendWarning() {
        const username = document.getElementById('warnUsername').value.trim();
        const reason = document.getElementById('warnMessage').value.trim();
        const senderType = document.querySelector('input[name="warnSenderType"]:checked').value;
        
        if (!username) {
            alert('Please enter a username to warn');
            return;
        }
        
        if (!reason) {
            alert('Please enter a warning reason');
            return;
        }
        
        try {
            const token = getCookie('AuthToken');
            const response = await fetch(`${SERVER_URL}/api/warnings/issue`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 
                    username, 
                    reason,
                    senderType // Add sender type to request
                })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Failed to send warning');
            }
            
            const result = await response.json();
            alert(`⚠️ Warning issued as ${senderType} to ${username}: "${reason}"\nWarning ID: ${result.warning.id}`);
            closeModal('warnModal');
            document.getElementById('warnUsername').value = '';
            document.getElementById('warnMessage').value = '';
            
        } catch (error) {
            console.error('Warning error:', error);
            alert(`❌ Error: ${error.message}`);
        }
    }
    
    async function viewUserWarnings(username) {
        if (!username) {
            alert('Please enter a username');
            return;
        }
        
        try {
            const token = getCookie('AuthToken');
            const response = await fetch(`${SERVER_URL}/api/admin/warnings/${encodeURIComponent(username)}`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Failed to fetch warnings');
            }
            
            const warnings = await response.json();
            showWarningsModal(username, warnings);
            
        } catch (error) {
            console.error('Fetch warnings error:', error);
            alert(`Error: ${error.message}`);
        }
    }

    // Fixed showWarningsModal function with proper escaping
    function showWarningsModal(username, warnings) {
        // Count active and dismissed warnings
        const activeWarnings = warnings.filter(w => !w.dismissed);
        const dismissedWarnings = warnings.filter(w => w.dismissed);
        
        let warningsHTML = '';
        
        if (warnings.length === 0) {
            warningsHTML = '<p class="text-gray-400 text-center py-4">No warnings found</p>';
        } else {
            warningsHTML = warnings.map(warning => {
                const isDismissed = warning.dismissed;
                const safeUsername = escapeHtml(username);
                const safeWarningId = escapeHtml(warning.id);
                const safeReason = escapeHtml(warning.reason);
                const safeIssuedBy = escapeHtml(warning.issuedBy);
                const safeOriginalIssuer = escapeHtml(warning.originalIssuer || '');
                const safeSenderType = escapeHtml(warning.senderType || 'user');
                const safeDismissedBy = escapeHtml(warning.dismissedBy || '');
                
                const dismissedHTML = isDismissed ? 
                    '<p class="text-sm text-green-300">Dismissed on ' + new Date(warning.dismissedAt).toLocaleDateString() + 
                    (warning.dismissedBy ? ' by ' + safeDismissedBy : '') + '</p>' :
                    '<p class="text-sm text-yellow-300">Active warning</p>';
                    
                const dismissButton = !isDismissed ? 
                    '<button onclick="dismissWarning(\'' + safeUsername + '\', \'' + safeWarningId + '\')" class="bg-green-600 hover:bg-green-700 text-white px-2 py-1 rounded text-sm" title="Dismiss Warning"><i data-feather="check" class="w-3 h-3"></i></button>' :
                    '';
                    
                return '<div class="glassmorphism p-3 rounded-lg mb-2 ' + (isDismissed ? 'opacity-70' : '') + '">' +
                    '<div class="flex justify-between items-start">' +
                        '<div class="flex-1">' +
                            '<p class="font-medium">' + safeReason + '</p>' +
                            '<p class="text-sm text-gray-300">Issued by: ' + safeIssuedBy + 
                            (warning.senderType === 'user' ? ' (' + safeOriginalIssuer + ')' : '') +
                            ' on ' + new Date(warning.issuedAt).toLocaleDateString() + '</p>' +
                            '<p class="text-xs text-gray-400">Type: ' + safeSenderType + '</p>' +
                            dismissedHTML +
                        '</div>' +
                        '<div class="flex space-x-1 ml-2">' +
                            dismissButton +
                            '<button onclick="deleteWarning(\'' + safeUsername + '\', \'' + safeWarningId + '\')" class="bg-red-600 hover:bg-red-700 text-white px-2 py-1 rounded text-sm" title="Delete Warning Permanently"><i data-feather="trash-2" class="w-3 h-3"></i></button>' +
                        '</div>' +
                    '</div>' +
                '</div>';
            }).join('');
        }
        
        const safeUsername = escapeHtml(username);
        const bulkActionsHTML = 
            (warnings.length > 0 ? '<button onclick="deleteAllWarnings(\'' + safeUsername + '\', ' + warnings.length + ')" class="bg-red-600 hover:bg-red-700 text-white py-1 px-3 rounded text-sm">Delete All</button>' : '') +
            (dismissedWarnings.length > 0 ? '<button onclick="deleteDismissedWarnings(\'' + safeUsername + '\', ' + dismissedWarnings.length + ')" class="bg-orange-600 hover:bg-orange-700 text-white py-1 px-3 rounded text-sm">Delete Dismissed</button>' : '');
        
        const modalHtml = 
            '<div class="modal-overlay active" id="warningsModal">' +
                '<div class="modal-content" style="max-width: 600px;">' +
                    '<div class="flex justify-between items-center mb-4">' +
                        '<div>' +
                            '<h2 class="text-xl font-bold">Warnings for ' + safeUsername + '</h2>' +
                            '<div class="flex space-x-4 text-sm text-gray-300 mt-1">' +
                                '<span>Total: ' + warnings.length + '</span>' +
                                '<span class="text-yellow-400">Active: ' + activeWarnings.length + '</span>' +
                                '<span class="text-green-400">Dismissed: ' + dismissedWarnings.length + '</span>' +
                            '</div>' +
                        '</div>' +
                        '<button onclick="closeModal(\'warningsModal\')" class="p-1 rounded-full hover:bg-purple-700">' +
                            '<i data-feather="x" class="w-5 h-5"></i>' +
                        '</button>' +
                    '</div>' +
                    '<div class="flex space-x-2 mb-4">' +
                        bulkActionsHTML +
                    '</div>' +
                    '<div class="max-h-64 overflow-y-auto">' +
                        warningsHTML +
                    '</div>' +
                    '<button onclick="closeModal(\'warningsModal\')" class="bg-purple-600 hover:bg-purple-700 text-white py-2 px-6 rounded-lg font-medium w-full mt-4">Close</button>' +
                '</div>' +
            '</div>';
        
        // Add modal to page if it doesn't exist
        if (!document.getElementById('warningsModal')) {
            const modalContainer = document.createElement('div');
            modalContainer.innerHTML = modalHtml;
            document.body.appendChild(modalContainer);
            feather.replace();
        } else {
            document.getElementById('warningsModal').innerHTML = modalHtml;
            document.getElementById('warningsModal').classList.add('active');
            feather.replace();
        }
    }
    
    // Delete a specific warning permanently
    async function deleteWarning(username, warningId) {
        if (!confirm('Permanently delete this warning for ' + username + '?\n\nThis action cannot be undone!')) {
            return;
        }
        
        try {
            const token = getCookie('AuthToken');
            const response = await fetch(`${SERVER_URL}/api/admin/warnings/${warningId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ username })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Failed to delete warning');
            }
            
            const result = await response.json();
            alert('✅ ' + result.message);
            // Refresh the warnings view
            viewUserWarnings(username);
            
        } catch (error) {
            console.error('Delete warning error:', error);
            alert('❌ Error: ' + error.message);
        }
    }

    // Delete all warnings for a user
    async function deleteAllWarnings(username, warningCount) {
        if (!confirm('Delete ALL warnings for ' + username + '?\n\nThis will permanently remove ' + warningCount + ' warning(s) and cannot be undone!')) {
            return;
        }
        
        try {
            const token = getCookie('AuthToken');
            const response = await fetch(`${SERVER_URL}/api/admin/warnings/user/${encodeURIComponent(username)}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Failed to delete warnings');
            }
            
            const result = await response.json();
            alert('✅ ' + result.message);
            // Refresh the warnings view
            viewUserWarnings(username);
            
        } catch (error) {
            console.error('Delete all warnings error:', error);
            alert('❌ Error: ' + error.message);
        }
    }

    // Delete only dismissed warnings for a user
    async function deleteDismissedWarnings(username, dismissedCount) {
        if (!confirm('Delete all DISMISSED warnings for ' + username + '?\n\nThis will permanently remove ' + dismissedCount + ' dismissed warning(s) but keep active ones.')) {
            return;
        }
        
        try {
            const token = getCookie('AuthToken');
            const response = await fetch(`${SERVER_URL}/api/admin/warnings/user/${encodeURIComponent(username)}/dismissed`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Failed to delete dismissed warnings');
            }
            
            const result = await response.json();
            alert('✅ ' + result.message);
            // Refresh the warnings view
            viewUserWarnings(username);
            
        } catch (error) {
            console.error('Delete dismissed warnings error:', error);
            alert('❌ Error: ' + error.message);
        }
    }
    
    async function dismissWarning(username, warningId) {
        if (!confirm('Dismiss this warning for ' + username + '?')) {
            return;
        }
        
        try {
            const token = getCookie('AuthToken');
            const response = await fetch(`${SERVER_URL}/api/admin/warnings/${warningId}/dismiss`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ username })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Failed to dismiss warning');
            }
            
            alert('Warning dismissed successfully');
            // Refresh the warnings view
            viewUserWarnings(username);
            
        } catch (error) {
            console.error('Dismiss warning error:', error);
            alert('Error: ' + error.message);
        }
    }

    // Show remote delete confirmation modal
    function showRemoteDeleteModal(username, userRole) {
        document.getElementById('deleteUsernameDisplay').textContent = username;
        document.getElementById('deleteUserRole').textContent = 'Role: ' + userRole;
        document.getElementById('adminPassword').value = '';
        openModal('remoteDeleteModal');
    }

    // Confirm and execute remote deletion
    async function confirmRemoteDelete() {
        const username = document.getElementById('deleteUsernameDisplay').textContent;
        const password = document.getElementById('adminPassword').value.trim();
        
        if (!password) {
            alert('Please enter your password to confirm deletion');
            return;
        }
        
        try {
            const token = getCookie('AuthToken');
            const response = await fetch(`${SERVER_URL}/api/admin/users/${encodeURIComponent(username)}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ password })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Failed to delete user');
            }
            
            const result = await response.json();
            alert('✅ ' + result.message);
            closeModal('remoteDeleteModal');
            
            // Reload users list
            loadUsersList();
            
        } catch (error) {
            console.error('Delete user error:', error);
            alert('❌ Error: ' + error.message);
        }
    }

    // Role Management Functions
    // Load available roles
    async function loadAvailableRoles() {
        try {
            const token = getCookie('AuthToken');
            const response = await fetch(`${SERVER_URL}/api/admin/roles`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Failed to load roles');
            }
            
            const data = await response.json();
            return data.roles;
        } catch (error) {
            console.error('Load roles error:', error);
            return [];
        }
    }

    // Populate role select with available options
    async function populateRoleSelect() {
        const roles = await loadAvailableRoles();
        const roleSelect = document.getElementById('userRole');
        
        // Clear existing options except the first one
        while (roleSelect.options.length > 1) {
            roleSelect.remove(1);
        }
        
        // Add available roles
        roles.forEach(role => {
            const option = document.createElement('option');
            option.value = role.value;
            option.textContent = `${role.label} - ${role.description}`;
            roleSelect.appendChild(option);
        });
    }

    // Update role help text based on selection
    function updateRoleHelp() {
        const roleSelect = document.getElementById('userRole');
        const roleHelp = document.getElementById('roleHelp');
        const selectedRole = roleSelect.value;
        
        const helpTexts = {
            'Member': 'Regular user with basic access permissions.',
            'Moderator': 'Can manage warnings, reports, and user messages.',
            'Admin': 'Full administrative access including blacklisting and role management (except Owner).',
            'Owner': 'Full system control including Owner management. Use with extreme caution.'
        };
        
        if (selectedRole && helpTexts[selectedRole]) {
            roleHelp.textContent = helpTexts[selectedRole];
            roleHelp.classList.remove('hidden');
        } else {
            roleHelp.classList.add('hidden');
        }
    }

    // Assign role to user
    async function assignRole(username, role) {
        try {
            const token = getCookie('AuthToken');
            const response = await fetch(`${SERVER_URL}/api/admin/users/${encodeURIComponent(username)}/role`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ role })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Failed to assign role');
            }
            
            const result = await response.json();
            return result;
            
        } catch (error) {
            console.error('Assign role error:', error);
            throw error;
        }
    }

    // Handle role form submission
    document.getElementById('roleForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const username = document.getElementById('roleUsername').value.trim();
        const role = document.getElementById('userRole').value;
        
        if (!username) {
            alert('Please enter a username');
            return;
        }
        
        if (!role) {
            alert('Please select a role');
            return;
        }
        
        if (!confirm(`Are you sure you want to assign the role "${role}" to user "${username}"?`)) {
            return;
        }
        
        try {
            const result = await assignRole(username, role);
            alert(`✅ ${result.message}\n\nUser: ${result.user.username}\nOld Role: ${result.user.oldRole}\nNew Role: ${result.user.newRole}`);
            
            // Reset form
            this.reset();
            document.getElementById('roleHelp').classList.add('hidden');
            
            // Reload users list to reflect changes
            loadUsersList();
            
        } catch (error) {
            console.error('Role assignment error:', error);
            alert(`❌ Error: ${error.message}`);
        }
    });

    // Check authentication status on page load - SIMPLIFIED VERSION
    document.addEventListener('DOMContentLoaded', async function() {
        const token = getCookie('AuthToken');
        
        if (!token) {
            showLoginModal();
            return;
        }

        // Show loading overlay while verifying token
        document.getElementById('loadingOverlay').classList.remove('hidden');
        
        try {
            // Get user info first to check permissions
            const userInfo = await getUserInfo(token);
            
            // Check if user has admin permissions
            if (userInfo.role !== "Owner" && userInfo.role !== "Admin") {
                alert("Insufficient permissions. Only admins can access this page.");
                window.location.href = "https://senturyhanderserson.github.io/SigmiForCCGS/";
                return;
            }
            
            // Set global user variables
            currentUser = userInfo.username;
            currentUserRole = userInfo.role;
            
            // Store user info in localStorage for persistence
            localStorage.setItem('currentUser', userInfo.username);
            localStorage.setItem('currentUserRole', userInfo.role);
            
            // Show user info
            document.getElementById('userInfo').classList.remove('hidden');
            document.getElementById('userUsername').textContent = userInfo.username;
            document.getElementById('userRole').textContent = userInfo.role;
            
            // Load available roles and populate select
            await populateRoleSelect();
            
            // Load users list
            loadUsersList();
            
            // Hide login modal if it was showing
            document.getElementById('loginModal').classList.remove('active');
            
        } catch (error) {
            console.error('Authentication error:', error);
            showLoginModal();
        } finally {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }
    });

    // Show login modal function
    function showLoginModal() {
        document.getElementById('loginModal').classList.add('active');
    }

    // Redirect to login page
    function redirectToLogin() {
        window.location.href = 'https://senturyhanderserson.github.io/SigmiForCCGS/';
    }

    // Load users list with proper escaping
    async function loadUsersList() {
        try {
            const token = getCookie('AuthToken');
            const response = await fetch(`${SERVER_URL}/api/users`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
            
            if (!response.ok) {
                throw new Error('Failed to load users');
            }
            
            const users = await response.json();
            
            // Store users for use in the specific message modal
            localStorage.setItem('allUsers', JSON.stringify(users));
            
            const container = document.getElementById('usersList');
            
            if (users.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-center py-4">No users found</p>';
                return;
            }
            
            // Use string concatenation with proper escaping
            let usersHTML = '';
            users.forEach(user => {
                const canDelete = user.username !== currentUser && 
                    (currentUserRole === 'Owner' || 
                     (currentUserRole === 'Admin' && user.role !== 'Owner' && user.role !== 'Admin'));
                
                // Escape all dynamic values
                const safeUsername = escapeHtml(user.username);
                const safeRole = escapeHtml(user.role);
                const safeJoined = escapeHtml(user.joined);
                const safeBlacklistReason = user.blacklistReason ? escapeHtml(user.blacklistReason) : '';
                
                const deleteButton = canDelete ? 
                    '<button onclick="showRemoteDeleteModal(\'' + safeUsername + '\', \'' + safeRole + '\')" class="p-2 bg-red-600 hover:bg-red-700 rounded-lg" title="Delete Account"><i data-feather="trash-2" class="w-4 h-4"></i></button>' : '';
                
                const blacklistButton = user.blacklisted ? 
                    '<button onclick="unblacklistUser(\'' + safeUsername + '\')" class="p-2 bg-green-600 hover:bg-green-700 rounded-lg"><i data-feather="check-circle" class="w-4 h-4"></i></button>' :
                    '<button onclick="showBlacklistForm(\'' + safeUsername + '\')" class="p-2 bg-red-600 hover:bg-red-700 rounded-lg"><i data-feather="x-circle" class="w-4 h-4"></i></button>';
                
                const roleBadges = 
                    (user.role === 'Owner' ? '<span class="user-status-badge bg-purple-600">Owner</span>' : '') +
                    (user.role === 'Admin' ? '<span class="user-status-badge bg-blue-600">Admin</span>' : '') +
                    (user.role === 'Moderator' ? '<span class="user-status-badge bg-green-600">Moderator</span>' : '') +
                    (user.role === 'Member' ? '<span class="user-status-badge bg-gray-600">Member</span>' : '');
                
                const blacklistInfo = user.blacklisted ? '• Reason: ' + safeBlacklistReason : '';
                
                usersHTML += 
                    '<div class="glassmorphism p-4 rounded-lg flex justify-between items-center">' +
                        '<div>' +
                            '<div class="flex items-center space-x-2">' +
                                '<span class="font-medium">' + safeUsername + '</span>' +
                                '<span class="user-status-badge ' + (user.blacklisted ? 'status-blacklisted' : 'status-clean') + '">' +
                                    (user.blacklisted ? 'Blacklisted' : 'Clean') +
                                '</span>' +
                                roleBadges +
                            '</div>' +
                            '<div class="text-sm text-gray-300">' +
                                'Role: ' + safeRole + ' • Joined: ' + safeJoined + ' ' + blacklistInfo +
                            '</div>' +
                        '</div>' +
                        '<div class="flex space-x-2">' +
                            '<button onclick="viewUserWarnings(\'' + safeUsername + '\')" class="p-2 bg-yellow-600 hover:bg-yellow-700 rounded-lg" title="View Warnings"><i data-feather="alert-triangle" class="w-4 h-4"></i></button>' +
                            deleteButton +
                            blacklistButton +
                        '</div>' +
                    '</div>';
            });
            
            container.innerHTML = usersHTML;
            feather.replace();
            
        } catch (error) {
            console.error('Failed to load users:', error);
            document.getElementById('usersList').innerHTML = '<p class="text-red-300 text-center py-4">Error loading users: ' + error.message + '</p>';
        }
    }

    // Show blacklist form with pre-filled username
    function showBlacklistForm(username) {
        document.getElementById('username').value = username;
        document.getElementById('reason').focus();
    }

    // Blacklist user
    async function blacklistUser(username, reason) {
        try {
            const token = getCookie('AuthToken');
            const response = await fetch(`${SERVER_URL}/api/blacklist/${encodeURIComponent(username)}`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ reason })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Failed to blacklist user');
            }
            
            const result = await response.json();
            alert('User ' + username + ' has been blacklisted: ' + result.blacklistReason);
            
            // Reload users list
            loadUsersList();
            
        } catch (error) {
            console.error('Blacklist error:', error);
            alert('Error: ' + error.message);
        }
    }

    // Unblacklist user
    async function unblacklistUser(username) {
        if (!confirm('Are you sure you want to unblacklist ' + username + '?')) {
            return;
        }
        
        try {
            const token = getCookie('AuthToken');
            const response = await fetch(`${SERVER_URL}/api/unblacklist/${encodeURIComponent(username)}`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Failed to unblacklist user');
            }
            
            alert('User ' + username + ' has been unblacklisted');
            
            // Reload users list
            loadUsersList();
            
        } catch (error) {
            console.error('Unblacklist error:', error);
            alert('Error: ' + error.message);
        }
    }

    // Handle blacklist form submission
    document.getElementById('blacklistForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const username = document.getElementById('username').value.trim();
        const reason = document.getElementById('reason').value.trim();
        
        if (!username) {
            alert('Please enter a username');
            return;
        }
        
        if (!reason) {
            alert('Please enter a reason for blacklisting');
            return;
        }
        
        blacklistUser(username, reason);
        
        // Reset form
        this.reset();
    });

    // Refresh users list
    document.getElementById('refreshUsers').addEventListener('click', function() {
        loadUsersList();
    });

    // Logout button
    document.getElementById('logoutButton').addEventListener('click', function() {
        // Clear auth data
        document.cookie = 'AuthToken=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
        localStorage.removeItem('currentUser');
        localStorage.removeItem('currentUserRole');
        localStorage.removeItem('allUsers');
        
        // Redirect to login
        window.location.href = 'https://senturyhanderserson.github.io/SigmiForCCGS/';
    });

    // Add event listener for role select change
    document.getElementById('userRole').addEventListener('change', updateRoleHelp);

    // Cookie Functions
    function getCookie(name) {
        const cookieName = name + "=";
        const decodedCookie = decodeURIComponent(document.cookie);
        const cookieArray = decodedCookie.split(';');
        
        for(let i = 0; i < cookieArray.length; i++) {
            let cookie = cookieArray[i];
            while (cookie.charAt(0) === ' ') {
                cookie = cookie.substring(1);
            }
            if (cookie.indexOf(cookieName) === 0) {
                return cookie.substring(cookieName.length, cookie.length);
            }
        }
        return "";
    }
</script>
</body>
</html>
