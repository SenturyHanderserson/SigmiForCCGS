<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tuffest Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <style>
        .glassmorphism {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .gradient-bg {
            background: linear-gradient(135deg, #6e45e2 0%, #88d3ce 100%);
        }
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #fff;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .login-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        .login-content {
            background: linear-gradient(135deg, #6e3b9c 0%, #3b1d6c 50%, #1a0933 100%);
            border-radius: 16px;
            padding: 2rem;
            max-width: 400px;
            width: 90%;
            text-align: center;
        }
        .medal-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 1rem;
            background: linear-gradient(135deg, #FFD700 0%, #DAA520 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }
        .user-status-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .status-blacklisted {
            background-color: #ef4444;
            color: white;
        }
        .status-clean {
            background-color: #10b981;
            color: white;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background: linear-gradient(135deg, #6e3b9c 0%, #3b1d6c 50%, #1a0933 100%);
            border-radius: 16px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }
        
        .modal-overlay.active .modal-content {
            transform: scale(1);
        }
        
        .user-checkbox {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            border-radius: 0.5rem;
            margin-bottom: 0.25rem;
            transition: background-color 0.2s;
        }
        
        .user-checkbox:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        .status-warned {
            background-color: #f59e0b;
            color: white;
        }
        
        .warnings-badge {
            display: inline-flex;
            align-items: center;
            background-color: #f59e0b;
            color: white;
            border-radius: 9999px;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }
        .hidden {
            display: none !important;
        }
        .role-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
            color: white;
        }
        .role-badge:hover {
            transform: scale(1.05);
            border-color: rgba(255, 255, 255, 0.3);
        }
        .role-badge.owner-protected {
            cursor: not-allowed;
            opacity: 0.8;
        }
        .role-badge.owner-protected:hover {
            transform: none;
            border-color: transparent;
        }
        .user-card {
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        .user-card:hover {
            border-color: rgba(139, 92, 246, 0.3);
            transform: translateY(-2px);
        }
        .non-interactive {
            pointer-events: none;
            opacity: 0.6;
        }
        
        /* Role Management Styles */
        .role-color-preview {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid white;
            display: inline-block;
            margin-right: 8px;
        }
        
        .color-preset {
            transition: transform 0.2s ease;
        }
        
        .color-preset:hover {
            transform: scale(1.2);
        }
        
        .role-management-item {
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }
        
        .role-management-item:hover {
            border-left-color: rgba(139, 92, 246, 0.5);
            transform: translateX(4px);
        }
        
        /* Color Picker Styles */
        input[type="color"] {
            -webkit-appearance: none;
            appearance: none;
            border: none;
        }
        
        input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
        }
        
        input[type="color"]::-webkit-color-swatch {
            border: none;
            border-radius: 8px;
        }
        
        /* Dynamic role color classes will be generated by JavaScript */
        
        /* Z-index fixes for modals */
        #roleCreationModal {
            z-index: 2100 !important;
        }
        
        #roleManagementModal {
            z-index: 2000 !important;
        }
        
        /* Cosmetic role badge */
        .cosmetic-badge {
            background-color: #8b5cf6;
            color: white;
        }
        
        .cosmetic-role {
            border-left: 4px solid #8b5cf6;
        }

        /* Moderator cooldown styles */
        .cooldown-indicator {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.5);
            border-radius: 8px;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        .cooldown-active {
            color: #ef4444;
        }
        
        .cooldown-available {
            color: #10b981;
        }
        
        .limit-info {
            background: rgba(59, 130, 246, 0.2);
            border: 1px solid rgba(59, 130, 246, 0.5);
            border-radius: 8px;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        .action-disabled {
            opacity: 0.5;
            pointer-events: none;
        }
        
        .cooldown-timer {
            font-weight: bold;
            font-size: 0.9rem;
        }
    </style>
</head>
<body class="min-h-screen gradient-bg text-white font-sans">
    <!-- Login Modal -->
    <div id="loginModal" class="login-modal hidden">
        <div class="login-content">
            <div class="medal-icon">
                <i data-feather="award" class="w-10 h-10 text-white"></i>
            </div>
            <h2 class="text-2xl font-bold mb-4">Authentication Required</h2>
            <p class="text-gray-300 mb-6">You need to be logged in to access the admin management system.</p>
            <button onclick="redirectToLogin()" class="bg-purple-600 hover:bg-purple-700 py-3 px-6 rounded-lg font-medium w-full mb-4">
                Sign In
            </button>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50">
        <div class="glassmorphism rounded-xl p-8 max-w-md w-full mx-4 text-center">
            <div class="loading-spinner mb-4"></div>
            <h2 class="text-2xl font-bold mb-2">Verifying session...</h2>
            <p class="text-gray-300">Please wait while we verify your permissions</p>
        </div>
    </div>

    <!-- Role Creation Modal with RGB Picker - HIGHER Z-INDEX -->
    <div id="roleCreationModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 600px;">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Create New Role</h2>
                <button onclick="closeModal('roleCreationModal')" class="p-1 rounded-full hover:bg-purple-700">
                    <i data-feather="x" class="w-5 h-5"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label for="newRoleName" class="block text-gray-300 mb-2">Role Name</label>
                    <input type="text" id="newRoleName" 
                           class="w-full bg-gray-800 bg-opacity-50 border border-gray-700 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500" 
                           placeholder="Enter role name (e.g., Moderator, VIP)">
                    <p class="text-xs text-gray-400 mt-1">Use descriptive names without spaces</p>
                </div>
                
                <div>
                    <label for="roleDescription" class="block text-gray-300 mb-2">Description</label>
                    <input type="text" id="roleDescription" 
                           class="w-full bg-gray-800 bg-opacity-50 border border-gray-700 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500" 
                           placeholder="Enter role description">
                </div>
                
                <div>
                    <label class="block text-gray-300 mb-2">Role Color</label>
                    <div class="flex items-center space-x-4">
                        <div class="flex-1">
                            <input type="color" id="roleColorPicker" 
                                   class="w-full h-12 cursor-pointer bg-transparent border-0 rounded-lg"
                                   value="#6b7280">
                        </div>
                        <div class="w-20">
                            <input type="text" id="roleColorHex" 
                                   class="w-full bg-gray-800 bg-opacity-50 border border-gray-700 rounded-lg px-3 py-2 text-center font-mono text-sm"
                                   placeholder="#RRGGBB" maxlength="7">
                        </div>
                    </div>
                    <div class="mt-2 flex space-x-2">
                        <button onclick="setRandomColor()" class="bg-gray-600 hover:bg-gray-700 text-white py-1 px-3 rounded text-sm">
                            Random
                        </button>
                        <button onclick="setDefaultColors()" class="bg-gray-600 hover:bg-gray-700 text-white py-1 px-3 rounded text-sm">
                            Presets
                        </button>
                    </div>
                    <div id="colorPresets" class="hidden mt-2 grid grid-cols-8 gap-1">
                        <!-- Color presets will be populated here -->
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="roleWeight" class="block text-gray-300 mb-2">Weight (Priority)</label>
                        <input type="number" id="roleWeight" min="1" max="100" value="2"
                               class="w-full bg-gray-800 bg-opacity-50 border border-gray-700 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                        <p class="text-xs text-gray-400 mt-1">Higher number = higher privilege</p>
                    </div>
                    
                    <div>
                        <label for="rolePermissions" class="block text-gray-300 mb-2">Base Permissions</label>
                        <select id="rolePermissions" 
                                class="w-full bg-gray-800 bg-opacity-50 border border-gray-700 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                            <option value="basic">Basic Access</option>
                            <option value="moderator">Moderator</option>
                            <option value="admin">Admin (Limited)</option>
                            <option value="full">Full Access</option>
                        </select>
                    </div>
                </div>
                
                <!-- COSMETIC ROLE OPTION -->
                <div class="mb-4">
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" id="roleCosmetic" class="rounded border-gray-700 bg-gray-800 text-purple-500 focus:ring-purple-500">
                        <span class="text-gray-300">Cosmetic Role</span>
                    </label>
                    <p class="text-xs text-gray-400 mt-1">
                        Cosmetic roles can only be assigned by roles with weight 60 or higher
                    </p>
                </div>
                
                <div id="roleCreationHelp" class="p-3 bg-blue-900 bg-opacity-30 border border-blue-700 rounded-lg text-sm text-blue-200">
                    <i data-feather="info" class="w-4 h-4 inline mr-2"></i>
                    <span>New roles will be available for assignment immediately after creation.</span>
                </div>
                
                <div class="flex space-x-2 pt-2">
                    <button onclick="closeModal('roleCreationModal')" 
                            class="bg-gray-600 hover:bg-gray-700 text-white py-2 px-4 rounded-lg font-medium flex-1">
                        Cancel
                    </button>
                    <button onclick="createNewRole()" 
                            class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg font-medium flex-1">
                        Create Role
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Role Management Modal - LOWER Z-INDEX -->
    <div id="roleManagementModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 700px;">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Role Management</h2>
                <button onclick="closeModal('roleManagementModal')" class="p-1 rounded-full hover:bg-purple-700">
                    <i data-feather="x" class="w-5 h-5"></i>
                </button>
            </div>
            
            <div class="mb-4 flex space-x-2">
                <button onclick="openModal('roleCreationModal')" 
                        class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg font-medium">
                    <i data-feather="plus" class="w-4 h-4 inline mr-2"></i>
                    Create New Role
                </button>
                <button onclick="refreshRoleList()" 
                        class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg font-medium">
                    <i data-feather="refresh-cw" class="w-4 h-4 inline mr-2"></i>
                    Refresh
                </button>
            </div>
            
            <div id="rolesList" class="space-y-3 max-h-96 overflow-y-auto">
                <!-- Roles will be populated here -->
            </div>
            
            <div class="flex space-x-2 pt-4">
                <button onclick="closeModal('roleManagementModal')" 
                        class="bg-gray-600 hover:bg-gray-700 text-white py-2 px-4 rounded-lg font-medium flex-1">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Other Modals -->
    <div id="broadcastModal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Broadcast Message</h2>
                <button onclick="closeModal('broadcastModal')" class="p-1 rounded-full hover:bg-purple-700">
                    <i data-feather="x" class="w-5 h-5"></i>
                </button>
            </div>
            
            <!-- Moderator cooldown info -->
            <div id="broadcastCooldownInfo" class="hidden">
                <!-- Will be populated with cooldown info for moderators -->
            </div>
            
            <div class="mb-4">
                <label class="block text-gray-300 mb-2">Send As</label>
                <div class="flex space-x-4">
                    <label class="flex items-center">
                        <input type="radio" name="broadcastSenderType" value="user" checked class="mr-2">
                        <span>My Account</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="broadcastSenderType" value="system" class="mr-2">
                        <span>System</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="broadcastSenderType" value="anonymous" class="mr-2">
                        <span>Anonymous</span>
                    </label>
                </div>
            </div>
            
            <div class="mb-4">
                <label for="broadcastMessage" class="block text-gray-300 mb-2">Message</label>
                <textarea id="broadcastMessage" class="w-full bg-gray-800 bg-opacity-50 border border-gray-700 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500" rows="4" placeholder="Enter message to broadcast to all users"></textarea>
            </div>
            
            <div class="mb-4">
                <label for="broadcastDuration" class="block text-gray-300 mb-2">Duration (hours)</label>
                <select id="broadcastDuration" class="w-full bg-gray-800 bg-opacity-50 border border-gray-700 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                    <option value="1">1 hour</option>
                    <option value="6">6 hours</option>
                    <option value="24" selected>24 hours</option>
                    <option value="72">72 hours</option>
                    <option value="168">1 week</option>
                </select>
            </div>
            
            <button onclick="sendBroadcast()" class="bg-purple-600 hover:bg-purple-700 text-white py-2 px-6 rounded-lg font-medium w-full" id="sendBroadcastBtn">
                Send Broadcast
            </button>
        </div>
    </div>

    <div id="specificMessageModal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Send Specific Message</h2>
                <button onclick="closeModal('specificMessageModal')" class="p-1 rounded-full hover:bg-purple-700">
                    <i data-feather="x" class="w-5 h-5"></i>
                </button>
            </div>
            
            <!-- Moderator cooldown and limit info -->
            <div id="messageCooldownInfo" class="hidden">
                <!-- Will be populated with cooldown info for moderators -->
            </div>
            
            <div class="mb-4">
                <label class="block text-gray-300 mb-2">Send As</label>
                <div class="flex space-x-4">
                    <label class="flex items-center">
                        <input type="radio" name="senderType" value="user" checked class="mr-2">
                        <span>My Account</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="senderType" value="system" class="mr-2">
                        <span>System</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="senderType" value="anonymous" class="mr-2">
                        <span>Anonymous</span>
                    </label>
                </div>
            </div>
            
            <div class="mb-4">
                <label for="specificMessage" class="block text-gray-300 mb-2">Message</label>
                <textarea id="specificMessage" class="w-full bg-gray-800 bg-opacity-50 border border-gray-700 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500" rows="4" placeholder="Enter message to send to selected users"></textarea>
            </div>
            
            <div class="mb-4">
                <label class="block text-gray-300 mb-2">Select Recipients</label>
                <div class="max-h-48 overflow-y-auto bg-gray-800 bg-opacity-50 rounded-lg p-2" id="recipientsList">
                    <!-- Users will be populated here -->
                </div>
            </div>
            
            <div class="flex space-x-2 mb-4">
                <button onclick="selectAllUsers()" class="bg-gray-600 hover:bg-gray-700 text-white py-2 px-4 rounded-lg font-medium flex-1">
                    Select All
                </button>
                <button onclick="deselectAllUsers()" class="bg-gray-600 hover:bg-gray-700 text-white py-2 px-4 rounded-lg font-medium flex-1">
                    Deselect All
                </button>
            </div>
            
            <button onclick="sendSpecificMessage()" class="bg-purple-600 hover:bg-purple-700 text-white py-2 px-6 rounded-lg font-medium w-full" id="sendMessageBtn">
                Send Message
            </button>
        </div>
    </div>

    <div id="warnModal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Warn User</h2>
                <button onclick="closeModal('warnModal')" class="p-1 rounded-full hover:bg-purple-700">
                    <i data-feather="x" class="w-5 h-5"></i>
                </button>
            </div>
            
            <!-- Moderator cooldown info -->
            <div id="warnCooldownInfo" class="hidden">
                <!-- Will be populated with cooldown info for moderators -->
            </div>
            
            <div class="mb-4">
                <label class="block text-gray-300 mb-2">Send As</label>
                <div class="flex space-x-4">
                    <label class="flex items-center">
                        <input type="radio" name="warnSenderType" value="user" checked class="mr-2">
                        <span>My Account</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="warnSenderType" value="system" class="mr-2">
                        <span>System</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="warnSenderType" value="anonymous" class="mr-2">
                        <span>Anonymous</span>
                    </label>
                </div>
            </div>
            
            <div class="mb-4">
                <label for="warnUsername" class="block text-gray-300 mb-2">Username</label>
                <input type="text" id="warnUsername" class="w-full bg-gray-800 bg-opacity-50 border border-gray-700 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="Enter username to warn">
            </div>
            <div class="mb-4">
                <label for="warnMessage" class="block text-gray-300 mb-2">Warning Message</label>
                <textarea id="warnMessage" class="w-full bg-gray-800 bg-opacity-50 border border-gray-700 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500" rows="4" placeholder="Enter warning message"></textarea>
            </div>
            <button onclick="sendWarning()" class="bg-red-600 hover:bg-red-700 text-white py-2 px-6 rounded-lg font-medium w-full" id="sendWarnBtn">
                Send Warning
            </button>
        </div>
    </div>

    <!-- Remote Delete Modal -->
    <div id="remoteDeleteModal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Delete User Account</h2>
                <button onclick="closeModal('remoteDeleteModal')" class="p-1 rounded-full hover:bg-purple-700">
                    <i data-feather="x" class="w-5 h-5"></i>
                </button>
            </div>
            
            <div class="mb-4">
                <p class="text-gray-300 mb-2">You are about to delete the account of:</p>
                <p id="deleteUsernameDisplay" class="font-bold text-lg text-red-400"></p>
                <p id="deleteUserRole" class="text-sm text-gray-400"></p>
            </div>
            
            <div class="mb-4 p-3 bg-red-900 bg-opacity-30 border border-red-700 rounded-lg">
                <div class="flex items-center">
                    <i data-feather="alert-triangle" class="w-5 h-5 text-red-400 mr-2"></i>
                    <span class="text-red-300 font-medium">Warning: This action cannot be undone!</span>
                </div>
                <p class="text-sm text-red-200 mt-1">
                    All user data, warnings, and keys will be permanently deleted.
                </p>
            </div>
            
            <div class="mb-4">
                <label for="adminPassword" class="block text-gray-300 mb-2">
                    Confirm Your Password
                </label>
                <input type="password" id="adminPassword" 
                       class="w-full bg-gray-800 bg-opacity-50 border border-gray-700 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500" 
                       placeholder="Enter your password to confirm">
                <p class="text-xs text-gray-400 mt-1">
                    For security, please re-enter your password to confirm this action.
                </p>
            </div>
            
            <div class="flex space-x-2">
                <button onclick="closeModal('remoteDeleteModal')" 
                        class="bg-gray-600 hover:bg-gray-700 text-white py-2 px-4 rounded-lg font-medium flex-1">
                    Cancel
                </button>
                <button onclick="confirmRemoteDelete()" 
                        class="bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-lg font-medium flex-1">
                    Delete Account
                </button>
            </div>
        </div>
    </div>

    <!-- Role Assignment Modal -->
    <div id="roleAssignmentModal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Assign Role</h2>
                <button onclick="closeModal('roleAssignmentModal')" class="p-1 rounded-full hover:bg-purple-700">
                    <i data-feather="x" class="w-5 h-5"></i>
                </button>
            </div>
            
            <div class="mb-4">
                <p class="text-gray-300 mb-2">Assign role to user:</p>
                <p id="roleUsernameDisplay" class="font-bold text-lg text-purple-300"></p>
                <p id="currentUserRole" class="text-sm text-gray-400"></p>
            </div>
            
            <div class="mb-4">
                <label for="roleSelect" class="block text-gray-300 mb-2">Select New Role</label>
                <select id="roleSelect" class="w-full bg-gray-800 bg-opacity-50 border border-gray-700 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                    <option value="">Loading roles...</option>
                </select>
                <div id="roleHelp" class="text-sm text-gray-400 mt-2 hidden"></div>
            </div>
            
            <div class="flex space-x-2">
                <button onclick="closeModal('roleAssignmentModal')" 
                        class="bg-gray-600 hover:bg-gray-700 text-white py-2 px-4 rounded-lg font-medium flex-1">
                    Cancel
                </button>
                <button onclick="confirmRoleAssignment()" 
                        class="bg-purple-600 hover:bg-purple-700 text-white py-2 px-4 rounded-lg font-medium flex-1">
                    Assign Role
                </button>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="relative z-10 min-h-screen flex flex-col hidden non-interactive" id="mainApp">
        <!-- Header -->
        <header class="glassmorphism p-4 shadow-lg">
            <div class="container mx-auto flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <h1 class="text-2xl font-bold">Admin Management</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="refreshCooldowns" class="p-2 rounded-full hover:bg-purple-700 transition" title="Refresh Cooldowns">
                        <i data-feather="refresh-cw"></i>
                    </button>
                    <button id="logoutButton" class="p-2 rounded-full hover:bg-purple-700 transition">
                        <i data-feather="log-out"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 container mx-auto p-4 md:p-6">
            <!-- User Info -->
            <div id="userInfo" class="glassmorphism rounded-xl p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">Your Account</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <p class="text-gray-300">Username</p>
                        <p id="userUsername" class="font-medium"></p>
                    </div>
                    <div>
                        <p class="text-gray-300">Role</p>
                        <p id="userRoleDisplay" class="font-medium"></p>
                    </div>
                </div>
                
                <!-- Moderator Cooldowns Display -->
                <div id="moderatorCooldowns" class="mt-4 hidden">
                    <h3 class="text-lg font-semibold mb-2">Action Cooldowns</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                        <div class="cooldown-indicator">
                            <div class="flex justify-between">
                                <span>Warnings:</span>
                                <span id="warnCooldown" class="cooldown-available">Available</span>
                            </div>
                        </div>
                        <div class="cooldown-indicator">
                            <div class="flex justify-between">
                                <span>Blacklist:</span>
                                <span id="blacklistCooldown" class="cooldown-available">Available</span>
                            </div>
                        </div>
                        <div class="cooldown-indicator">
                            <div class="flex justify-between">
                                <span>Unblacklist:</span>
                                <span id="unblacklistCooldown" class="cooldown-available">Available</span>
                            </div>
                        </div>
                        <div class="cooldown-indicator">
                            <div class="flex justify-between">
                                <span>Bulk Messages:</span>
                                <span id="messageCooldown" class="cooldown-available">Available</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Admin Tools -->
            <div class="glassmorphism rounded-xl p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">Admin Tools</h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <button onclick="openModal('broadcastModal')" class="bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded-lg font-medium flex flex-col items-center justify-center">
                        <i data-feather="megaphone" class="w-8 h-8 mb-2"></i>
                        <span>Broadcast Message</span>
                    </button>
                    <button onclick="openModal('specificMessageModal')" class="bg-green-600 hover:bg-green-700 text-white py-3 px-4 rounded-lg font-medium flex flex-col items-center justify-center">
                        <i data-feather="mail" class="w-8 h-8 mb-2"></i>
                        <span>Specific Message</span>
                    </button>
                    <button onclick="openModal('warnModal')" class="bg-red-600 hover:bg-red-700 text-white py-3 px-4 rounded-lg font-medium flex flex-col items-center justify-center">
                        <i data-feather="alert-triangle" class="w-8 h-8 mb-2"></i>
                        <span>Warn User</span>
                    </button>
                    <button onclick="openModal('roleManagementModal')" class="bg-indigo-600 hover:bg-indigo-700 text-white py-3 px-4 rounded-lg font-medium flex flex-col items-center justify-center">
                        <i data-feather="palette" class="w-8 h-8 mb-2"></i>
                        <span>Manage Roles</span>
                    </button>
                </div>
            </div>

            <!-- Blacklist Form -->
            <div class="glassmorphism rounded-xl p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">Blacklist User</h2>
                
                <!-- Moderator cooldown info for blacklist -->
                <div id="blacklistCooldownInfo" class="hidden mb-4">
                    <!-- Will be populated with cooldown info for moderators -->
                </div>
                
                <form id="blacklistForm" class="space-y-4">
                    <div>
                        <label for="username" class="block text-gray-300 mb-2">Username</label>
                        <input type="text" id="username" required class="w-full bg-gray-800 bg-opacity-50 border border-gray-700 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                    <div>
                        <label for="reason" class="block text-gray-300 mb-2">Reason</label>
                        <textarea id="reason" required class="w-full bg-gray-800 bg-opacity-50 border border-gray-700 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500" rows="3"></textarea>
                    </div>
                    <button type="submit" class="bg-red-600 hover:bg-red-700 text-white py-2 px-6 rounded-lg font-medium" id="blacklistBtn">
                        Blacklist User
                    </button>
                </form>
            </div>

            <!-- Users List -->
            <div class="glassmorphism rounded-xl p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-semibold">All Users</h2>
                    <button id="refreshUsers" class="p-2 rounded-full hover:bg-purple-700 transition">
                        <i data-feather="refresh-cw"></i>
                    </button>
                </div>
                <div id="usersList" class="space-y-4">
                    <!-- Users will be loaded here -->
                </div>
            </div>
        </main>
    </div>

<script>
    // Initialize animations and icons
    AOS.init();
    feather.replace();

    // Server URL
    const SERVER_URL = "https://proxyforsigmi.onrender.com";

    // Global variables to track current user info
    let currentUser = '';
    let currentUserRole = '';
    let selectedUserForRole = '';
    let availableRoles = [];
    let isVerified = false;
    let roleColors = {}; // Store role colors from server
    let users = []; // Global users array
    let allRoles = {}; // Store all roles from server
    let moderatorCooldowns = {
        warnings: 0,
        blacklists: 0,
        unblacklists: 0,
        bulkMessages: 0
    };
    let cooldownInterval;

    // Function to escape special characters for HTML attributes
    function escapeHtml(unsafe) {
        return unsafe
            .replace(/'/g, "\\'")
            .replace(/"/g, '\\"')
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;");
    }

    // Function to get user info
    async function getUserInfo(token) {
        try {
            const response = await fetch(`${SERVER_URL}/api/user-info`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
            
            if (!response.ok) {
                throw new Error('Failed to get user info');
            }
            
            return await response.json();
        } catch (error) {
            console.error('Get user info error:', error);
            throw error;
        }
    }

    // Function to load ALL roles from server
    async function loadAllRoles() {
        try {
            const token = getCookie('AuthToken');
            const response = await fetch(`${SERVER_URL}/api/roles`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
            
            if (!response.ok) {
                throw new Error('Failed to load roles');
            }
            
            const data = await response.json();
            allRoles = data.roles || {};
            return allRoles;
        } catch (error) {
            console.error('Load all roles error:', error);
            return {};
        }
    }

    // Function to load available roles for assignment - FIXED VERSION
async function loadAvailableRoles() {
  try {
    const token = getCookie('AuthToken');
    const response = await fetch(`${SERVER_URL}/api/admin/roles/available`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    if (!response.ok) {
      if (response.status === 403) {
        console.warn('No permission to load available roles');
        return [];
      }
      throw new Error('Failed to load available roles');
    }
    
    const data = await response.json();
    const currentUserRoleConfig = allRoles[currentUserRole];
    const currentUserWeight = currentUserRoleConfig?.weight || 0;
    
    // Store assignment limits for UI display
    window.moderatorAssignmentLimits = data.assignmentLimits;
    
    if (data.roles && typeof data.roles === 'object') {
      const rolesArray = Object.entries(data.roles)
        .filter(([roleName, config]) => {
          // Additional client-side filtering for safety
          if (isModerator(currentUserRole)) {
            // Client-side enforcement of weight limits
            if (config.weight >= currentUserWeight) {
              return false;
            }
            // Client-side enforcement of high-privilege role restriction
            if (config.weight >= 50) {
              return false;
            }
          }
          
          if (config.cosmetic && currentUserWeight < 60) {
            return false;
          }
          return true;
        })
        .map(([roleName, config]) => ({
          value: roleName,
          label: roleName,
          description: config.description || `Role: ${roleName}`,
          color: config.color || '#6b7280',
          weight: config.weight || 0,
          cosmetic: config.cosmetic || false
        }));
      
      // Sort by weight for better UX
      return rolesArray.sort((a, b) => a.weight - b.weight);
    }
    
    return data.roles || [];
  } catch (error) {
    console.error('Load roles error:', error);
    return [];
  }
}

    // Function to apply role colors dynamically
    function applyRoleColors(roleConfig) {
        // Clear previous dynamic styles
        const existingStyle = document.getElementById('dynamic-role-styles');
        if (existingStyle) {
            existingStyle.remove();
        }

        // Create new style element
        const style = document.createElement('style');
        style.id = 'dynamic-role-styles';
        
        let css = '';
        
        // Generate CSS for each role
        for (const [roleName, config] of Object.entries(roleConfig)) {
            if (config.color) {
                const normalizedRole = roleName.toLowerCase().replace(/\s+/g, '-');
                css += `
                    .role-${normalizedRole} {
                        background: ${config.color};
                        color: white;
                        border: 1px solid rgba(255, 255, 255, 0.2);
                    }
                `;
                
                // Store color for later use
                roleColors[roleName] = config.color;
            }
        }
        
        style.textContent = css;
        document.head.appendChild(style);
    }

    // Function to get role badge class
    function getRoleBadgeClass(roleName) {
        const normalizedRole = roleName.toLowerCase().replace(/\s+/g, '-');
        return `role-${normalizedRole}`;
    }

    // Function to check if user is moderator
    function isModerator(role) {
        return role === "Moderator";
    }

    // Function to check if user is admin or owner
    function isAdminOrOwner(role) {
        return role === "Admin" || role === "Owner";
    }

    // Function to get moderator cooldowns
    async function getModeratorCooldowns() {
        if (!isModerator(currentUserRole)) return;

        try {
            const token = getCookie('AuthToken');
            const response = await fetch(`${SERVER_URL}/api/moderator/cooldowns`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
            
            if (!response.ok) {
                throw new Error('Failed to get cooldowns');
            }
            
            const data = await response.json();
            moderatorCooldowns = data.cooldowns;
            updateCooldownDisplays();
            return data.cooldowns;
        } catch (error) {
            console.error('Get cooldowns error:', error);
            return moderatorCooldowns;
        }
    }

    // Function to update cooldown displays
    function updateCooldownDisplays() {
        if (!isModerator(currentUserRole)) return;

        // Update main cooldown display
        const warnCooldownEl = document.getElementById('warnCooldown');
        const blacklistCooldownEl = document.getElementById('blacklistCooldown');
        const unblacklistCooldownEl = document.getElementById('unblacklistCooldown');
        const messageCooldownEl = document.getElementById('messageCooldown');

        if (warnCooldownEl) {
            warnCooldownEl.textContent = moderatorCooldowns.warnings > 0 ? 
                `${moderatorCooldowns.warnings}m` : 'Available';
            warnCooldownEl.className = moderatorCooldowns.warnings > 0 ? 
                'cooldown-timer cooldown-active' : 'cooldown-timer cooldown-available';
        }

        if (blacklistCooldownEl) {
            blacklistCooldownEl.textContent = moderatorCooldowns.blacklists > 0 ? 
                `${moderatorCooldowns.blacklists}m` : 'Available';
            blacklistCooldownEl.className = moderatorCooldowns.blacklists > 0 ? 
                'cooldown-timer cooldown-active' : 'cooldown-timer cooldown-available';
        }

        if (unblacklistCooldownEl) {
            unblacklistCooldownEl.textContent = moderatorCooldowns.unblacklists > 0 ? 
                `${moderatorCooldowns.unblacklists}m` : 'Available';
            unblacklistCooldownEl.className = moderatorCooldowns.unblacklists > 0 ? 
                'cooldown-timer cooldown-active' : 'cooldown-timer cooldown-available';
        }

        if (messageCooldownEl) {
            messageCooldownEl.textContent = moderatorCooldowns.bulkMessages > 0 ? 
                `${moderatorCooldowns.bulkMessages}m` : 'Available';
            messageCooldownEl.className = moderatorCooldowns.bulkMessages > 0 ? 
                'cooldown-timer cooldown-active' : 'cooldown-timer cooldown-available';
        }

        // Update modal cooldown displays
        updateModalCooldownDisplays();
    }

    // Function to update modal cooldown displays
    function updateModalCooldownDisplays() {
        // Warn modal
        const warnCooldownInfo = document.getElementById('warnCooldownInfo');
        const sendWarnBtn = document.getElementById('sendWarnBtn');
        
        if (warnCooldownInfo && sendWarnBtn) {
            if (moderatorCooldowns.warnings > 0) {
                warnCooldownInfo.innerHTML = `
                    <div class="cooldown-indicator">
                        <div class="flex items-center">
                            <i data-feather="clock" class="w-4 h-4 mr-2"></i>
                            <span>Warning cooldown: <span class="cooldown-timer cooldown-active">${moderatorCooldowns.warnings} minutes remaining</span></span>
                        </div>
                        <p class="text-xs text-gray-300 mt-1">Moderators can only send warnings every 10 minutes</p>
                    </div>
                `;
                warnCooldownInfo.classList.remove('hidden');
                sendWarnBtn.classList.add('action-disabled');
            } else {
                warnCooldownInfo.innerHTML = `
                    <div class="cooldown-indicator">
                        <div class="flex items-center">
                            <i data-feather="check-circle" class="w-4 h-4 mr-2 text-green-400"></i>
                            <span>Warning action: <span class="cooldown-timer cooldown-available">Available</span></span>
                        </div>
                        <p class="text-xs text-gray-300 mt-1">You can send warnings now</p>
                    </div>
                `;
                warnCooldownInfo.classList.remove('hidden');
                sendWarnBtn.classList.remove('action-disabled');
            }
        }

        // Blacklist form
        const blacklistCooldownInfo = document.getElementById('blacklistCooldownInfo');
        const blacklistBtn = document.getElementById('blacklistBtn');
        
        if (blacklistCooldownInfo && blacklistBtn) {
            if (moderatorCooldowns.blacklists > 0) {
                blacklistCooldownInfo.innerHTML = `
                    <div class="cooldown-indicator">
                        <div class="flex items-center">
                            <i data-feather="clock" class="w-4 h-4 mr-2"></i>
                            <span>Blacklist cooldown: <span class="cooldown-timer cooldown-active">${moderatorCooldowns.blacklists} minutes remaining</span></span>
                        </div>
                        <p class="text-xs text-gray-300 mt-1">Moderators can only blacklist once per day</p>
                    </div>
                `;
                blacklistCooldownInfo.classList.remove('hidden');
                blacklistBtn.classList.add('action-disabled');
            } else {
                blacklistCooldownInfo.innerHTML = `
                    <div class="cooldown-indicator">
                        <div class="flex items-center">
                            <i data-feather="check-circle" class="w-4 h-4 mr-2 text-green-400"></i>
                            <span>Blacklist action: <span class="cooldown-timer cooldown-available">Available</span></span>
                        </div>
                        <p class="text-xs text-gray-300 mt-1">You can blacklist users now</p>
                    </div>
                `;
                blacklistCooldownInfo.classList.remove('hidden');
                blacklistBtn.classList.remove('action-disabled');
            }
        }

        // Message modal
        const messageCooldownInfo = document.getElementById('messageCooldownInfo');
        const sendMessageBtn = document.getElementById('sendMessageBtn');
        
        if (messageCooldownInfo && sendMessageBtn) {
            if (moderatorCooldowns.bulkMessages > 0) {
                messageCooldownInfo.innerHTML = `
                    <div class="cooldown-indicator">
                        <div class="flex items-center">
                            <i data-feather="clock" class="w-4 h-4 mr-2"></i>
                            <span>Message cooldown: <span class="cooldown-timer cooldown-active">${moderatorCooldowns.bulkMessages} minutes remaining</span></span>
                        </div>
                        <p class="text-xs text-gray-300 mt-1">Moderators can only send bulk messages every 5 minutes</p>
                    </div>
                `;
                messageCooldownInfo.classList.remove('hidden');
                sendMessageBtn.classList.add('action-disabled');
            } else {
                messageCooldownInfo.innerHTML = `
                    <div class="limit-info">
                        <div class="flex items-center">
                            <i data-feather="check-circle" class="w-4 h-4 mr-2 text-green-400"></i>
                            <span>Message action: <span class="cooldown-timer cooldown-available">Available</span></span>
                        </div>
                        <p class="text-xs text-gray-300 mt-1">Moderators can send messages to up to 5 users at once</p>
                    </div>
                `;
                messageCooldownInfo.classList.remove('hidden');
                sendMessageBtn.classList.remove('action-disabled');
            }
        }

        // Broadcast modal
        const broadcastCooldownInfo = document.getElementById('broadcastCooldownInfo');
        const sendBroadcastBtn = document.getElementById('sendBroadcastBtn');
        
        if (broadcastCooldownInfo && sendBroadcastBtn) {
            if (isModerator(currentUserRole)) {
                broadcastCooldownInfo.innerHTML = `
                    <div class="limit-info">
                        <div class="flex items-center">
                            <i data-feather="alert-circle" class="w-4 h-4 mr-2 text-yellow-400"></i>
                            <span>Broadcast: <span class="cooldown-timer">Moderator Restricted</span></span>
                        </div>
                        <p class="text-xs text-gray-300 mt-1">Only Admins and Owners can send broadcast messages</p>
                    </div>
                `;
                broadcastCooldownInfo.classList.remove('hidden');
                sendBroadcastBtn.classList.add('action-disabled');
            } else {
                broadcastCooldownInfo.classList.add('hidden');
                sendBroadcastBtn.classList.remove('action-disabled');
            }
        }

        feather.replace();
    }

    // Modal functions
    function openModal(modalId) {
        if (!isVerified) return;
        document.getElementById(modalId).classList.add('active');
        
        // If opening specific message modal, populate users list
        if (modalId === 'specificMessageModal') {
            populateRecipientsList();
        }
        
        // If opening role management modal, load roles
        if (modalId === 'roleManagementModal') {
            loadRolesList();
        }
        
        // If opening role assignment modal, populate roles dropdown
        if (modalId === 'roleAssignmentModal') {
            populateRoleSelect();
        }
        
        // Update cooldown displays for modals
        updateModalCooldownDisplays();
    }
    
    function closeModal(modalId) {
        document.getElementById(modalId).classList.remove('active');
    }
    
    // Populate recipients list for specific messages
    function populateRecipientsList() {
        const recipientsList = document.getElementById('recipientsList');
        const users = JSON.parse(localStorage.getItem('allUsers') || '[]');
        
        recipientsList.innerHTML = '';
        
        users.forEach(user => {
            const userDiv = document.createElement('div');
            userDiv.className = 'user-checkbox';
            userDiv.innerHTML = `
                <input type="checkbox" id="user-${user.username}" name="recipients" value="${escapeHtml(user.username)}" class="mr-2">
                <label for="user-${user.username}" class="cursor-pointer">${user.username} (${user.role})</label>
            `;
            recipientsList.appendChild(userDiv);
        });
    }
    
    // Select all users for messaging
    function selectAllUsers() {
        const checkboxes = document.querySelectorAll('input[name="recipients"]');
        checkboxes.forEach(checkbox => {
            checkbox.checked = true;
        });
    }
    
    // Deselect all users for messaging
    function deselectAllUsers() {
        const checkboxes = document.querySelectorAll('input[name="recipients"]');
        checkboxes.forEach(checkbox => {
            checkbox.checked = false;
        });
    }

    // Update the sendBroadcast function
    async function sendBroadcast() {
        // Check if moderator trying to send broadcast
        if (isModerator(currentUserRole)) {
            alert('Moderators cannot send broadcast messages. Only Admins and Owners have this permission.');
            return;
        }
        
        const message = document.getElementById('broadcastMessage').value.trim();
        const duration = parseInt(document.getElementById('broadcastDuration').value);
        const senderType = document.querySelector('input[name="broadcastSenderType"]:checked').value;
        
        if (!message) {
            alert('Please enter a message to broadcast');
            return;
        }
        
        try {
            const token = getCookie('AuthToken');
            const response = await fetch(`${SERVER_URL}/api/broadcast`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 
                    message, 
                    duration,
                    senderType
                })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Failed to send broadcast');
            }
            
            const result = await response.json();
            alert(`Broadcast sent successfully as ${senderType}! It will be active for ${duration} hours.`);
            closeModal('broadcastModal');
            document.getElementById('broadcastMessage').value = '';
            
        } catch (error) {
            console.error('Broadcast error:', error);
            alert(`Error: ${error.message}`);
        }
    }

    // Update the sendSpecificMessage function
    async function sendSpecificMessage() {
        const message = document.getElementById('specificMessage').value.trim();
        const checkboxes = document.querySelectorAll('input[name="recipients"]:checked');
        const recipients = Array.from(checkboxes).map(cb => cb.value);
        const senderType = document.querySelector('input[name="senderType"]:checked').value;
        
        if (!message) {
            alert('Please enter a message to send');
            return;
        }
        
        if (recipients.length === 0) {
            alert('Please select at least one recipient');
            return;
        }
        
        // Check moderator restrictions
        if (isModerator(currentUserRole)) {
            // Check cooldown
            if (moderatorCooldowns.bulkMessages > 0) {
                alert(`You cannot send bulk messages yet. Cooldown: ${moderatorCooldowns.bulkMessages} minutes remaining.`);
                return;
            }
            
            // Check recipient limit
            if (recipients.length > 5) {
                alert('Moderators can only send messages to 5 or fewer users at once.');
                return;
            }
            
            // Check sender type
            if (senderType === "system") {
                alert('Moderators cannot send messages as system.');
                return;
            }
        }
        
        try {
            const token = getCookie('AuthToken');
            const response = await fetch(`${SERVER_URL}/api/messages/send`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 
                    message, 
                    recipients,
                    duration: 168,
                    senderType
                })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Failed to send message');
            }
            
            const result = await response.json();
            alert(` Message sent as ${senderType} to ${result.recipients.length} user(s)!`);
            closeModal('specificMessageModal');
            document.getElementById('specificMessage').value = '';
            deselectAllUsers();
            
            // Refresh cooldowns if moderator
            if (isModerator(currentUserRole)) {
                setTimeout(getModeratorCooldowns, 1000);
            }
            
        } catch (error) {
            console.error('Message send error:', error);
            alert(` Error: ${error.message}`);
        }
    }
    
    async function sendWarning() {
        const username = document.getElementById('warnUsername').value.trim();
        const reason = document.getElementById('warnMessage').value.trim();
        const senderType = document.querySelector('input[name="warnSenderType"]:checked').value;
        
        if (!username) {
            alert('Please enter a username to warn');
            return;
        }
        
        if (!reason) {
            alert('Please enter a warning reason');
            return;
        }
        
        // Check moderator restrictions
        if (isModerator(currentUserRole)) {
            // Check cooldown
            if (moderatorCooldowns.warnings > 0) {
                alert(`You cannot send warnings yet. Cooldown: ${moderatorCooldowns.warnings} minutes remaining.`);
                return;
            }
            
            // Check sender type
            if (senderType === "system") {
                alert('Moderators cannot send warnings as system.');
                return;
            }
            
            // Check if target user exists and has appropriate role
            const targetUser = users.find(u => u.username.toLowerCase() === username.toLowerCase());
            if (targetUser) {
                const currentUserWeight = getRoleWeight(currentUserRole);
                const targetUserWeight = getRoleWeight(targetUser.role);
                
                if (targetUserWeight >= currentUserWeight) {
                    alert(`You can only warn users with roles lower than yours. Target user role: ${targetUser.role}`);
                    return;
                }
            }
        }
        
        try {
            const token = getCookie('AuthToken');
            const response = await fetch(`${SERVER_URL}/api/warnings/issue`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 
                    username, 
                    reason,
                    senderType
                })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Failed to send warning');
            }
            
            const result = await response.json();
            alert(` Warning issued as ${senderType} to ${username}: "${reason}"\nWarning ID: ${result.warning.id}`);
            closeModal('warnModal');
            document.getElementById('warnUsername').value = '';
            document.getElementById('warnMessage').value = '';
            
            // Refresh cooldowns if moderator
            if (isModerator(currentUserRole)) {
                setTimeout(getModeratorCooldowns, 1000);
            }
            
        } catch (error) {
            console.error('Warning error:', error);
            alert(` Error: ${error.message}`);
        }
    }
    
    async function viewUserWarnings(username) {
        if (!username) {
            alert('Please enter a username');
            return;
        }
        
        try {
            const token = getCookie('AuthToken');
            const response = await fetch(`${SERVER_URL}/api/admin/warnings/${encodeURIComponent(username)}`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Failed to fetch warnings');
            }
            
            const warnings = await response.json();
            showWarningsModal(username, warnings);
            
        } catch (error) {
            console.error('Fetch warnings error:', error);
            alert(`Error: ${error.message}`);
        }
    }

    // Fixed showWarningsModal function with proper escaping
    function showWarningsModal(username, warnings) {
        // Count active and dismissed warnings
        const activeWarnings = warnings.filter(w => !w.dismissed);
        const dismissedWarnings = warnings.filter(w => w.dismissed);
        
        let warningsHTML = '';
        
        if (warnings.length === 0) {
            warningsHTML = '<p class="text-gray-400 text-center py-4">No warnings found</p>';
        } else {
            warningsHTML = warnings.map(warning => {
                const isDismissed = warning.dismissed;
                const safeUsername = escapeHtml(username);
                const safeWarningId = escapeHtml(warning.id);
                const safeReason = escapeHtml(warning.reason);
                const safeIssuedBy = escapeHtml(warning.issuedBy);
                const safeOriginalIssuer = escapeHtml(warning.originalIssuer || '');
                const safeSenderType = escapeHtml(warning.senderType || 'user');
                const safeDismissedBy = escapeHtml(warning.dismissedBy || '');
                
                const dismissedHTML = isDismissed ? 
                    '<p class="text-sm text-green-300">Dismissed on ' + new Date(warning.dismissedAt).toLocaleDateString() + 
                    (warning.dismissedBy ? ' by ' + safeDismissedBy : '') + '</p>' :
                    '<p class="text-sm text-yellow-300">Active warning</p>';
                    
                const dismissButton = !isDismissed ? 
                    '<button onclick="dismissWarning(\'' + safeUsername + '\', \'' + safeWarningId + '\')" class="bg-green-600 hover:bg-green-700 text-white px-2 py-1 rounded text-sm" title="Dismiss Warning"><i data-feather="check" class="w-3 h-3"></i></button>' :
                    '';
                    
                return '<div class="glassmorphism p-3 rounded-lg mb-2 ' + (isDismissed ? 'opacity-70' : '') + '">' +
                    '<div class="flex justify-between items-start">' +
                        '<div class="flex-1">' +
                            '<p class="font-medium">' + safeReason + '</p>' +
                            '<p class="text-sm text-gray-300">Issued by: ' + safeIssuedBy + 
                            (warning.senderType === 'user' ? ' (' + safeOriginalIssuer + ')' : '') +
                            ' on ' + new Date(warning.issuedAt).toLocaleDateString() + '</p>' +
                            '<p class="text-xs text-gray-400">Type: ' + safeSenderType + '</p>' +
                            dismissedHTML +
                        '</div>' +
                        '<div class="flex space-x-1 ml-2">' +
                            dismissButton +
                            '<button onclick="deleteWarning(\'' + safeUsername + '\', \'' + safeWarningId + '\')" class="bg-red-600 hover:bg-red-700 text-white px-2 py-1 rounded text-sm" title="Delete Warning Permanently"><i data-feather="trash-2" class="w-3 h-3"></i></button>' +
                        '</div>' +
                    '</div>' +
                '</div>';
            }).join('');
        }
        
        const safeUsername = escapeHtml(username);
        const bulkActionsHTML = 
            (warnings.length > 0 ? '<button onclick="deleteAllWarnings(\'' + safeUsername + '\', ' + warnings.length + ')" class="bg-red-600 hover:bg-red-700 text-white py-1 px-3 rounded text-sm">Delete All</button>' : '') +
            (dismissedWarnings.length > 0 ? '<button onclick="deleteDismissedWarnings(\'' + safeUsername + '\', ' + dismissedWarnings.length + ')" class="bg-orange-600 hover:bg-orange-700 text-white py-1 px-3 rounded text-sm">Delete Dismissed</button>' : '');
        
        const modalHtml = 
            '<div class="modal-overlay active" id="warningsModal">' +
                '<div class="modal-content" style="max-width: 600px;">' +
                    '<div class="flex justify-between items-center mb-4">' +
                        '<div>' +
                            '<h2 class="text-xl font-bold">Warnings for ' + safeUsername + '</h2>' +
                            '<div class="flex space-x-4 text-sm text-gray-300 mt-1">' +
                                '<span>Total: ' + warnings.length + '</span>' +
                                '<span class="text-yellow-400">Active: ' + activeWarnings.length + '</span>' +
                                '<span class="text-green-400">Dismissed: ' + dismissedWarnings.length + '</span>' +
                            '</div>' +
                        '</div>' +
                        '<button onclick="closeModal(\'warningsModal\')" class="p-1 rounded-full hover:bg-purple-700">' +
                            '<i data-feather="x" class="w-5 h-5"></i>' +
                        '</button>' +
                    '</div>' +
                    '<div class="flex space-x-2 mb-4">' +
                        bulkActionsHTML +
                    '</div>' +
                    '<div class="max-h-64 overflow-y-auto">' +
                        warningsHTML +
                    '</div>' +
                    '<button onclick="closeModal(\'warningsModal\')" class="bg-purple-600 hover:bg-purple-700 text-white py-2 px-6 rounded-lg font-medium w-full mt-4">Close</button>' +
                '</div>' +
            '</div>';
        
        // Add modal to page if it doesn't exist
        if (!document.getElementById('warningsModal')) {
            const modalContainer = document.createElement('div');
            modalContainer.innerHTML = modalHtml;
            document.body.appendChild(modalContainer);
            feather.replace();
        } else {
            document.getElementById('warningsModal').innerHTML = modalHtml;
            document.getElementById('warningsModal').classList.add('active');
            feather.replace();
        }
    }
    
    // Delete a specific warning permanently
    async function deleteWarning(username, warningId) {
        if (!confirm('Permanently delete this warning for ' + username + '?\n\nThis action cannot be undone!')) {
            return;
        }
        
        try {
            const token = getCookie('AuthToken');
            const response = await fetch(`${SERVER_URL}/api/admin/warnings/${warningId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ username })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Failed to delete warning');
            }
            
            const result = await response.json();
            alert(' ' + result.message);
            // Refresh the warnings view
            viewUserWarnings(username);
            
        } catch (error) {
            console.error('Delete warning error:', error);
            alert(' Error: ' + error.message);
        }
    }

    // Delete all warnings for a user
    async function deleteAllWarnings(username, warningCount) {
        if (!confirm('Delete ALL warnings for ' + username + '?\n\nThis will permanently remove ' + warningCount + ' warning(s) and cannot be undone!')) {
            return;
        }
        
        try {
            const token = getCookie('AuthToken');
            const response = await fetch(`${SERVER_URL}/api/admin/warnings/user/${encodeURIComponent(username)}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Failed to delete warnings');
            }
            
            const result = await response.json();
            alert(' ' + result.message);
            // Refresh the warnings view
            viewUserWarnings(username);
            
        } catch (error) {
            console.error('Delete all warnings error:', error);
            alert(' Error: ' + error.message);
        }
    }

    // Delete only dismissed warnings for a user
    async function deleteDismissedWarnings(username, dismissedCount) {
        if (!confirm('Delete all DISMISSED warnings for ' + username + '?\n\nThis will permanently remove ' + dismissedCount + ' dismissed warning(s) but keep active ones.')) {
            return;
        }
        
        try {
            const token = getCookie('AuthToken');
            const response = await fetch(`${SERVER_URL}/api/admin/warnings/user/${encodeURIComponent(username)}/dismissed`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Failed to delete dismissed warnings');
            }
            
            const result = await response.json();
            alert(' ' + result.message);
            // Refresh the warnings view
            viewUserWarnings(username);
            
        } catch (error) {
            console.error('Delete dismissed warnings error:', error);
            alert(' Error: ' + error.message);
        }
    }
    
    async function dismissWarning(username, warningId) {
        if (!confirm('Dismiss this warning for ' + username + '?')) {
            return;
        }
        
        try {
            const token = getCookie('AuthToken');
            const response = await fetch(`${SERVER_URL}/api/admin/warnings/${warningId}/dismiss`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ username })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Failed to dismiss warning');
            }
            
            alert('Warning dismissed successfully');
            // Refresh the warnings view
            viewUserWarnings(username);
            
        } catch (error) {
            console.error('Dismiss warning error:', error);
            alert('Error: ' + error.message);
        }
    }

    // Show remote delete confirmation modal
    function showRemoteDeleteModal(username, userRole) {
        document.getElementById('deleteUsernameDisplay').textContent = username;
        document.getElementById('deleteUserRole').textContent = 'Role: ' + userRole;
        document.getElementById('adminPassword').value = '';
        openModal('remoteDeleteModal');
    }

    // Confirm and execute remote deletion
    async function confirmRemoteDelete() {
        const username = document.getElementById('deleteUsernameDisplay').textContent;
        const password = document.getElementById('adminPassword').value.trim();
        
        if (!password) {
            alert('Please enter your password to confirm deletion');
            return;
        }
        
        try {
            const token = getCookie('AuthToken');
            const response = await fetch(`${SERVER_URL}/api/admin/users/${encodeURIComponent(username)}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ password })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Failed to delete user');
            }
            
            const result = await response.json();
            alert(' ' + result.message);
            closeModal('remoteDeleteModal');
            
            // Reload users list
            loadUsersList();
            
        } catch (error) {
            console.error('Delete user error:', error);
            alert(' Error: ' + error.message);
        }
    }

    // Populate role select with available options - FIXED VERSION
    async function populateRoleSelect() {
        try {
            availableRoles = await loadAvailableRoles();
            const roleSelect = document.getElementById('roleSelect');
            
            // Clear existing options
            roleSelect.innerHTML = '<option value="">Select a role</option>';
            
            if (availableRoles.length === 0) {
                roleSelect.innerHTML = '<option value="">No roles available for assignment</option>';
                return;
            }
            
            // Add available roles with proper formatting
            availableRoles.forEach(role => {
                const option = document.createElement('option');
                option.value = role.value;
                option.textContent = `${role.label} - ${role.description}`;
                roleSelect.appendChild(option);
            });
            
            // Update role help text when selection changes
            updateRoleAssignmentHelp();
            
        } catch (error) {
            console.error('Populate roles error:', error);
            const roleSelect = document.getElementById('roleSelect');
            roleSelect.innerHTML = '<option value="">Error loading roles</option>';
        }
    }

    // Show role assignment modal
    async function showRoleAssignmentModal(username, currentRole) {
        // Prevent changing Owner roles for non-Owners
        if (currentRole === "Owner" && currentUserRole !== "Owner") {
            alert(" Error: Only Owners can modify other Owner roles");
            return;
        }
        
        selectedUserForRole = username;
        
        document.getElementById('roleUsernameDisplay').textContent = username;
        document.getElementById('currentUserRole').textContent = 'Current Role: ' + currentRole;
        
        // Populate role select with fresh data from server
        await populateRoleSelect();
        
        openModal('roleAssignmentModal');
    }

    // Update role help text for assignment modal
    function updateRoleAssignmentHelp() {
      const roleSelect = document.getElementById('roleSelect');
      const roleHelp = document.getElementById('roleHelp');
      const selectedRole = roleSelect.value;
      
      if (selectedRole && allRoles[selectedRole]) {
        const roleConfig = allRoles[selectedRole];
        let helpText = roleConfig.description || `Role: ${selectedRole}`;
        helpText += ` (Weight: ${roleConfig.weight})`;
        
        // Add moderator-specific guidance
        if (isModerator(currentUserRole)) {
          const currentUserWeight = getRoleWeight(currentUserRole);
          
          if (roleConfig.weight >= currentUserWeight) {
            helpText += '  Cannot assign - weight too high';
          } else if (roleConfig.weight >= 50) {
            helpText += '  Cannot assign - high-privilege role';
          } else if (roleConfig.cosmetic && currentUserWeight < 60) {
            helpText += '  Cannot assign - cosmetic role requires weight 60+';
          } else {
            helpText += '  Can assign';
          }
        }
        
        roleHelp.textContent = helpText;
        roleHelp.classList.remove('hidden');
      } else {
        roleHelp.classList.add('hidden');
      }
    }

    // Confirm role assignment
    async function confirmRoleAssignment() {
        const role = document.getElementById('roleSelect').value;
        
        if (!role) {
            alert('Please select a role');
            return;
        }
        
        if (!confirm(`Are you sure you want to assign the role "${role}" to user "${selectedUserForRole}"?`)) {
            return;
        }
        
        try {
            const result = await assignRole(selectedUserForRole, role);
            alert(` ${result.message}\n\nUser: ${result.user.username}\nOld Role: ${result.user.oldRole}\nNew Role: ${result.user.newRole}`);
            
            closeModal('roleAssignmentModal');
            
            // Reload users list to reflect changes
            loadUsersList();
            
        } catch (error) {
            console.error('Role assignment error:', error);
            alert(` Error: ${error.message}`);
        }
    }

    // Assign role to user
    async function assignRole(username, role) {
        try {
            const token = getCookie('AuthToken');
            const response = await fetch(`${SERVER_URL}/api/admin/users/${encodeURIComponent(username)}/role`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ role })
            });
            
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Failed to assign role');
        }
        
        const result = await response.json();
        return result;
        
    } catch (error) {
        console.error('Assign role error:', error);
        throw error;
    }
}

// Get role weight
function getRoleWeight(roleName) {
    const roleConfig = allRoles[roleName];
    return roleConfig ? (roleConfig.weight || 0) : 0;
}

// Enable app interaction
function enableAppInteraction() {
    isVerified = true;
    const mainApp = document.getElementById('mainApp');
    mainApp.classList.remove('non-interactive');
    mainApp.style.pointerEvents = 'auto';
    mainApp.style.opacity = '1';
}

// Disable app interaction
function disableAppInteraction() {
    isVerified = false;
    const mainApp = document.getElementById('mainApp');
    mainApp.classList.add('non-interactive');
    mainApp.style.pointerEvents = 'none';
    mainApp.style.opacity = '0.6';
}

// Check authentication status on page load
document.addEventListener('DOMContentLoaded', async function() {
    // Show loading overlay first
    document.getElementById('loadingOverlay').classList.remove('hidden');
    
    const token = getCookie('AuthToken');
    
    if (!token) {
        // No token, show login modal after loading
        setTimeout(() => {
            document.getElementById('loadingOverlay').classList.add('hidden');
            document.getElementById('loginModal').classList.remove('hidden');
            document.getElementById('mainApp').classList.remove('hidden'); // Show but disable interaction
            disableAppInteraction();
        }, 1000);
        return;
    }

    try {
        // Get user info first to check permissions
        const userInfo = await getUserInfo(token);
        
        // Check if user has admin permissions
        if (userInfo.role !== "Owner" && userInfo.role !== "Admin" && userInfo.role !== "Moderator") {
            // Insufficient permissions - redirect to target URL
            setTimeout(() => {
                document.getElementById('loadingOverlay').classList.add('hidden');
                alert("Insufficient permissions. Only admins and moderators can access this page.");
                window.location.href = "https://senturyhanderserson.github.io/SigmiForCCGS/";
            }, 1000);
            return;
        }
        
        // Set global user variables
        currentUser = userInfo.username;
        currentUserRole = userInfo.role;
        
        // Load ALL roles from server first
        const allRolesData = await loadAllRoles();
        allRoles = allRolesData;
        
        // Apply role colors
        applyRoleColors(allRoles);
        
        // Store user info in localStorage for persistence
        localStorage.setItem('currentUser', userInfo.username);
        localStorage.setItem('currentUserRole', userInfo.role);
        
        // Show main app and enable interaction
        setTimeout(() => {
            document.getElementById('loadingOverlay').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('loginModal').classList.add('hidden');
            enableAppInteraction();
            
            // Update user info display
            document.getElementById('userUsername').textContent = userInfo.username;
            document.getElementById('userRoleDisplay').textContent = userInfo.role;
            
            // Show moderator cooldowns if user is moderator
            if (isModerator(currentUserRole)) {
                document.getElementById('moderatorCooldowns').classList.remove('hidden');
                getModeratorCooldowns();
                // Start cooldown refresh interval
                cooldownInterval = setInterval(getModeratorCooldowns, 30000); // Refresh every 30 seconds
            }
            
            // Load users list
            loadUsersList();
        }, 1000);
        
    } catch (error) {
        console.error('Authentication error:', error);
        // Authentication failed, show login modal
        setTimeout(() => {
            document.getElementById('loadingOverlay').classList.add('hidden');
            document.getElementById('loginModal').classList.remove('hidden');
            document.getElementById('mainApp').classList.remove('hidden'); // Show but disable interaction
            disableAppInteraction();
        }, 1000);
    }
});

// Show login modal function
function showLoginModal() {
    document.getElementById('loginModal').classList.remove('hidden');
    document.getElementById('mainApp').classList.add('hidden');
}

// Redirect to login page
function redirectToLogin() {
    window.location.href = 'https://senturyhanderserson.github.io/SigmiForCCGS/';
}

// Load users list with proper escaping
async function loadUsersList() {
    try {
        const token = getCookie('AuthToken');
        const response = await fetch(`${SERVER_URL}/api/users`, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error('Failed to load users');
        }
        
        users = await response.json(); // Update global users variable
        
        // Store users for use in the specific message modal
        localStorage.setItem('allUsers', JSON.stringify(users));
        
        const container = document.getElementById('usersList');
        
        if (users.length === 0) {
            container.innerHTML = '<p class="text-gray-400 text-center py-4">No users found</p>';
            return;
        }
        
        // Use string concatenation with proper escaping
        let usersHTML = '';
        users.forEach(user => {
            const canDelete = user.username !== currentUser && 
                (currentUserRole === 'Owner' || 
                 (currentUserRole === 'Admin' && user.role !== 'Owner' && user.role !== 'Admin') ||
                 (isModerator(currentUserRole) && user.role !== 'Owner' && user.role !== 'Admin' && getRoleWeight(user.role) < getRoleWeight(currentUserRole)));
            
            // Prevent non-Owners from assigning roles to Owners
            const canAssignRole = user.username !== currentUser && 
                (currentUserRole === 'Owner' || 
                 (currentUserRole === 'Admin' && user.role !== 'Owner') ||
                 (isModerator(currentUserRole) && user.role !== 'Owner' && user.role !== 'Admin' && getRoleWeight(user.role) < getRoleWeight(currentUserRole)));
            
            // Escape all dynamic values
            const safeUsername = escapeHtml(user.username);
            const safeRole = escapeHtml(user.role);
            const safeJoined = escapeHtml(user.joined);
            const safeBlacklistReason = user.blacklistReason ? escapeHtml(user.blacklistReason) : '';
            
            const deleteButton = canDelete ? 
                '<button onclick="showRemoteDeleteModal(\'' + safeUsername + '\', \'' + safeRole + '\')" class="p-2 bg-red-600 hover:bg-red-700 rounded-lg transition-all duration-200 hover:scale-110" title="Delete Account"><i data-feather="trash-2" class="w-4 h-4"></i></button>' : '';
            
            const roleButton = canAssignRole ? 
                '<button onclick="showRoleAssignmentModal(\'' + safeUsername + '\', \'' + safeRole + '\')" class="p-2 bg-purple-600 hover:bg-purple-700 rounded-lg transition-all duration-200 hover:scale-110" title="Assign Role"><i data-feather="users" class="w-4 h-4"></i></button>' : '';
            
            const blacklistButton = user.blacklisted ? 
                '<button onclick="unblacklistUser(\'' + safeUsername + '\')" class="p-2 bg-green-600 hover:bg-green-700 rounded-lg transition-all duration-200 hover:scale-110"><i data-feather="check-circle" class="w-4 h-4"></i></button>' :
                '<button onclick="showBlacklistForm(\'' + safeUsername + '\')" class="p-2 bg-red-600 hover:bg-red-700 rounded-lg transition-all duration-200 hover:scale-110"><i data-feather="x-circle" class="w-4 h-4"></i></button>';
            
            // Get role badge class using dynamic role configuration
            const roleBadgeClass = getRoleBadgeClass(user.role);
            
            // Add owner-protected class for non-Owners viewing Owner roles
            const roleBadgeExtraClass = (user.role === "Owner" && currentUserRole !== "Owner") ? 'owner-protected' : '';
            
            const blacklistInfo = user.blacklisted ? ' Reason: ' + safeBlacklistReason : '';
            
            usersHTML += 
                '<div class="glassmorphism p-4 rounded-lg flex justify-between items-center user-card">' +
                    '<div class="flex-1">' +
                        '<div class="flex items-center space-x-2 mb-2">' +
                            '<span class="font-medium text-lg">' + safeUsername + '</span>' +
                            '<span class="user-status-badge ' + (user.blacklisted ? 'status-blacklisted' : 'status-clean') + '">' +
                                (user.blacklisted ? 'Blacklisted' : 'Clean') +
                            '</span>' +
                            '<span class="role-badge ' + roleBadgeClass + ' ' + roleBadgeExtraClass + '" ' + 
                                (canAssignRole ? 'onclick="showRoleAssignmentModal(\'' + safeUsername + '\', \'' + safeRole + '\')" title="Click to change role"' : 
                                (user.role === "Owner" && currentUserRole !== "Owner" ? 'title="Only Owners can modify Owner roles"' : 'title="Cannot change role"')) + '>' +
                                safeRole +
                            '</span>' +
                        '</div>' +
                        '<div class="text-sm text-gray-300">' +
                            'Joined: ' + safeJoined + ' ' + blacklistInfo +
                        '</div>' +
                    '</div>' +
                    '<div class="flex space-x-2">' +
                        '<button onclick="viewUserWarnings(\'' + safeUsername + '\')" class="p-2 bg-yellow-600 hover:bg-yellow-700 rounded-lg transition-all duration-200 hover:scale-110" title="View Warnings"><i data-feather="alert-triangle" class="w-4 h-4"></i></button>' +
                        roleButton +
                        deleteButton +
                        blacklistButton +
                    '</div>' +
                '</div>';
        });
        
        container.innerHTML = usersHTML;
        feather.replace();
        
    } catch (error) {
        console.error('Failed to load users:', error);
        document.getElementById('usersList').innerHTML = '<p class="text-red-300 text-center py-4">Error loading users: ' + error.message + '</p>';
    }
}

// Show blacklist form with pre-filled username
function showBlacklistForm(username) {
    document.getElementById('username').value = username;
    document.getElementById('reason').focus();
}

// Blacklist user
async function blacklistUser(username, reason) {
    // Check moderator restrictions
    if (isModerator(currentUserRole)) {
        // Check cooldown
        if (moderatorCooldowns.blacklists > 0) {
            alert(`You cannot blacklist users yet. Cooldown: ${moderatorCooldowns.blacklists} minutes remaining.`);
            return;
        }
        
        // Check if target user exists and has appropriate role
        const targetUser = users.find(u => u.username.toLowerCase() === username.toLowerCase());
        if (targetUser) {
            const currentUserWeight = getRoleWeight(currentUserRole);
            const targetUserWeight = getRoleWeight(targetUser.role);
            
            if (targetUserWeight >= currentUserWeight) {
                alert(`You can only blacklist users with roles lower than yours. Target user role: ${targetUser.role}`);
                return;
            }
            
            // Moderators cannot blacklist admins
            if (targetUser.role === "Admin") {
                alert('Moderators cannot blacklist admin accounts.');
                return;
            }
        }
    }
    
    try {
        const token = getCookie('AuthToken');
        const response = await fetch(`${SERVER_URL}/api/blacklist/${encodeURIComponent(username)}`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ reason })
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Failed to blacklist user');
        }
        
        const result = await response.json();
        alert('User ' + username + ' has been blacklisted: ' + result.blacklistReason);
        
        // Reload users list
        loadUsersList();
        
        // Refresh cooldowns if moderator
        if (isModerator(currentUserRole)) {
            setTimeout(getModeratorCooldowns, 1000);
        }
        
    } catch (error) {
        console.error('Blacklist error:', error);
        alert('Error: ' + error.message);
    }
}

// Unblacklist user
async function unblacklistUser(username) {
    if (!confirm('Are you sure you want to unblacklist ' + username + '?')) {
        return;
    }
    
    // Check moderator restrictions
    if (isModerator(currentUserRole)) {
        // Check cooldown
        if (moderatorCooldowns.unblacklists > 0) {
            alert(`You cannot unblacklist users yet. Cooldown: ${moderatorCooldowns.unblacklists} minutes remaining.`);
            return;
        }
        
        // Check if target user exists and has appropriate role
        const targetUser = users.find(u => u.username.toLowerCase() === username.toLowerCase());
        if (targetUser) {
            const currentUserWeight = getRoleWeight(currentUserRole);
            const targetUserWeight = getRoleWeight(targetUser.role);
            
            if (targetUserWeight > currentUserWeight) {
                alert(`You can only unblacklist users with roles lower or equal to yours. Target user role: ${targetUser.role}`);
                return;
            }
        }
    }
    
    try {
        const token = getCookie('AuthToken');
        const response = await fetch(`${SERVER_URL}/api/unblacklist/${encodeURIComponent(username)}`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Failed to unblacklist user');
        }
        
        alert('User ' + username + ' has been unblacklisted');
        
        // Reload users list
        loadUsersList();
        
        // Refresh cooldowns if moderator
        if (isModerator(currentUserRole)) {
            setTimeout(getModeratorCooldowns, 1000);
        }
        
    } catch (error) {
        console.error('Unblacklist error:', error);
        alert('Error: ' + error.message);
    }
}

// Handle blacklist form submission
document.getElementById('blacklistForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const username = document.getElementById('username').value.trim();
    const reason = document.getElementById('reason').value.trim();
    
    if (!username) {
        alert('Please enter a username');
        return;
    }
    
    if (!reason) {
        alert('Please enter a reason for blacklisting');
        return;
    }
    
    blacklistUser(username, reason);
    
    // Reset form
    this.reset();
});

// Refresh users list
document.getElementById('refreshUsers').addEventListener('click', function() {
    loadUsersList();
});

// Refresh cooldowns
document.getElementById('refreshCooldowns').addEventListener('click', function() {
    if (isModerator(currentUserRole)) {
        getModeratorCooldowns();
    }
});

// Logout button
document.getElementById('logoutButton').addEventListener('click', function() {
    // Clear auth data
    document.cookie = 'AuthToken=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
    localStorage.removeItem('currentUser');
    localStorage.removeItem('currentUserRole');
    localStorage.removeItem('allUsers');
    
    // Clear cooldown interval
    if (cooldownInterval) {
        clearInterval(cooldownInterval);
    }
    
    // Redirect to login
    window.location.href = 'https://senturyhanderserson.github.io/SigmiForCCGS/';
});

// Cookie Functions
function getCookie(name) {
    const cookieName = name + "=";
    const decodedCookie = decodeURIComponent(document.cookie);
    const cookieArray = decodedCookie.split(';');
    
    for(let i = 0; i < cookieArray.length; i++) {
        let cookie = cookieArray[i];
        while (cookie.charAt(0) === ' ') {
            cookie = cookie.substring(1);
        }
        if (cookie.indexOf(cookieName) === 0) {
            return cookie.substring(cookieName.length, cookie.length);
        }
    }
    return "";
}

// Role Management Functions
let currentRoles = {};

// Load roles list for management
async function loadRolesList() {
    try {
        const token = getCookie('AuthToken');
        const response = await fetch(`${SERVER_URL}/api/roles/colors`, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error('Failed to load roles');
        }
        
        const data = await response.json();
        currentRoles = data.roles || {};
        allRoles = currentRoles; // Update global allRoles
        displayRolesList(currentRoles);
        
    } catch (error) {
        console.error('Load roles list error:', error);
        document.getElementById('rolesList').innerHTML = 
            '<div class="text-red-300 text-center py-4">Error loading roles: ' + error.message + '</div>';
    }
}

// Display roles in management modal - UPDATED WITH COSMETIC BADGE
function displayRolesList(roles) {
  const container = document.getElementById('rolesList');
  
  if (Object.keys(roles).length === 0) {
    container.innerHTML = '<div class="text-gray-400 text-center py-4">No roles found</div>';
    return;
  }
  
  // Initialize rolesHTML at the top
  let rolesHTML = '';
  const currentUserWeight = getRoleWeight(currentUserRole);
  
  // Add moderator limits header
  if (isModerator(currentUserRole)) {
    rolesHTML += `
      <div class="glassmorphism p-3 rounded-lg mb-4 border-l-4 border-yellow-500">
        <div class="flex items-center">
          <i data-feather="info" class="w-4 h-4 text-yellow-400 mr-2"></i>
          <div>
            <p class="font-semibold">Moderator Role Limits</p>
            <p class="text-sm text-gray-300">
              Max creation weight: ${currentUserWeight - 1} | 
              Max assignment weight: ${currentUserWeight - 1} |
              Cannot assign roles  weight 50
            </p>
          </div>
        </div>
      </div>
    `;
  }
  
  // Convert to array and sort by weight
  const rolesArray = Object.entries(roles)
    .sort(([,a], [,b]) => (b.weight || 0) - (a.weight || 0));
  
  rolesArray.forEach(([roleName, roleConfig]) => {
    const safeRoleName = escapeHtml(roleName);
    const safeDescription = escapeHtml(roleConfig.description || 'No description');
    const safeColor = escapeHtml(roleConfig.color || '#6b7280');
    const weight = roleConfig.weight || 0;
    const userCount = users.filter(u => u.role === roleName).length;
    const isCosmetic = roleConfig.cosmetic || false;
    
    const currentUserRoleConfig = allRoles[currentUserRole];
    const currentUserWeight = currentUserRoleConfig?.weight || 0;
    
    // Check if current user can delete this role based on weight
    const canDelete = currentUserRole === 'Owner' || 
      (currentUserWeight >= weight && 
       roleName !== 'Owner' && 
       userCount === 0);
    
    const canEdit = currentUserRole === 'Owner' || (currentUserRole === 'Admin' && roleName !== 'Owner');
    
    rolesHTML += `
      <div class="glassmorphism p-4 rounded-lg role-management-item ${isCosmetic ? 'cosmetic-role' : ''}">
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-3">
            <div class="w-6 h-6 rounded-full border-2 border-white" style="background-color: ${safeColor};"></div>
            <div>
              <div class="flex items-center space-x-2">
                <span class="font-semibold">${safeRoleName}</span>
                <span class="text-xs px-2 py-1 rounded-full bg-gray-700">Weight: ${weight}</span>
                ${isCosmetic ? '<span class="text-xs px-2 py-1 rounded-full cosmetic-badge">Cosmetic</span>' : ''}
                <span class="text-xs px-2 py-1 rounded-full ${userCount > 0 ? 'bg-blue-600' : 'bg-gray-600'}">
                  ${userCount} user(s)
                </span>
              </div>
              <p class="text-sm text-gray-300">${safeDescription}</p>
            </div>
          </div>
          <div class="flex space-x-2">
            ${canEdit ? `
              <button onclick="editRoleColor('${safeRoleName}', '${safeColor}')" 
                      class="p-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition-all duration-200 hover:scale-110"
                      title="Change Color">
                <i data-feather="edit-3" class="w-4 h-4"></i>
              </button>
            ` : ''}
            ${canDelete ? `
              <button onclick="deleteRole('${safeRoleName}')" 
                      class="p-2 bg-red-600 hover:bg-red-700 rounded-lg transition-all duration-200 hover:scale-110"
                      title="Delete Role">
                <i data-feather="trash-2" class="w-4 h-4"></i>
              </button>
            ` : ''}
          </div>
        </div>
      </div>
    `;
  });
  
  container.innerHTML = rolesHTML;
  feather.replace();
}
// Edit role color
async function editRoleColor(roleName, currentColor) {
    const newColor = prompt(`Enter new color for ${roleName} (hex format):`, currentColor);
    
    if (!newColor) return;
    
    // Validate color format
    const colorRegex = /^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/;
    if (!colorRegex.test(newColor)) {
        alert('Invalid color format. Please use hex format (#RRGGBB)');
        return;
    }
    
    try {
        const token = getCookie('AuthToken');
        const response = await fetch(`${SERVER_URL}/api/roles/${encodeURIComponent(roleName)}/color`, {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ color: newColor })
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Failed to update role color');
        }
        
        const result = await response.json();
        alert(' ' + result.message);
        
        // Refresh roles list and reload users to apply new colors
        await loadRolesList();
        await loadUsersList();
        
    } catch (error) {
        console.error('Edit role color error:', error);
        alert(' Error: ' + error.message);
    }
}

// Delete role - UPDATED WITH WEIGHT-BASED PERMISSION CHECKING
async function deleteRole(roleName) {
    const currentUserRoleConfig = allRoles[currentUserRole];
    const currentUserWeight = currentUserRoleConfig?.weight || 0;
    const targetRoleConfig = allRoles[roleName];
    const targetRoleWeight = targetRoleConfig?.weight || 0;
    
    // Check if current user can delete this role
    if (currentUserRole !== 'Owner' && currentUserWeight < targetRoleWeight) {
        alert(` You cannot delete the "${roleName}" role. Your role weight (${currentUserWeight}) is lower than the target role weight (${targetRoleWeight}).`);
        return;
    }
    
    const userCount = users.filter(u => u.role === roleName).length;
    if (userCount > 0) {
        alert(` Cannot delete role "${roleName}" - ${userCount} user(s) have this role assigned.`);
        return;
    }
    
    if (!confirm(`Are you sure you want to delete the role "${roleName}"?\n\nThis action cannot be undone!`)) {
        return;
    }
    
    try {
        const token = getCookie('AuthToken');
        const response = await fetch(`${SERVER_URL}/api/roles/${encodeURIComponent(roleName)}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Failed to delete role');
        }
        
        const result = await response.json();
        alert(' ' + result.message);
        
        // Refresh roles list
        await loadRolesList();
        
    } catch (error) {
        console.error('Delete role error:', error);
        alert(' Error: ' + error.message);
    }
}

// Color picker functionality
function setupColorPicker() {
    const colorPicker = document.getElementById('roleColorPicker');
    const colorHex = document.getElementById('roleColorHex');
    
    // Sync color picker and hex input
    colorPicker.addEventListener('input', function() {
        colorHex.value = this.value;
    });
    
    colorHex.addEventListener('input', function() {
        const color = this.value;
        if (/^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/.test(color)) {
            colorPicker.value = color.length === 4 ? 
                color.replace(/#(.)(.)(.)/, '#$1$1$2$2$3$3') : color;
        }
    });
    
    colorHex.addEventListener('blur', function() {
        const color = this.value;
        if (!color.startsWith('#')) {
            this.value = '#' + color;
        }
    });
    
    // Initialize with random color
    setRandomColor();
}

// Set random color
function setRandomColor() {
    const randomColor = '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6, '0');
    document.getElementById('roleColorPicker').value = randomColor;
    document.getElementById('roleColorHex').value = randomColor;
}

// Set default color presets
function setDefaultColors() {
    const presetsContainer = document.getElementById('colorPresets');
    const presetColors = [
        '#EF4444', '#F59E0B', '#10B981', '#3B82F6', '#8B5CF6',
        '#EC4899', '#6B7280', '#059669', '#DC2626', '#7C3AED',
        '#F97316', '#84CC16', '#06B6D4', '#6366F1', '#D946EF'
    ];
    
    let presetsHTML = '';
    presetColors.forEach(color => {
        presetsHTML += `
            <button onclick="setPresetColor('${color}')" 
                    class="w-6 h-6 rounded border border-gray-600 hover:scale-110 transition-transform color-preset"
                    style="background-color: ${color};"
                    title="${color}">
            </button>
        `;
    });
    
    presetsContainer.innerHTML = presetsHTML;
    presetsContainer.classList.toggle('hidden');
}

// Set preset color
function setPresetColor(color) {
    document.getElementById('roleColorPicker').value = color;
    document.getElementById('roleColorHex').value = color;
    document.getElementById('colorPresets').classList.add('hidden');
}

// Create new role - UPDATED WITH COSMETIC OPTION
async function createNewRole() {
    const roleName = document.getElementById('newRoleName').value.trim();
    const description = document.getElementById('roleDescription').value.trim();
    const color = document.getElementById('roleColorHex').value;
    const weight = parseInt(document.getElementById('roleWeight').value) || 2;
    const permissions = document.getElementById('rolePermissions').value;
    const cosmetic = document.getElementById('roleCosmetic').checked; // GET COSMETIC VALUE
    
    if (!roleName) {
        alert('Please enter a role name');
        return;
    }
    
    if (!color) {
        alert('Please select a color for the role');
        return;
    }
    
    // Validate color format
    const colorRegex = /^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/;
    if (!colorRegex.test(color)) {
        alert('Invalid color format. Please use hex format (#RRGGBB)');
        return;
    }
    
    // Check if current user can create this role based on weight
    const currentUserRoleConfig = allRoles[currentUserRole];
    if (currentUserRoleConfig && currentUserRoleConfig.weight !== undefined) {
        if (weight >= currentUserRoleConfig.weight) {
            alert(`You cannot create roles with weight ${weight} or higher. Your current role weight is ${currentUserRoleConfig.weight}.`);
            return;
        }
    }
    
    // Map permission sets
    const permissionSets = {
        'basic': ['basic_access'],
        'moderator': ['basic_access', 'view_reports', 'issue_warnings', 'send_messages'],
        'admin': ['basic_access', 'view_reports', 'issue_warnings', 'send_messages', 'blacklist_users', 'assign_roles'],
        'full': ['basic_access', 'view_reports', 'issue_warnings', 'send_messages', 'blacklist_users', 'assign_roles', 'manage_roles', 'delete_users']
    };
    
    const selectedPermissions = permissionSets[permissions] || ['basic_access'];
    
    try {
        const token = getCookie('AuthToken');
        const response = await fetch(`${SERVER_URL}/api/roles/create`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                roleName: roleName,
                color: color,
                description: description || `Custom role: ${roleName}`,
                permissions: selectedPermissions,
                weight: weight,
                canAssign: ['Member'], // Default - can assign Member role
                cosmetic: cosmetic // ADD COSMETIC FLAG
            })
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Failed to create role');
        }
        
        const result = await response.json();
        alert(' ' + result.message);
        
        // Close modal and reset form
        closeModal('roleCreationModal');
        resetRoleForm();
        
        // Refresh roles list and update global roles
        await loadRolesList();
        await loadAllRoles(); // Reload all roles to get the new one
        
    } catch (error) {
        console.error('Create role error:', error);
        alert(' Error: ' + error.message);
    }
}

// Reset role creation form
function resetRoleForm() {
    document.getElementById('newRoleName').value = '';
    document.getElementById('roleDescription').value = '';
    document.getElementById('roleWeight').value = '2';
    document.getElementById('rolePermissions').value = 'basic';
    document.getElementById('roleCosmetic').checked = false; // RESET COSMETIC CHECKBOX
    setRandomColor();
}

// Refresh role list
async function refreshRoleList() {
    await loadRolesList();
}

// Initialize color picker when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    setupColorPicker();
});
</script>
</body>
</html>
