<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f4;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        input, select, button {
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        .error {
            color: red;
            margin: 10px 0;
        }
        .success {
            color: green;
            margin: 10px 0;
        }
        .user-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            margin-top: 10px;
        }
        .blacklist-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        .blacklist-item:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Admin Panel</h1>
        
        <div id="auth-section">
            <h2>Authentication Required</h2>
            <p>Please log in to access the admin panel.</p>
            <button onclick="location.href='index.html'">Go to Login</button>
        </div>
        
        <div id="admin-panel" style="display: none;">
            <div class="section">
                <h2>User Management</h2>
                <div>
                    <input type="text" id="username-search" placeholder="Search username..." list="user-list">
                    <datalist id="user-list"></datalist>
                    <button onclick="searchUser()">Search User</button>
                </div>
                
                <div id="user-details" style="display: none; margin-top: 15px;">
                    <h3>User Details</h3>
                    <p><strong>Username:</strong> <span id="detail-username"></span></p>
                    <p><strong>Role:</strong> <span id="detail-role"></span></p>
                    <p><strong>Joined:</strong> <span id="detail-joined"></span></p>
                    <p><strong>Status:</strong> <span id="detail-status"></span></p>
                    
                    <div id="blacklist-controls" style="margin-top: 15px;">
                        <input type="text" id="blacklist-reason" placeholder="Reason for blacklisting">
                        <button id="blacklist-btn" onclick="toggleBlacklist()">Blacklist User</button>
                        <button id="unblacklist-btn" style="display: none;" onclick="toggleBlacklist()">Unblacklist User</button>
                    </div>
                </div>
            </div>
            
            <div class="section">
                <h2>Blacklisted Users</h2>
                <button onclick="loadBlacklist()">Refresh Blacklist</button>
                <div id="blacklist-container" class="user-list"></div>
            </div>
            
            <div class="section">
                <h2>All Users</h2>
                <button onclick="loadAllUsers()">Load All Users</button>
                <div id="users-container" class="user-list"></div>
            </div>
        </div>
        
        <div id="message" class="error"></div>
    </div>

    <script>
        // Check if user is authenticated and has proper role
        document.addEventListener('DOMContentLoaded', function() {
            const token = localStorage.getItem('token');
            
            if (!token) {
                showMessage('Please log in to access the admin panel', 'error');
                return;
            }
            
            // Verify token and check if user has admin/VIP privileges
            fetch('/api/verify-token', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Invalid token');
                }
                return fetch('/api/user-info', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to get user info');
                }
                return response.json();
            })
            .then(userInfo => {
                // Check if user has required role
                if (userInfo.role === 'VIP' || userInfo.role === 'Admin' || userInfo.role === 'Owner') {
                    document.getElementById('auth-section').style.display = 'none';
                    document.getElementById('admin-panel').style.display = 'block';
                    loadUsernames();
                    loadBlacklist();
                } else {
                    showMessage('Insufficient permissions. VIP, Admin, or Owner role required.', 'error');
                }
            })
            .catch(error => {
                console.error('Authentication error:', error);
                showMessage(error.message, 'error');
            });
        });

        function loadUsernames() {
            const token = localStorage.getItem('token');
            
            fetch('/api/usernames', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to load usernames');
                }
                return response.json();
            })
            .then(usernames => {
                const datalist = document.getElementById('user-list');
                datalist.innerHTML = '';
                
                usernames.forEach(username => {
                    const option = document.createElement('option');
                    option.value = username;
                    datalist.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error loading usernames:', error);
                showMessage(error.message, 'error');
            });
        }

        function searchUser() {
            const username = document.getElementById('username-search').value;
            const token = localStorage.getItem('token');
            
            if (!username) {
                showMessage('Please enter a username', 'error');
                return;
            }
            
            fetch('/api/users', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to load users');
                }
                return response.json();
            })
            .then(users => {
                const user = users.find(u => u.username === username);
                
                if (!user) {
                    showMessage('User not found', 'error');
                    return;
                }
                
                // Display user details
                document.getElementById('detail-username').textContent = user.username;
                document.getElementById('detail-role').textContent = user.role;
                document.getElementById('detail-joined').textContent = user.joined;
                document.getElementById('detail-status').textContent = user.blacklisted ? 'Blacklisted' : 'Active';
                document.getElementById('user-details').style.display = 'block';
                
                // Show appropriate button
                if (user.blacklisted) {
                    document.getElementById('blacklist-btn').style.display = 'none';
                    document.getElementById('unblacklist-btn').style.display = 'inline-block';
                } else {
                    document.getElementById('blacklist-btn').style.display = 'inline-block';
                    document.getElementById('unblacklist-btn').style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Error searching user:', error);
                showMessage(error.message, 'error');
            });
        }

        function toggleBlacklist() {
            const username = document.getElementById('username-search').value;
            const reason = document.getElementById('blacklist-reason').value;
            const token = localStorage.getItem('token');
            const isCurrentlyBlacklisted = document.getElementById('unblacklist-btn').style.display !== 'none';
            
            if (!username) {
                showMessage('Please select a user first', 'error');
                return;
            }
            
            if (!isCurrentlyBlacklisted && !reason) {
                showMessage('Please provide a reason for blacklisting', 'error');
                return;
            }
            
            fetch(`/api/users/${username}/blacklist`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    blacklisted: !isCurrentlyBlacklisted,
                    reason: reason
                })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { throw new Error(err.error); });
                }
                return response.json();
            })
            .then(data => {
                showMessage(data.message, 'success');
                // Refresh the user details
                searchUser();
                // Refresh the blacklist
                loadBlacklist();
            })
            .catch(error => {
                console.error('Error toggling blacklist:', error);
                showMessage(error.message, 'error');
            });
        }

        function loadBlacklist() {
            const token = localStorage.getItem('token');
            
            fetch('/api/blacklist', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to load blacklist');
                }
                return response.json();
            })
            .then(blacklist => {
                const container = document.getElementById('blacklist-container');
                container.innerHTML = '';
                
                if (Object.keys(blacklist).length === 0) {
                    container.innerHTML = '<p>No blacklisted users</p>';
                    return;
                }
                
                for (const username in blacklist) {
                    const item = document.createElement('div');
                    item.className = 'blacklist-item';
                    item.innerHTML = `
                        <strong>${username}</strong><br>
                        Reason: ${blacklist[username].reason}<br>
                        Blacklisted by: ${blacklist[username].blacklistedBy}<br>
                        Date: ${new Date(blacklist[username].blacklistedAt).toLocaleDateString()}
                    `;
                    container.appendChild(item);
                }
            })
            .catch(error => {
                console.error('Error loading blacklist:', error);
                showMessage(error.message, 'error');
            });
        }

        function loadAllUsers() {
            const token = localStorage.getItem('token');
            
            fetch('/api/users', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to load users');
                }
                return response.json();
            })
            .then(users => {
                const container = document.getElementById('users-container');
                container.innerHTML = '';
                
                users.forEach(user => {
                    const item = document.createElement('div');
                    item.className = 'blacklist-item';
                    item.innerHTML = `
                        <strong>${user.username}</strong> (${user.role})<br>
                        Joined: ${user.joined}<br>
                        Status: ${user.blacklisted ? 'Blacklisted' : 'Active'}
                    `;
                    container.appendChild(item);
                });
            })
            .catch(error => {
                console.error('Error loading all users:', error);
                showMessage(error.message, 'error');
            });
        }

        function showMessage(message, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = message;
            messageDiv.className = type;
            
            // Clear message after 5 seconds
            setTimeout(() => {
                messageDiv.textContent = '';
                messageDiv.className = '';
            }, 5000);
        }
    </script>
</body>
</html>
