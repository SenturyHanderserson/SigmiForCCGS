<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auto Clicker Pro</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio,line-clamp"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/feather-icons"></script>
    <style>
        body {
            font-family: 'Rajdhani', sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 25%, #16213e 50%, #0f3460 75%, #1a1a2e 100%);
            overflow-x: hidden;
            min-height: 100vh;
        }
        
        .glass-liquid {
            background: linear-gradient(135deg, 
                rgba(139, 92, 246, 0.15) 0%, 
                rgba(124, 58, 237, 0.2) 50%, 
                rgba(109, 40, 217, 0.15) 100%);
            backdrop-filter: blur(25px) saturate(180%);
            -webkit-backdrop-filter: blur(25px) saturate(180%);
            border: 1px solid rgba(192, 132, 252, 0.3);
            border-bottom: 2px solid rgba(192, 132, 252, 0.5);
            box-shadow: 
                0 8px 32px rgba(109, 40, 217, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.2),
                inset 0 -1px 0 rgba(0, 0, 0, 0.1);
        }
        
        .glass-card {
            background: linear-gradient(135deg, 
                rgba(139, 92, 246, 0.12) 0%, 
                rgba(124, 58, 237, 0.18) 100%);
            backdrop-filter: blur(20px) saturate(200%);
            -webkit-backdrop-filter: blur(20px) saturate(200%);
            border: 1px solid rgba(192, 132, 252, 0.25);
            box-shadow: 
                0 8px 32px rgba(109, 40, 217, 0.25),
                inset 0 1px 0 rgba(255, 255, 255, 0.15);
        }
        
        .liquid-glow {
            box-shadow: 
                0 0 25px rgba(192, 132, 252, 0.4),
                0 0 50px rgba(139, 92, 246, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }
        
        .neon-text {
            text-shadow: 0 0 10px rgba(192, 132, 252, 0.8),
                        0 0 20px rgba(192, 132, 252, 0.6),
                        0 0 30px rgba(192, 132, 252, 0.4);
        }
        
        .hover-lift:hover {
            transform: translateY(-5px);
            box-shadow: 
                0 15px 40px rgba(139, 92, 246, 0.4),
                0 0 30px rgba(192, 132, 252, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }
        
        .pulse-glow {
            animation: pulseGlow 3s ease-in-out infinite;
        }
        
        @keyframes pulseGlow {
            0%, 100% { 
                box-shadow: 
                    0 0 20px rgba(192, 132, 252, 0.3),
                    0 0 40px rgba(139, 92, 246, 0.2);
            }
            50% { 
                box-shadow: 
                    0 0 30px rgba(192, 132, 252, 0.6),
                    0 0 60px rgba(139, 92, 246, 0.3);
            }
        }
        
        .liquid-fill {
            background: linear-gradient(135deg, #7e22ce 0%, #c084fc 50%, #a855f7 100%);
            position: relative;
            overflow: hidden;
        }
        
        .cyber-grid {
            background-image: 
                linear-gradient(rgba(192, 132, 252, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(192, 132, 252, 0.05) 1px, transparent 1px);
            background-size: 50px 50px;
        }
        
        .download-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            transition: all 0.3s ease;
        }
        
        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(16, 185, 129, 0.4);
        }
        
        .slider::-webkit-slider-thumb {
            appearance: none;
            height: 25px;
            width: 25px;
            border-radius: 50%;
            background: linear-gradient(135deg, #c084fc, #7e22ce);
            border: 2px solid white;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(192, 132, 252, 0.8);
        }
        
        .float {
            animation: float 6s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(180deg); }
        }

        .mode-active {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 50%, #6d28d9 100%) !important;
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.6) !important;
        }
        
        .stop-btn {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 50%, #b45309 100%);
        }
        
        .top-bar {
            background: linear-gradient(135deg, rgba(30, 30, 60, 0.9) 0%, rgba(20, 20, 40, 0.95) 100%);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(192, 132, 252, 0.3);
        }
        
        .debug-btn {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 50%, #b45309 100%);
            transition: all 0.3s ease;
        }
        
        .debug-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(245, 158, 11, 0.4);
        }
        
        .btn-disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%) !important;
        }
        
        .btn-disabled:hover {
            transform: none !important;
            box-shadow: none !important;
        }
        
        .start-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        .btn-greyed {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%) !important;
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        .btn-greyed:hover {
            transform: none !important;
            box-shadow: none !important;
        }
        
        /* Theme Variables */
        body {
            --bg-primary: #1a0933;
            --bg-secondary: #3b1d6c;
            --bg-tertiary: #6e3b9c;
            --text-primary: #ffffff;
            --text-secondary: #d8d8d8;
            --accent-primary: #8e44ad;
            --accent-secondary: #6c5ce7;
            --glass-bg: rgba(92, 50, 168, 0.2);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        /* Theme Classes */
        .theme-dark {
            --bg-primary: #1a0933 !important;
            --bg-secondary: #3b1d6c !important;
            --bg-tertiary: #6e3b9c !important;
            --text-primary: #ffffff !important;
            --text-secondary: #d8d8d8 !important;
            --accent-primary: #8e44ad !important;
            --accent-secondary: #6c5ce7 !important;
            --glass-bg: rgba(92, 50, 168, 0.2) !important;
            --glass-border: rgba(255, 255, 255, 0.1) !important;
        }
        
        .theme-light {
            --bg-primary: #f8f9fa !important;
            --bg-secondary: #e9ecef !important;
            --bg-tertiary: #dee2e6 !important;
            --text-primary: #212529 !important;   
            --text-secondary: #495057 !important; 
            --accent-primary: #6f42c1 !important;
            --accent-secondary: #6610f2 !important;
            --glass-bg: rgba(255, 255, 255, 0.7) !important;
            --glass-border: rgba(0, 0, 0, 0.1) !important;
        }
        
        .theme-light p:not(.text-transparent),
        .theme-light span:not(.text-transparent),
        .theme-light h1:not(.text-transparent),
        .theme-light h2:not(.text-transparent),
        .theme-light h3:not(.text-transparent),
        .theme-light h4:not(.text-transparent),
        .theme-light h5:not(.text-transparent),
        .theme-light h6:not(.text-transparent),
        .theme-light li:not(.text-transparent),
        .theme-light a:not(.text-transparent),
        .theme-light div:not(.text-transparent) {
            color: var(--text-primary) !important;
        }
        
        .theme-light .text-secondary,
        .theme-light small,
        .theme-light .muted {
            color: var(--text-secondary) !important;
        }

        .theme-amoled {
            --bg-primary: #000000 !important;
            --bg-secondary: #111111 !important;
            --bg-tertiary: #222222 !important;
            --text-primary: #ffffff !important;
            --text-secondary: #cccccc !important;
            --accent-primary: #8e44ad !important;
            --accent-secondary: #9b59b6 !important;
            --glass-bg: rgba(0, 0, 0, 0.8) !important;
            --glass-border: rgba(255, 255, 255, 0.05) !important;
        }
        
        .theme-blue {
            --bg-primary: #0a1931 !important;
            --bg-secondary: #1a3c6e !important;
            --bg-tertiary: #2a5ca9 !important;
            --text-primary: #ffffff !important;
            --text-secondary: #d8d8d8 !important;
            --accent-primary: #2563eb !important;
            --accent-secondary: #3b82f6 !important;
            --glass-bg: rgba(37, 99, 235, 0.3) !important;
            --glass-border: rgba(255, 255, 255, 0.15) !important;
        }

        /* Message Styles */
        .message-container {
            position: fixed;
            top: 70px;
            left: 20px;
            z-index: 1001;
            width: 350px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .message-alert {
            background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            border-left: 4px solid #ff8c00;
            border-top: 1px solid rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
        }

        .message-entry {
            border-left: 3px solid var(--accent-primary);
        }

        /* Message Animation Styles */
        @keyframes slideInFromLeft {
            from {
                opacity: 0;
                transform: translateX(-50px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideOutToLeft {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(-100%);
            }
        }

        .message-slide-in {
            animation: slideInFromLeft 0.5s ease forwards;
        }

        .message-slide-out {
            animation: slideOutToLeft 0.5s ease forwards;
        }

        .broadcast-toast {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-width: 24rem;
        }
        
        /* Login Modal Styles */
        .login-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .login-modal.active {
            opacity: 1;
            visibility: visible;
        }
        
        .login-content {
            background: linear-gradient(135deg, var(--bg-tertiary) 0%, var(--bg-secondary) 50%, var(--bg-primary) 100%);
            border-radius: 16px;
            padding: 2rem;
            max-width: 400px;
            width: 90%;
            text-align: center;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }
        
        .login-modal.active .login-content {
            transform: scale(1);
        }
        
        .medal-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 1rem;
            background: linear-gradient(135deg, #FFD700 0%, #DAA520 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }
        
        /* Loading Overlay Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #fff;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none;
        }
        
        /* Notification Styles */
        .notification-container {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 1002;
            max-width: 350px;
        }
        
        .notification {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            margin-bottom: 10px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            animation: slideInFromRight 0.3s ease forwards;
        }
        
        .notification.success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }
        
        .notification.error {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }
        
        .notification.warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }
        
        .notification.info {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
        }
        
        .notification-icon {
            margin-right: 12px;
        }
        
        .notification-content {
            flex: 1;
        }
        
        .notification-close {
            margin-left: 12px;
            cursor: pointer;
            opacity: 0.8;
        }
        
        .notification-close:hover {
            opacity: 1;
        }
        
        @keyframes slideInFromRight {
            from {
                opacity: 0;
                transform: translateX(50px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
    </style>
</head>
<body class="text-white cyber-grid theme-dark">
    <!-- Login Modal -->
    <div id="loginModal" class="login-modal">
        <div class="login-content">
            <div class="medal-icon">
                <i data-feather="award" class="w-10 h-10 text-white"></i>
            </div>
            <h2 class="text-2xl font-bold mb-4">Authentication Required</h2>
            <p class="text-gray-300 mb-6">You need to be logged in to access all features. Sign in to continue.</p>
            <button onclick="redirectToLogin()" class="btn-primary py-3 px-6 rounded-lg font-medium w-full mb-4">
                Sign In
            </button>
            <button onclick="closeLoginModal()" class="py-2 px-4 rounded-lg border border-purple-700 text-purple-300 hover:bg-purple-800 hover:bg-opacity-50 transition w-full">
                Continue as Guest
            </button>
        </div>
    </div>

    <!-- Warning Modal -->
    <div id="warningModal" class="fixed inset-0 z-[2000] flex items-center justify-center bg-black bg-opacity-80 backdrop-blur-sm hidden">
        <div class="glass rounded-xl p-8 max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center">
                    <div class="medal-icon mr-3">
                        <i data-feather="alert-triangle" class="w-8 h-8 text-yellow-400"></i>
                    </div>
                    <h2 class="text-2xl font-bold" id="warningModalTitle">Warnings</h2>
                </div>
            </div>
            
            <div id="warningList" class="mb-6 max-h-60 overflow-y-auto space-y-3">
                <!-- Warnings will be dynamically populated here -->
            </div>
            
            <div class="flex justify-between items-center text-sm text-gray-400 mb-4">
                <span id="warningCount">0 active warnings</span>
                <button id="viewHistoryBtn" class="text-purple-300 hover:text-purple-100">
                    View History
                </button>
            </div>
            
            <div class="flex flex-col gap-3">
                <button id="dismissAllBtn" class="bg-red-600 hover:bg-red-700 py-3 px-6 rounded-lg font-medium">
                    Dismiss All Warnings
                </button>
                <button id="closeWarningBtn" class="bg-gray-600 hover:bg-gray-700 py-2 px-6 rounded-lg font-medium hidden">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Messages Container -->
    <div id="messageContainer" class="fixed top-20 left-4 z-[1001] w-80 max-h-[70vh] overflow-y-auto hidden">
        <div class="glass rounded-xl p-4 mb-3" id="messageHeader" style="display: none;">
            <div class="flex justify-between items-center mb-2">
                <h3 class="font-semibold">Messages</h3>
            </div>
        </div>
        <div id="messagesList"></div>
    </div>

    <!-- Broadcast Modal -->
    <div id="broadcastModal" class="fixed inset-0 z-[2000] flex items-center justify-center bg-black bg-opacity-80 backdrop-blur-sm hidden">
        <div class="glass rounded-xl p-6 max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center">
                    <div class="w-10 h-10 bg-yellow-500 rounded-full flex items-center justify-center mr-3">
                        <i data-feather="bell" class="w-5 h-5 text-white"></i>
                    </div>
                    <h2 class="text-xl font-bold">Announcement</h2>
                </div>
                <button onclick="dismissBroadcast()" class="p-1 rounded-full hover:bg-purple-700">
                    <i data-feather="x" class="w-5 h-5"></i>
                </button>
            </div>
            <p id="broadcastMessage" class="text-gray-300 mb-4"></p>
            <div class="flex justify-between items-center text-sm text-gray-400 mb-4">
                <span id="broadcastAuthor"></span>
                <span id="broadcastTime"></span>
            </div>
            <button onclick="dismissBroadcast()" class="btn-primary py-2 px-6 rounded-lg font-medium w-full">
                Acknowledge
            </button>
        </div>
    </div>

    <!-- Loading Overlay - For auto-login verification -->
    <div id="loadingOverlay" class="modal-overlay">
        <div class="glass rounded-xl p-8 max-w-md w-full mx-4 text-center">
            <div class="loading-spinner mb-4"></div>
            <h2 class="text-2xl font-bold mb-2">Verifying session...</h2>
            <p class="text-gray-300">Please wait while we verify your session</p>
        </div>
    </div>

    <!-- Top Bar -->
    <div class="top-bar fixed top-0 left-0 right-0 z-50">
        <div class="container mx-auto px-4 py-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2">
                        <div id="serviceStatus" class="w-2 h-2 bg-red-500 rounded-full"></div>
                        <span class="text-sm font-semibold">Auto Clicker Pro</span>
                    </div>
                    <div class="text-xs text-purple-300 opacity-75">
                        Hidden Background Service
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <button onclick="testWindowsKey()" 
                            class="px-3 py-1 debug-btn rounded-lg text-xs text-white font-semibold transition-colors">
                        <i class="fab fa-windows mr-1"></i>Test Win Key
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Animated Background Elements -->
    <div class="fixed inset-0 overflow-hidden pointer-events-none">
        <div class="absolute top-1/4 left-1/4 w-64 h-64 bg-purple-500/10 rounded-full blur-3xl float"></div>
        <div class="absolute top-3/4 right-1/4 w-96 h-96 bg-indigo-600/10 rounded-full blur-3xl float" style="animation-delay: 2s;"></div>
        <div class="absolute bottom-1/4 left-1/2 w-80 h-80 bg-violet-500/10 rounded-full blur-3xl float" style="animation-delay: 4s;"></div>
    </div>

    <div class="relative z-10 min-h-screen flex items-center justify-center p-4 pt-20">
        <div class="glass-liquid rounded-3xl p-8 max-w-4xl w-full liquid-glow">
            <!-- Connection Status -->
            <div id="connectionStatus" class="mb-6 p-4 rounded-2xl glass-card text-center">
                <div class="flex items-center justify-center space-x-3">
                    <div id="connectionDot" class="w-3 h-3 bg-red-500 rounded-full pulse-glow"></div>
                    <span id="connectionText" class="text-purple-200 font-semibold">Searching for Auto Clicker Backend...</span>
                </div>
            </div>

            <!-- Header -->
            <div class="text-center mb-12">
                <div class="flex items-center justify-center mb-6">
                    <div class="relative">
                        <div class="absolute inset-0 bg-purple-500/30 rounded-full blur-lg"></div>
                        <i class="fas fa-mouse-pointer text-5xl text-purple-300 relative z-10 mr-6"></i>
                    </div>
                    <h1 class="text-5xl font-bold font-['Orbitron']">
                        <span class="bg-gradient-to-r from-purple-300 via-purple-200 to-pink-300 bg-clip-text text-transparent">
                            AUTO CLICKER PRO
                        </span>
                    </h1>
                </div>
                <p class="text-purple-200 text-lg font-light">Hidden Service • Web Interface • Advanced Automation</p>
            </div>

            <!-- Download Section (Shows when backend not found) -->
            <div id="downloadSection" class="glass-card rounded-2xl p-6 mb-8 text-center hidden">
                <h2 class="text-2xl font-bold font-['Orbitron'] mb-4 text-purple-300">
                    <i class="fas fa-download mr-3"></i>
                    Download Required
                </h2>
                <p class="text-purple-200 mb-4">Auto Clicker backend not detected. Download and run the application to use this interface.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 max-w-2xl mx-auto">
                    <a href="https://github.com/SenturyHanderserson/SigmiForCCGS/raw/main/content/autoclicker_installer.bat" 
                       class="download-btn py-3 px-6 rounded-xl font-semibold text-white transition-all duration-300">
                        <i class="fas fa-windows mr-2"></i>
                        Windows Installer
                    </a>
                    <a href="https://github.com/SenturyHanderserson/SigmiForCCGS" 
                       class="liquid-fill py-3 px-6 rounded-xl font-semibold text-white transition-all duration-300 transform hover:scale-105">
                        <i class="fab fa-github mr-2"></i>
                        Source Code
                    </a>
                </div>
                <div class="mt-4 text-sm text-purple-300">
                    <p>After downloading, run the installer and start the application.</p>
                    <p>This interface will automatically connect to the backend.</p>
                </div>
            </div>

            <!-- Control Panel (Shows when backend connected) -->
            <div id="controlPanel" class="hidden">
                <!-- Status Display -->
                <div id="statusPanel" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
                    <div class="glass-card rounded-2xl p-6 text-center hover-lift transition-all duration-500">
                        <div id="statusIndicator" class="w-5 h-5 bg-red-500 rounded-full mx-auto mb-4 border-2 border-white/30"></div>
                        <p class="text-sm text-purple-300 font-semibold">STATUS</p>
                        <p id="statusText" class="text-2xl font-bold font-['Orbitron'] text-red-400">STOPPED</p>
                    </div>
                    <div class="glass-card rounded-2xl p-6 text-center hover-lift transition-all duration-500">
                        <div class="relative inline-block mb-4">
                            <div class="absolute inset-0 bg-yellow-400/20 rounded-full blur"></div>
                            <i class="fas fa-bolt text-2xl text-yellow-300 relative z-10"></i>
                        </div>
                        <p class="text-sm text-purple-300 font-semibold">ACTIONS</p>
                        <p id="actionCount" class="text-2xl font-bold font-['Orbitron'] text-yellow-300">0</p>
                    </div>
                    <div class="glass-card rounded-2xl p-6 text-center hover-lift transition-all duration-500">
                        <div class="relative inline-block mb-4">
                            <div class="absolute inset-0 bg-blue-400/20 rounded-full blur"></div>
                            <i class="fas fa-clock text-2xl text-cyan-300 relative z-10"></i>
                        </div>
                        <p class="text-sm text-purple-300 font-semibold">SESSION TIME</p>
                        <p id="sessionTime" class="text-2xl font-bold font-['Orbitron'] text-cyan-300">0s</p>
                    </div>
                </div>

                <!-- Control Panel -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Left Column - Controls -->
                    <div class="space-y-6">
                        <!-- Mode Selection -->
                        <div class="glass-card rounded-2xl p-6 hover-lift transition-all duration-500">
                            <h2 class="text-xl font-bold mb-4 flex items-center font-['Orbitron']">
                                <div class="relative mr-3">
                                    <div class="absolute inset-0 bg-purple-500/20 rounded-full blur"></div>
                                    <i class="fas fa-cog text-purple-300 relative z-10"></i>
                                </div>
                                CLICK MODE
                            </h2>
                            <div class="grid grid-cols-2 gap-3">
                                <button onclick="setMode('click')" class="mode-btn liquid-fill hover:brightness-110 py-3 px-4 rounded-xl font-semibold transition-all duration-300 transform hover:scale-105 border border-purple-400/30" data-mode="click">
                                    LEFT CLICK
                                </button>
                                <button onclick="setMode('right_click')" class="mode-btn liquid-fill hover:brightness-110 py-3 px-4 rounded-xl font-semibold transition-all duration-300 transform hover:scale-105 border border-purple-400/30" data-mode="right_click">
                                    RIGHT CLICK
                                </button>
                                <button onclick="setMode('space')" class="mode-btn liquid-fill hover:brightness-110 py-3 px-4 rounded-xl font-semibold transition-all duration-300 transform hover:scale-105 border border-purple-400/30" data-mode="space">
                                    SPACE BAR
                                </button>
                                <button onclick="setCustomKey()" class="mode-btn liquid-fill hover:brightness-110 py-3 px-4 rounded-xl font-semibold transition-all duration-300 transform hover:scale-105 border border-purple-400/30" data-mode="custom">
                                    CUSTOM KEY
                                </button>
                            </div>
                        </div>

                        <!-- Speed Control -->
                        <div class="glass-card rounded-2xl p-6 hover-lift transition-all duration-500">
                            <h2 class="text-xl font-bold mb-4 flex items-center font-['Orbitron']">
                                <div class="relative mr-3">
                                    <div class="absolute inset-0 bg-green-500/20 rounded-full blur"></div>
                                    <i class="fas fa-tachometer-alt text-green-300 relative z-10"></i>
                                </div>
                                SPEED CONTROL
                            </h2>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm text-purple-300 mb-3 font-semibold">CLICK INTERVAL: <span id="intervalValue" class="text-cyan-300">0.05</span>s</label>
                                    <input type="range" min="1" max="200" value="5" onchange="updateInterval(this.value)" 
                                           class="w-full h-3 bg-purple-900/50 rounded-2xl appearance-none cursor-pointer slider">
                                </div>
                                <div class="flex justify-between text-xs text-purple-400 font-semibold">
                                    <span>FASTER ←</span>
                                    <span>[0.005s - 2.0s]</span>
                                    <span>→ SLOWER</span>
                                </div>
                                <div class="text-xs text-purple-300 text-center">
                                    <span id="cpsValue">20 CPS</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column - Settings -->
                    <div class="space-y-6">
                        <!-- Behavior Settings -->
                        <div class="glass-card rounded-2xl p-6 hover-lift transition-all duration-500">
                            <h2 class="text-xl font-bold mb-4 flex items-center font-['Orbitron']">
                                <div class="relative mr-3">
                                    <div class="absolute inset-0 bg-blue-500/20 rounded-full blur"></div>
                                    <i class="fas fa-brain text-blue-300 relative z-10"></i>
                                </div>
                                HUMAN BEHAVIOR
                            </h2>
                            <div class="space-y-4">
                                <label class="flex items-center space-x-4 cursor-pointer group">
                                    <div class="relative">
                                        <input type="checkbox" id="jitterToggle" checked onchange="setJitter(this.checked)" 
                                               class="sr-only peer">
                                        <div class="w-12 h-6 bg-purple-900/50 rounded-full peer-checked:bg-purple-600 transition-all duration-300"></div>
                                        <div class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full transition-transform duration-300 peer-checked:translate-x-6"></div>
                                    </div>
                                    <span class="text-purple-200 font-semibold group-hover:text-white transition-colors">MOUSE JITTER</span>
                                </label>
                                <label class="flex items-center space-x-4 cursor-pointer group">
                                    <div class="relative">
                                        <input type="checkbox" id="humanLikeToggle" checked onchange="setHumanLike(this.checked)"
                                               class="sr-only peer">
                                        <div class="w-12 h-6 bg-purple-900/50 rounded-full peer-checked:bg-purple-600 transition-all duration-300"></div>
                                        <div class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full transition-transform duration-300 peer-checked:translate-x-6"></div>
                                    </div>
                                    <span class="text-purple-200 font-semibold group-hover:text-white transition-colors">RANDOM TIMING</span>
                                </label>
                            </div>
                        </div>

                        <!-- Main Control -->
                        <div class="glass-card rounded-2xl p-6 hover-lift transition-all duration-500">
                            <h2 class="text-xl font-bold mb-4 flex items-center font-['Orbitron']">
                                <div class="relative mr-3">
                                    <div class="absolute inset-0 bg-green-500/20 rounded-full blur"></div>
                                    <i class="fas fa-play-circle text-green-300 relative z-10"></i>
                                </div>
                                QUICK CONTROL
                            </h2>
                            <div class="space-y-4">
                                <button onclick="toggleAutoClicker()" id="toggleBtn"
                                        class="w-full start-btn hover:brightness-110 py-4 px-6 rounded-2xl font-bold text-lg font-['Orbitron'] transition-all duration-300 transform hover:scale-105 pulse-glow border border-green-400/30">
                                    <i class="fas fa-play mr-3"></i>
                                    START AUTO CLICKER (F6)
                                </button>
                                <button onclick="stopAutoClicker()" id="stopBtn"
                                        class="w-full stop-btn py-3 px-6 rounded-2xl font-bold font-['Orbitron'] transition-all duration-300 transform hover:scale-105 border border-yellow-400/30 btn-disabled">
                                    <i class="fas fa-stop mr-3"></i>
                                    STOP AUTO CLICKER
                                </button>
                            </div>
                        </div>

                        <!-- Debug Section -->
                        <div class="glass-card rounded-2xl p-6 hover-lift transition-all duration-500">
                            <h2 class="text-xl font-bold mb-4 flex items-center font-['Orbitron']">
                                <div class="relative mr-3">
                                    <div class="absolute inset-0 bg-orange-500/20 rounded-full blur"></div>
                                    <i class="fas fa-bug text-orange-300 relative z-10"></i>
                                </div>
                                DEBUG TOOLS
                            </h2>
                            <div class="space-y-3">
                                <button onclick="testWindowsKey()"
                                        class="w-full debug-btn py-3 px-6 rounded-xl font-semibold text-white transition-all duration-300 transform hover:scale-105">
                                    <i class="fab fa-windows mr-2"></i>
                                    TEST WINDOWS KEY
                                </button>
                                <button onclick="testSingleClick()"
                                        class="w-full bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-600 hover:to-cyan-600 py-3 px-6 rounded-xl font-semibold text-white transition-all duration-300 transform hover:scale-105">
                                    <i class="fas fa-mouse-pointer mr-2"></i>
                                    TEST SINGLE CLICK
                                </button>
                            </div>
                        </div>

                        <!-- Hotkeys Info -->
                        <div class="glass-card rounded-2xl p-6 hover-lift transition-all duration-500">
                            <h2 class="text-xl font-bold mb-4 flex items-center font-['Orbitron']">
                                <div class="relative mr-3">
                                    <div class="absolute inset-0 bg-yellow-500/20 rounded-full blur"></div>
                                    <i class="fas fa-keyboard text-yellow-300 relative z-10"></i>
                                </div>
                                HOTKEYS
                            </h2>
                            <div class="space-y-3 text-sm">
                                <div class="flex justify-between items-center">
                                    <span class="text-purple-200 font-semibold">Toggle Start/Stop:</span>
                                    <kbd class="px-3 py-1 bg-purple-600 rounded-lg font-mono font-bold border border-purple-400/30">F6</kbd>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="mt-8 text-center">
                <div class="glass-card rounded-2xl p-4 inline-block">
                    <p class="text-purple-300 font-semibold">Auto Clicker Pro • Hidden Service • Web Interface</p>
                    <p class="text-purple-400 text-sm mt-1" id="connectionInfo">Checking connection...</p>
                </div>
            </div>
        </div>
    </div>

<script>
// Global variables for broadcast, warning, and message systems
let userWarnings = [];
let activeBroadcasts = [];
let broadcastCheckInterval = null;
let warningCheckInterval = null;
const SERVER_URL = 'https://proxyforsigmi.onrender.com';

// Auto-clicker variables
let isConnected = false;
let currentStatus = {};
let connectionAttempts = 0;
let isRunning = false;
let connectionCheckInterval;
let websocket = null;
let reconnectTimeout = null;

// Cookie management functions
function getCookie(name) {
    const cookieName = name + "=";
    const decodedCookie = decodeURIComponent(document.cookie);
    const cookieArray = decodedCookie.split(';');
    
    for(let i = 0; i < cookieArray.length; i++) {
        let cookie = cookieArray[i];
        while (cookie.charAt(0) === ' ') {
            cookie = cookie.substring(1);
        }
        if (cookie.indexOf(cookieName) === 0) {
            return cookie.substring(cookieName.length, cookie.length);
        }
    }
    return "";
}

function setCookie(name, value, days) {
    const date = new Date();
    date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
    const expires = "expires=" + date.toUTCString();
    document.cookie = name + "=" + value + ";" + expires + ";path=/";
}

// Theme management
function getTheme() {
    const preferences = JSON.parse(getCookie('UserPreferences') || '{}');
    return preferences.theme || 'dark';
}

function setTheme(theme) {
    // Update the theme class on body
    document.body.className = document.body.className.replace(/\btheme-\w+/g, '');
    document.body.classList.add(`theme-${theme}`);
    
    // Save to preferences
    const preferences = JSON.parse(getCookie('UserPreferences') || '{}');
    preferences.theme = theme;
    setCookie('UserPreferences', JSON.stringify(preferences), 365);
}

function applyThemeOnLoad() {
    const theme = getTheme();
    setTheme(theme);
}

// Authentication functions
function isLoggedIn() {
    const token = getCookie('AuthToken');
    const currentUser = localStorage.getItem('currentUser');
    return !!(token && currentUser);
}

async function verifyToken(token) {
    try {
        const response = await fetch('https://proxyforsigmi.onrender.com/api/verify-token', {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            return false;
        }
        
        const data = await response.json();
        return data.valid === true;
    } catch (error) {
        console.error('Token verification error:', error);
        return false;
    }
}

// Show login modal function
function showLoginModal() {
    document.getElementById('loginModal').classList.add('active');
}

// Close login modal function
function closeLoginModal() {
    document.getElementById('loginModal').classList.remove('active');
}

// Redirect to login page
function redirectToLogin() {
    window.location.href = 'https://senturyhanderserson.github.io/SigmiForCCGS/';
}

// Notification system
function showNotification(message, type = "info", duration = 3000) {
    // Create notification container if it doesn't exist
    let container = document.getElementById('notificationContainer');
    if (!container) {
        container = document.createElement('div');
        container.id = 'notificationContainer';
        container.className = 'notification-container';
        document.body.appendChild(container);
    }
    
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;	
    
    let icon = 'info';
    if (type === 'success') icon = 'check-circle';
    if (type === 'error') icon = 'alert-triangle';
    if (type === 'warning') icon = 'alert-circle';
    
    notification.innerHTML = `
        <div class="notification-icon">
            <i data-feather="${icon}"></i>
        </div>
        <div class="notification-content">
            ${message}
        </div>
        <div class="notification-close" onclick="this.parentElement.remove()">
            <i data-feather="x"></i>
        </div>
    `;
    
    container.appendChild(notification);
    feather.replace();
    
    setTimeout(() => {
        notification.remove();
    }, duration);
}

// Broadcast System Functions
async function checkForBroadcasts() {
    try {
        const token = getCookie('AuthToken');
        if (!token) return;
        
        const response = await fetch(`${SERVER_URL}/api/broadcasts`, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error('Failed to fetch broadcasts');
        }
        
        const data = await response.json();
        
        if (data.success && data.broadcasts.length > 0) {
            const dismissedBroadcasts = JSON.parse(localStorage.getItem('dismissedBroadcasts') || '[]');
            
            data.broadcasts.forEach(broadcast => {
                if (!dismissedBroadcasts.includes(broadcast.id) && 
                    !activeBroadcasts.some(ab => ab.id === broadcast.id)) {
                    activeBroadcasts.push(broadcast);
                    showBroadcastToast(broadcast);
                }
            });
        }
    } catch (error) {
        console.error('Error checking for broadcasts:', error);
    }
}

function createBroadcastToastContainer() {
    const container = document.createElement('div');
    container.id = 'broadcastToastContainer';
    container.className = 'fixed bottom-4 right-4 z-[1000] max-w-md';
    document.body.appendChild(container);
    return container;
}

function showBroadcastToast(broadcast) {
    const toastContainer = document.getElementById('broadcastToastContainer') || createBroadcastToastContainer();
    
    const toast = document.createElement('div');
    toast.className = 'broadcast-toast glass p-4 rounded-lg mb-2 transform translate-y-20 transition-transform duration-300';
    toast.dataset.broadcastId = broadcast.id;
    
    toast.innerHTML = `
        <div class="flex items-start">
            <div class="mr-3 mt-0.5">
                <i data-feather="bell" class="w-5 h-5 text-yellow-400"></i>
            </div>
            <div class="flex-1">
                <h3 class="font-semibold mb-1">New Announcement</h3>
                <p class="text-sm text-gray-300">${truncateText(broadcast.message, 100)}</p>
            </div>
            <button onclick="hideBroadcastToast('${broadcast.id}')" class="ml-3 text-gray-400 hover:text-white">
                <i data-feather="x" class="w-4 h-4"></i>
            </button>
        </div>
        <div class="mt-2 flex justify-end">
            <button onclick="showBroadcastModal('${broadcast.id}')" class="text-sm text-purple-300 hover:text-purple-100 mr-3">
                View Details
            </button>
            <button onclick="dismissBroadcast('${broadcast.id}')" class="text-sm text-gray-400 hover:text-white">
                Dismiss
            </button>
        </div>
    `;
    
    toastContainer.appendChild(toast);
    feather.replace();
    
    setTimeout(() => {
        toast.classList.remove('translate-y-20');
        toast.classList.add('translate-y-0');
    }, 100);
    
    setTimeout(() => {
        hideBroadcastToast(broadcast.id);
    }, 15000);
}

function hideBroadcastToast(broadcastId) {
    const toast = document.querySelector(`.broadcast-toast[data-broadcast-id="${broadcastId}"]`);
    if (toast) {
        toast.classList.remove('translate-y-0');
        toast.classList.add('translate-y-20');
        
        setTimeout(() => {
            toast.remove();
            activeBroadcasts = activeBroadcasts.filter(b => b.id !== broadcastId);
        }, 300);
    }
}

function showBroadcastModal(broadcastId) {
    const broadcast = activeBroadcasts.find(b => b.id === broadcastId);
    if (!broadcast) return;
    
    const modal = document.getElementById('broadcastModal');
    const message = document.getElementById('broadcastMessage');
    const author = document.getElementById('broadcastAuthor');
    const time = document.getElementById('broadcastTime');
    
    message.textContent = broadcast.message;
    author.textContent = `From: ${broadcast.createdBy}`;
    time.textContent = formatTime(new Date(broadcast.createdAt));
    
    modal.dataset.broadcastId = broadcastId;
    modal.classList.remove('hidden');
    
    hideBroadcastToast(broadcastId);
}

async function dismissBroadcast(broadcastId) {
    try {
        const token = getCookie('AuthToken');
        if (token) {
            await fetch(`${SERVER_URL}/api/broadcasts/${broadcastId}/dismiss`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
        }
        
        const dismissedBroadcasts = JSON.parse(localStorage.getItem('dismissedBroadcasts') || '[]');
        if (!dismissedBroadcasts.includes(broadcastId)) {
            dismissedBroadcasts.push(broadcastId);
            localStorage.setItem('dismissedBroadcasts', JSON.stringify(dismissedBroadcasts));
        }
        
        const modal = document.getElementById('broadcastModal');
        if (modal.dataset.broadcastId === broadcastId) {
            modal.classList.add('hidden');
        }
        
        hideBroadcastToast(broadcastId);
        
    } catch (error) {
        console.error('Error dismissing broadcast:', error);
    }
}

// Warning System Functions
async function checkForWarnings() {
    try {
        const token = getCookie('AuthToken');
        if (!token) return;
        
        const response = await fetch(`${SERVER_URL}/api/check-warnings`, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            userWarnings = data.warnings || [];
            
            if (data.hasWarnings && userWarnings.length > 0) {
                showWarningModal(userWarnings);
            }
        }
    } catch (error) {
        console.error('Error checking for warnings:', error);
    }
}

async function dismissWarning(warningId) {
    try {
        const token = getCookie('AuthToken');
        if (!token) {
            showNotification('Authentication required', 'error');
            return false;
        }
        
        const response = await fetch(`${SERVER_URL}/api/warnings/${warningId}/dismiss`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            
            const warningIndex = userWarnings.findIndex(w => w.id === warningId);
            if (warningIndex !== -1) {
                userWarnings[warningIndex] = {
                    ...userWarnings[warningIndex],
                    dismissed: true,
                    dismissedAt: data.warning.dismissedAt,
                    dismissedBy: data.warning.dismissedBy
                };
            }
            
            showWarningModal(userWarnings);
            showNotification(data.message || 'Warning dismissed successfully', 'success');
            return true;
        } else {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Failed to dismiss warning');
        }
    } catch (error) {
        console.error('Error dismissing warning:', error);
        showNotification(error.message || 'Failed to dismiss warning', 'error');
        return false;
    }
}

function showWarningModal(warnings) {
    const modal = document.getElementById('warningModal');
    const warningList = document.getElementById('warningList');
    const warningCount = document.getElementById('warningCount');
    const modalTitle = document.getElementById('warningModalTitle');
    const closeWarningBtn = document.getElementById('closeWarningBtn');
    const dismissAllBtn = document.getElementById('dismissAllBtn');
    
    warningList.innerHTML = '';
    
    const activeWarnings = warnings.filter(w => !w.dismissed);
    
    warningCount.textContent = `${activeWarnings.length} active warning${activeWarnings.length !== 1 ? 's' : ''}`;
    modalTitle.textContent = `Warnings (${activeWarnings.length})`;
    
    if (activeWarnings.length === 0) {
        dismissAllBtn.classList.add('hidden');
        closeWarningBtn.classList.remove('hidden');
    } else {
        dismissAllBtn.classList.remove('hidden');
        closeWarningBtn.classList.add('hidden');
    }
    
    activeWarnings.forEach((warning, index) => {
        const warningElement = document.createElement('div');
        warningElement.className = 'p-3 rounded-lg bg-red-900 bg-opacity-30 border border-red-700 mb-3';
        warningElement.innerHTML = `
            <div class="flex justify-between items-start mb-2">
                <span class="font-medium">Warning #${index + 1}</span>
                <span class="text-xs px-2 py-1 bg-red-700 rounded">Active</span>
            </div>
            <p class="text-sm mb-2">${warning.reason}</p>
            <div class="flex justify-between items-center text-xs text-gray-400">
                <span>By: ${warning.issuedBy}</span>
                <span>${new Date(warning.issuedAt).toLocaleDateString()}</span>
            </div>
            <button onclick="dismissWarning('${warning.id}')" class="w-full mt-2 py-2 bg-red-700 hover:bg-red-600 rounded text-sm font-medium">
                Dismiss This Warning
            </button>
        `;
        warningList.appendChild(warningElement);
    });
    
    if (activeWarnings.length === 0) {
        warningList.innerHTML = `
            <div class="text-center py-4">
                <i data-feather="check-circle" class="w-12 h-12 text-green-400 mx-auto mb-2"></i>
                <p class="text-green-300 font-medium">All warnings have been dismissed</p>
                <p class="text-gray-400 text-sm mt-1">You can now close this window</p>
            </div>
        `;
    }
    
    modal.classList.remove('hidden');
    feather.replace();
}

async function dismissAllWarnings() {
    try {
        const token = getCookie('AuthToken');
        if (!token) {
            showNotification('Authentication required', 'error');
            return;
        }
        
        const activeWarnings = userWarnings.filter(w => !w.dismissed);
        if (activeWarnings.length === 0) {
            showNotification('No active warnings to dismiss', 'info');
            return;
        }
        
        const response = await fetch(`${SERVER_URL}/api/warnings/dismiss-all`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            
            userWarnings.forEach(warning => {
                if (!warning.dismissed) {
                    warning.dismissed = true;
                    warning.dismissedAt = new Date().toISOString();
                    warning.dismissedBy = localStorage.getItem('currentUser');
                }
            });
            
            showWarningModal(userWarnings);
            showNotification(data.message || `Dismissed ${data.dismissedCount} warning(s)`, 'success');
            
        } else {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Failed to dismiss warnings');
        }
    } catch (error) {
        console.error('Error dismissing all warnings:', error);
        showNotification(error.message || 'Failed to dismiss all warnings', 'error');
    }
}

function closeWarningModal() {
    const activeWarnings = userWarnings.filter(w => !w.dismissed);
    
    if (activeWarnings.length === 0) {
        document.getElementById('warningModal').classList.add('hidden');
        showNotification('Warning modal closed', 'info');
    } else {
        showNotification(`You still have ${activeWarnings.length} active warning(s) to dismiss`, 'warning');
    }
}

async function viewWarningHistory() {
    try {
        const token = getCookie('AuthToken');
        if (!token) return;
        
        const response = await fetch(`${SERVER_URL}/api/warnings/history`, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            showWarningHistoryModal(data.warnings);
        }
    } catch (error) {
        console.error('Error fetching warning history:', error);
        showNotification('Failed to load warning history', 'error');
    }
}

function showWarningHistoryModal(warnings) {
    const activeWarningsBefore = userWarnings.filter(w => !w.dismissed).length;
    
    const historyHTML = `
        <div id="warningHistoryModal" class="fixed inset-0 z-[2001] flex items-center justify-center bg-black bg-opacity-80 backdrop-blur-sm">
            <div class="glass rounded-xl p-8 max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Warning History</h2>
                    <button onclick="closeHistoryModal(${activeWarningsBefore})" class="p-1 rounded-full hover:bg-purple-700">
                        <i data-feather="x" class="w-5 h-5"></i>
                    </button>
                </div>
                <div class="space-y-4">
                    ${warnings.length > 0 ? warnings.map(warning => `
                        <div class="p-4 rounded-lg ${warning.dismissed ? 'bg-green-900 bg-opacity-30' : 'bg-red-900 bg-opacity-30'}">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="font-medium">${warning.reason}</p>
                                    <p class="text-sm text-gray-400 mt-1">
                                        Issued by ${warning.issuedBy} on ${new Date(warning.issuedAt).toLocaleDateString()}
                                        ${warning.dismissedAt ? `<br>Dismissed on ${new Date(warning.dismissedAt).toLocaleDateString()} by ${warning.dismissedBy}` : ''}
                                    </p>
                                </div>
                                <span class="px-2 py-1 rounded text-xs ${warning.dismissed ? 'bg-green-700' : 'bg-red-700'}">
                                    ${warning.dismissed ? 'Dismissed' : 'Active'}
                                </span>
                            </div>
                            ${!warning.dismissed ? `
                                <button onclick="dismissWarning('${warning.id}')" class="w-full mt-2 py-2 bg-red-700 hover:bg-red-600 rounded text-sm">
                                    Dismiss This Warning
                                </button>
                            ` : ''}
                        </div>
                    `).join('') : '<p class="text-gray-400 text-center py-8">No warning history found</p>'}
                </div>
            </div>
        </div>
    `;
    
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = historyHTML;
    document.body.appendChild(tempDiv);
    feather.replace();
}

function closeHistoryModal(activeWarningsBefore) {
    const historyModal = document.getElementById('warningHistoryModal');
    if (historyModal) {
        historyModal.remove();
    }
    
    const activeWarningsNow = userWarnings.filter(w => !w.dismissed).length;
    
    if (activeWarningsNow > 0 && activeWarningsNow === activeWarningsBefore) {
        setTimeout(() => {
            showWarningModal(userWarnings);
        }, 300);
    }
}

// Message System Functions
async function loadMessages() {
    try {
        const token = getCookie('AuthToken');
        if (!token) return;
        
        const response = await fetch(`${SERVER_URL}/api/messages`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            displayMessages(data.messages);
        }
    } catch (error) {
        console.error('Error loading messages:', error);
    }
}

function displayMessages(messages) {
    const container = document.getElementById('messageContainer');
    const messagesList = document.getElementById('messagesList');
    const messageHeader = document.getElementById('messageHeader');
    
    messagesList.innerHTML = '';
    
    if (!messages || messages.length === 0) {
        container.classList.add('hidden');
        messageHeader.style.display = 'none';
        return;
    }
    
    container.classList.remove('hidden');
    messageHeader.style.display = 'block';
    
    messages.forEach((message, index) => {
        setTimeout(() => {
            const messageElement = createMessageElement(message);
            messagesList.appendChild(messageElement);
        }, index * 100);
    });
    
    feather.replace();
}

function createMessageElement(message) {
    const messageDiv = document.createElement('div');
    messageDiv.className = 'glass rounded-lg p-4 mb-3 message-entry';
    messageDiv.style.animation = 'slideInLeft 0.3s ease-out';
    messageDiv.id = `message-${message.id}`;
    
    const timeAgo = getTimeAgo(message.createdAt);
    
    messageDiv.innerHTML = `
        <div class="flex justify-between items-start mb-2">
            <div class="flex items-center">
                <i data-feather="mail" class="w-4 h-4 mr-2 text-purple-400"></i>
                <span class="font-medium text-sm">${escapeHtml(message.from)}</span>
            </div>
            <span class="text-xs text-gray-400">${timeAgo}</span>
        </div>
        <p class="text-sm text-gray-300 mb-3">${escapeHtml(message.message)}</p>
        <div class="flex justify-end">
            <button onclick="dismissMessage('${message.id}')" 
                    class="text-xs bg-purple-600 hover:bg-purple-700 px-3 py-1 rounded transition-colors">
                Dismiss
            </button>
        </div>
    `;
    
    return messageDiv;
}

async function dismissMessage(messageId) {
    try {
        const token = getCookie('AuthToken');
        if (!token) {
            showNotification('Authentication required', 'error');
            return;
        }
        
        const response = await fetch(`${SERVER_URL}/api/messages/${messageId}/dismiss`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            const messageElement = document.getElementById(`message-${messageId}`);
            if (messageElement) {
                messageElement.style.animation = 'slideOutLeft 0.3s ease-in';
                setTimeout(() => {
                    messageElement.remove();
                    checkRemainingMessages();
                }, 300);
            }
            showNotification('Message dismissed', 'success');
        } else {
            showNotification('Failed to dismiss message', 'error');
        }
    } catch (error) {
        console.error('Error dismissing message:', error);
        showNotification('Error dismissing message', 'error');
    }
}

function checkRemainingMessages() {
    const messagesList = document.getElementById('messagesList');
    const messageHeader = document.getElementById('messageHeader');
    const container = document.getElementById('messageContainer');
    
    if (messagesList.children.length === 0) {
        container.classList.add('hidden');
        messageHeader.style.display = 'none';
    }
}

function getTimeAgo(timestamp) {
    const now = new Date();
    const messageTime = new Date(timestamp);
    const diffInSeconds = Math.floor((now - messageTime) / 1000);
    
    if (diffInSeconds < 60) return 'just now';
    if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m ago`;
    if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}h ago`;
    return `${Math.floor(diffInSeconds / 86400)}d ago`;
}

function escapeHtml(unsafe) {
    return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}

function initMessageSystem() {
    setTimeout(loadMessages, 1000);
    setInterval(loadMessages, 3 * 60 * 1000);
}

// Helper functions
function truncateText(text, maxLength) {
    if (text.length <= maxLength) return text;
    return text.substr(0, maxLength) + '...';
}

function formatTime(date) {
    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}

// Auto-clicker functionality
function connectWebSocket() {
    if (websocket) {
        websocket.close();
    }
    
    websocket = new WebSocket('ws://localhost:8081');
    
    websocket.onopen = function(event) {
        console.log('🔌 WebSocket connected');
        showNotification('✅ Real-time connection established', 'success');
        document.getElementById('connectionDot').className = 'w-3 h-3 bg-green-500 rounded-full pulse-glow';
        document.getElementById('connectionText').textContent = 'Real-time Connection Active';
        document.getElementById('connectionText').className = 'text-green-300 font-semibold';
    };
    
    websocket.onmessage = function(event) {
        const data = JSON.parse(event.data);
        if (data.type === 'status') {
            currentStatus = data.data;
            updateUI();
        }
    };
    
    websocket.onclose = function(event) {
        console.log('🔌 WebSocket disconnected');
        if (isConnected) {
            showNotification('⚠️ Real-time connection lost, switching to polling', 'error');
            startPolling();
        }
        // Attempt reconnect after 2 seconds
        reconnectTimeout = setTimeout(connectWebSocket, 2000);
    };
    
    websocket.onerror = function(error) {
        console.error('❌ WebSocket error:', error);
        if (!isConnected) {
            startPolling();
        }
    };
}

function startPolling() {
    console.log('🔄 Starting polling fallback');
    if (connectionCheckInterval) {
        clearInterval(connectionCheckInterval);
    }
    connectionCheckInterval = setInterval(checkBackendConnection, 500);
}

async function checkBackendConnection() {
    try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 1000);
        
        const res = await fetch("http://localhost:8080/status.json?" + Date.now(), {
            signal: controller.signal,
            cache: 'no-store'
        });
        
        clearTimeout(timeoutId);
        
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        
        const newStatus = await res.json();
        currentStatus = newStatus;
        connectionAttempts = 0;
        
        if (!isConnected) {
            isConnected = true;
            showConnectedUI();
            showNotification("✅ Connected to Auto Clicker backend", "success");
        }
        
        updateUI();
        
    } catch (err) {
        connectionAttempts++;
        
        if (isConnected || connectionAttempts === 1) {
            console.warn("❌ Backend connection failed:", err.message);
        }
        
        if (isConnected) {
            isConnected = false;
            showDisconnectedUI();
            if (connectionAttempts > 1) {
                showNotification("❌ Lost connection to backend", "error");
            }
        }
        
        // Show download section if not connected
        document.getElementById('downloadSection').classList.remove('hidden');
        document.getElementById('controlPanel').classList.add('hidden');
    }
}

function showConnectedUI() {
    console.log("✅ Connected to backend - updating UI");
    
    document.getElementById('connectionDot').className = 'w-3 h-3 bg-green-500 rounded-full pulse-glow';
    document.getElementById('connectionText').textContent = 'Connected to Auto Clicker Backend';
    document.getElementById('connectionText').className = 'text-green-300 font-semibold';
    document.getElementById('connectionInfo').textContent = 'Connected • Backend Active';
    document.getElementById('serviceStatus').className = 'w-2 h-2 bg-green-500 rounded-full';
    
    document.getElementById('downloadSection').classList.add('hidden');
    document.getElementById('controlPanel').classList.remove('hidden');
}

function showDisconnectedUI() {
    console.log("❌ Disconnected from backend - updating UI");
    
    document.getElementById('connectionDot').className = 'w-3 h-3 bg-red-500 rounded-full pulse-glow';
    document.getElementById('connectionText').textContent = 'Searching for Auto Clicker Backend...';
    document.getElementById('connectionText').className = 'text-red-300 font-semibold';
    document.getElementById('connectionInfo').textContent = 'Disconnected • Check if backend is running';
    document.getElementById('serviceStatus').className = 'w-2 h-2 bg-red-500 rounded-full';
    
    document.getElementById('downloadSection').classList.remove('hidden');
    document.getElementById('controlPanel').classList.add('hidden');
}

function updateUI() {
    if (!isConnected) return;
    
    console.log("🔄 Updating UI with status:", currentStatus);
    
    // Update running state
    isRunning = currentStatus.running;
    
    // Update status display
    document.getElementById('intervalValue').textContent = Number(currentStatus.interval).toFixed(3);
    document.getElementById('statusText').textContent = isRunning ? "RUNNING" : "STOPPED";
    document.getElementById('statusText').className = `text-2xl font-bold font-['Orbitron'] ${
        isRunning ? 'text-green-400' : 'text-red-400'
    }`;
    document.getElementById('statusIndicator').className = `w-5 h-5 rounded-full mx-auto mb-4 border-2 border-white/30 ${
        isRunning ? 'bg-green-500' : 'bg-red-500'
    }`;
    
    document.getElementById('actionCount').textContent = currentStatus.actions;
    document.getElementById('sessionTime').textContent = currentStatus.session_time + "s";

    // Update toggles
    document.getElementById('jitterToggle').checked = currentStatus.jitter_enabled;
    document.getElementById('humanLikeToggle').checked = currentStatus.human_like;

    // Update active mode
    document.querySelectorAll(".mode-btn").forEach(btn => {
        btn.classList.remove("mode-active");
        if (btn.dataset.mode === currentStatus.mode) {
            btn.classList.add("mode-active");
        }
    });

    // Update button states
    updateButtonStates();
    
    // Update CPS display
    updateCPSDisplay();
    
    // Update slider position
    updateSliderPosition();
}

function updateButtonStates() {
    const toggleBtn = document.getElementById('toggleBtn');
    const stopBtn = document.getElementById('stopBtn');
    
    if (isRunning) {
        // When running: grey out start button, enable stop button
        toggleBtn.innerHTML = '<i class="fas fa-play mr-3"></i>START AUTO CLICKER (F6)';
        toggleBtn.classList.remove('start-btn', 'pulse-glow');
        toggleBtn.classList.add('btn-greyed');
        toggleBtn.style.borderColor = 'rgba(107, 114, 128, 0.3)';
        
        stopBtn.classList.remove('btn-disabled');
        stopBtn.classList.add('stop-btn');
    } else {
        // When stopped: enable start button, grey out stop button
        toggleBtn.innerHTML = '<i class="fas fa-play mr-3"></i>START AUTO CLICKER (F6)';
        toggleBtn.classList.remove('btn-greyed');
        toggleBtn.classList.add('start-btn', 'pulse-glow');
        toggleBtn.style.borderColor = 'rgba(34, 197, 94, 0.3)';
        
        stopBtn.classList.remove('stop-btn');
        stopBtn.classList.add('btn-disabled');
    }
}

function updateCPSDisplay() {
    const interval = currentStatus.interval;
    const cps = interval > 0 ? (1 / interval).toFixed(1) : "∞";
    document.getElementById('cpsValue').textContent = `${cps} CPS`;
}

function updateSliderPosition() {
    const interval = currentStatus.interval;
    const sliderValue = Math.max(1, Math.min(200, Math.round(interval * 100)));
    document.querySelector('.slider').value = sliderValue;
}

async function sendCommand(command, extra = {}) {
    if (!isConnected) {
        showNotification("⚠️ Not connected to backend. Please check if the Auto Clicker application is running.", "error");
        console.warn("⚠️ Not connected, skipping command:", command);
        return null;
    }
    
    console.log("📤 Sending command:", command, extra);
    
    try {
        const response = await fetch("http://localhost:8080/command", {
            method: "POST",
            headers: { 
                "Content-Type": "application/json",
                "Accept": "application/json"
            },
            body: JSON.stringify({ command, ...extra })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        console.log("📥 Command response:", data);
        
        return data;
        
    } catch (err) {
        console.error("❌ Command failed:", err);
        showNotification(`❌ Command failed: ${err.message}`, "error");
        return null;
    }
}

// Command functions
function toggleAutoClicker() { 
    sendCommand("toggle_running"); 
}

function stopAutoClicker() { 
    if (isRunning) {
        sendCommand("toggle_running");
    }
}

function setMode(m) { 
    sendCommand("set_mode", { mode: m }); 
}

function updateInterval(sliderValue) {
    const interval = Math.max(0.005, sliderValue / 100);
    document.getElementById('intervalValue').textContent = interval.toFixed(3);
    updateCPSDisplay();
    sendCommand("set_interval", { interval: interval });
}

function setJitter(e) { 
    sendCommand("set_jitter", { enabled: e }); 
}

function setHumanLike(e) { 
    sendCommand("set_human_like", { enabled: e }); 
}

function setCustomKey() {
    const k = prompt("Enter custom key (e.g., 'a', 'enter', 'space'):");
    if (k) sendCommand("set_custom_key", { key: k });
}

// Debug functions
async function testWindowsKey() {
    console.log("🪟 Testing Windows key press...");
    const result = await sendCommand("debug_windows_key");
    if (result && result.status === "ok") {
        showNotification("✅ Windows key pressed successfully!", "success");
    } else {
        showNotification("❌ Failed to press Windows key", "error");
    }
}

async function testSingleClick() {
    console.log("🖱️ Testing single click...");
    const result = await sendCommand("debug_single_click");
    if (result && result.status === "ok") {
        showNotification("✅ Single click performed!", "success");
    } else {
        showNotification("❌ Failed to perform click", "error");
    }
}

// Initialize everything when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    // Initialize authentication
    const token = getCookie('AuthToken');
    const currentUser = localStorage.getItem('currentUser');
    
    if (token && currentUser) {
        document.getElementById('loadingOverlay').classList.add('active');
        
        verifyToken(token).then(isValid => {
            document.getElementById('loadingOverlay').classList.remove('active');
            if (isValid) {
                // Initialize all systems after successful authentication
                initMessageSystem();
                checkForBroadcasts();
                checkForWarnings();
                
                // Set up periodic checking
                broadcastCheckInterval = setInterval(checkForBroadcasts, 2 * 60 * 1000);
                warningCheckInterval = setInterval(checkForWarnings, 5 * 60 * 1000);
            } else {
                showLoginModal();
            }
        }).catch(error => {
            console.error('Token verification failed:', error);
            document.getElementById('loadingOverlay').classList.remove('active');
            showLoginModal();
        });
    } else {
        setTimeout(showLoginModal, 1000);
    }
    
    // Apply theme
    applyThemeOnLoad();
    
    // Initialize auto-clicker connection
    console.log("🚀 Auto Clicker Pro Web Interface starting...");
    connectWebSocket();
    setTimeout(checkBackendConnection, 100);
    
    // Initialize Feather Icons
    feather.replace();
    
    // Add event listeners for warning system
    document.addEventListener('click', function(e) {
        if (e.target.id === 'viewHistoryBtn' || e.target.closest('#viewHistoryBtn')) {
            viewWarningHistory();
        }
        
        if (e.target.id === 'dismissAllBtn' || e.target.closest('#dismissAllBtn')) {
            dismissAllWarnings();
        }
        
        if (e.target.id === 'closeWarningBtn' || e.target.closest('#closeWarningBtn')) {
            closeWarningModal();
        }
    });
});

// Clean up on page unload
window.addEventListener('beforeunload', () => {
    if (connectionCheckInterval) {
        clearInterval(connectionCheckInterval);
    }
    if (websocket) {
        websocket.close();
    }
    if (reconnectTimeout) {
        clearTimeout(reconnectTimeout);
    }
    if (broadcastCheckInterval) {
        clearInterval(broadcastCheckInterval);
    }
    if (warningCheckInterval) {
        clearInterval(warningCheckInterval);
    }
});
</script>

</body>
</html>
