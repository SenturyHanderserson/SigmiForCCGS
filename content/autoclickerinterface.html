<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auto Clicker Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Rajdhani', sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 25%, #16213e 50%, #0f3460 75%, #1a1a2e 100%);
            overflow-x: hidden;
            min-height: 100vh;
        }
        
        .notification-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        
        .notification-toast.show {
            transform: translateX(0);
        }
        
        .glass-liquid {
            background: linear-gradient(135deg, 
                rgba(139, 92, 246, 0.15) 0%, 
                rgba(124, 58, 237, 0.2) 50%, 
                rgba(109, 40, 217, 0.15) 100%);
            backdrop-filter: blur(25px) saturate(180%);
            -webkit-backdrop-filter: blur(25px) saturate(180%);
            border: 1px solid rgba(192, 132, 252, 0.3);
            border-bottom: 2px solid rgba(192, 132, 252, 0.5);
            box-shadow: 
                0 8px 32px rgba(109, 40, 217, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.2),
                inset 0 -1px 0 rgba(0, 0, 0, 0.1);
        }
        
        .glass-card {
            background: linear-gradient(135deg, 
                rgba(139, 92, 246, 0.12) 0%, 
                rgba(124, 58, 237, 0.18) 100%);
            backdrop-filter: blur(20px) saturate(200%);
            -webkit-backdrop-filter: blur(20px) saturate(200%);
            border: 1px solid rgba(192, 132, 252, 0.25);
            box-shadow: 
                0 8px 32px rgba(109, 40, 217, 0.25),
                inset 0 1px 0 rgba(255, 255, 255, 0.15);
        }
        
        .liquid-glow {
            box-shadow: 
                0 0 25px rgba(192, 132, 252, 0.4),
                0 0 50px rgba(139, 92, 246, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }
        
        .neon-text {
            text-shadow: 0 0 10px rgba(192, 132, 252, 0.8),
                        0 0 20px rgba(192, 132, 252, 0.6),
                        0 0 30px rgba(192, 132, 252, 0.4);
        }
        
        .hover-lift:hover {
            transform: translateY(-5px);
            box-shadow: 
                0 15px 40px rgba(139, 92, 246, 0.4),
                0 0 30px rgba(192, 132, 252, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }
        
        .pulse-glow {
            animation: pulseGlow 3s ease-in-out infinite;
        }
        
        @keyframes pulseGlow {
            0%, 100% { 
                box-shadow: 
                    0 0 20px rgba(192, 132, 252, 0.3),
                    0 0 40px rgba(139, 92, 246, 0.2);
            }
            50% { 
                box-shadow: 
                    0 0 30px rgba(192, 132, 252, 0.6),
                    0 0 60px rgba(139, 92, 246, 0.3);
            }
        }
        
        .liquid-fill {
            background: linear-gradient(135deg, #7e22ce 0%, #c084fc 50%, #a855f7 100%);
            position: relative;
            overflow: hidden;
        }
        
        .cyber-grid {
            background-image: 
                linear-gradient(rgba(192, 132, 252, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(192, 132, 252, 0.05) 1px, transparent 1px);
            background-size: 50px 50px;
        }
        
        .glow-border {
            position: relative;
        }
        
        .download-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            transition: all 0.3s ease;
        }
        
        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(16, 185, 129, 0.4);
        }
        
        .status-offline {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
        }
        
        .slider::-webkit-slider-thumb {
            appearance: none;
            height: 25px;
            width: 25px;
            border-radius: 50%;
            background: linear-gradient(135deg, #c084fc, #7e22ce);
            border: 2px solid white;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(192, 132, 252, 0.8);
        }
        
        .float {
            animation: float 6s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(180deg); }
        }

        .mode-active {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 50%, #6d28d9 100%) !important;
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.6) !important;
        }
        
        .panic-btn {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 50%, #991b1b 100%);
            animation: panicPulse 1s ease-in-out infinite;
        }
        
        @keyframes panicPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .top-bar {
            background: linear-gradient(135deg, rgba(30, 30, 60, 0.9) 0%, rgba(20, 20, 40, 0.95) 100%);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(192, 132, 252, 0.3);
        }
        
        .debug-btn {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 50%, #b45309 100%);
            transition: all 0.3s ease;
        }
        
        .debug-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(245, 158, 11, 0.4);
        }
        
        .btn-disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .btn-disabled:hover {
            transform: none !important;
            box-shadow: none !important;
        }
    </style>
</head>
<body class="text-white cyber-grid">
    <!-- Notification Toast -->
    <div id="notificationToast" class="notification-toast glass-card rounded-2xl p-4 max-w-sm hidden">
        <div class="flex items-start space-x-3">
            <div id="notificationIcon" class="text-2xl mt-1"></div>
            <div class="flex-1">
                <h3 id="notificationTitle" class="font-bold text-lg"></h3>
                <p id="notificationMessage" class="text-purple-200 text-sm mt-1"></p>
            </div>
            <button onclick="dismissNotification()" class="text-purple-300 hover:text-white transition-colors">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>

    <!-- Top Bar -->
    <div class="top-bar fixed top-0 left-0 right-0 z-50">
        <div class="container mx-auto px-4 py-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2">
                        <div id="serviceStatus" class="w-2 h-2 bg-red-500 rounded-full"></div>
                        <span class="text-sm font-semibold">Auto Clicker Pro</span>
                    </div>
                    <div class="text-xs text-purple-300 opacity-75">
                        Hidden Background Service
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <button onclick="testWindowsKey()" 
                            class="px-3 py-1 debug-btn rounded-lg text-xs text-white font-semibold transition-colors">
                        <i class="fab fa-windows mr-1"></i>Test Win Key
                    </button>
                    <button onclick="showNotification('info', 'Service Info', 'Background service is running smoothly.')" 
                            class="px-3 py-1 glass-card rounded-lg text-xs hover:bg-purple-600 transition-colors">
                        <i class="fas fa-info-circle mr-1"></i>Status
                    </button>
                    <button onclick="restartBackend()" 
                            class="px-3 py-1 glass-card rounded-lg text-xs hover:bg-green-600 transition-colors">
                        <i class="fas fa-redo mr-1"></i>Restart
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Animated Background Elements -->
    <div class="fixed inset-0 overflow-hidden pointer-events-none">
        <div class="absolute top-1/4 left-1/4 w-64 h-64 bg-purple-500/10 rounded-full blur-3xl float"></div>
        <div class="absolute top-3/4 right-1/4 w-96 h-96 bg-indigo-600/10 rounded-full blur-3xl float" style="animation-delay: 2s;"></div>
        <div class="absolute bottom-1/4 left-1/2 w-80 h-80 bg-violet-500/10 rounded-full blur-3xl float" style="animation-delay: 4s;"></div>
    </div>

    <div class="relative z-10 min-h-screen flex items-center justify-center p-4 pt-20">
        <div class="glass-liquid rounded-3xl p-8 max-w-4xl w-full liquid-glow">
            <!-- Connection Status -->
            <div id="connectionStatus" class="mb-6 p-4 rounded-2xl glass-card text-center">
                <div class="flex items-center justify-center space-x-3">
                    <div id="connectionDot" class="w-3 h-3 bg-red-500 rounded-full pulse-glow"></div>
                    <span id="connectionText" class="text-purple-200 font-semibold">Searching for Auto Clicker Backend...</span>
                </div>
            </div>

            <!-- Header -->
            <div class="text-center mb-12">
                <div class="flex items-center justify-center mb-6">
                    <div class="relative">
                        <div class="absolute inset-0 bg-purple-500/30 rounded-full blur-lg"></div>
                        <i class="fas fa-mouse-pointer text-5xl text-purple-300 relative z-10 mr-6"></i>
                    </div>
                    <h1 class="text-5xl font-bold font-['Orbitron']">
                        <span class="bg-gradient-to-r from-purple-300 via-purple-200 to-pink-300 bg-clip-text text-transparent">
                            AUTO CLICKER PRO
                        </span>
                    </h1>
                </div>
                <p class="text-purple-200 text-lg font-light">Hidden Service • Web Interface • Advanced Automation</p>
            </div>

            <!-- Download Section (Shows when backend not found) -->
            <div id="downloadSection" class="glass-card rounded-2xl p-6 mb-8 text-center hidden">
                <h2 class="text-2xl font-bold font-['Orbitron'] mb-4 text-purple-300">
                    <i class="fas fa-download mr-3"></i>
                    Download Required
                </h2>
                <p class="text-purple-200 mb-4">Auto Clicker backend not detected. Download and run the application to use this interface.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 max-w-2xl mx-auto">
                    <a href="https://github.com/SenturyHanderserson/SigmiForCCGS/raw/main/content/autoclicker_installer.bat" 
                       class="download-btn py-3 px-6 rounded-xl font-semibold text-white transition-all duration-300">
                        <i class="fas fa-windows mr-2"></i>
                        Windows Installer
                    </a>
                    <a href="https://github.com/SenturyHanderserson/SigmiForCCGS" 
                       class="liquid-fill py-3 px-6 rounded-xl font-semibold text-white transition-all duration-300 transform hover:scale-105">
                        <i class="fab fa-github mr-2"></i>
                        Source Code
                    </a>
                </div>
                <div class="mt-4 text-sm text-purple-300">
                    <p>After downloading, run the installer and start the application.</p>
                    <p>This interface will automatically connect to the backend.</p>
                </div>
            </div>

            <!-- Control Panel (Shows when backend connected) -->
            <div id="controlPanel" class="hidden">
                <!-- Status Display -->
                <div id="statusPanel" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
                    <div class="glass-card rounded-2xl p-6 text-center hover-lift transition-all duration-500">
                        <div id="statusIndicator" class="w-5 h-5 bg-red-500 rounded-full mx-auto mb-4 border-2 border-white/30"></div>
                        <p class="text-sm text-purple-300 font-semibold">STATUS</p>
                        <p id="statusText" class="text-2xl font-bold font-['Orbitron'] text-red-400">STOPPED</p>
                    </div>
                    <div class="glass-card rounded-2xl p-6 text-center hover-lift transition-all duration-500">
                        <div class="relative inline-block mb-4">
                            <div class="absolute inset-0 bg-yellow-400/20 rounded-full blur"></div>
                            <i class="fas fa-bolt text-2xl text-yellow-300 relative z-10"></i>
                        </div>
                        <p class="text-sm text-purple-300 font-semibold">ACTIONS</p>
                        <p id="actionCount" class="text-2xl font-bold font-['Orbitron'] text-yellow-300">0</p>
                    </div>
                    <div class="glass-card rounded-2xl p-6 text-center hover-lift transition-all duration-500">
                        <div class="relative inline-block mb-4">
                            <div class="absolute inset-0 bg-blue-400/20 rounded-full blur"></div>
                            <i class="fas fa-clock text-2xl text-cyan-300 relative z-10"></i>
                        </div>
                        <p class="text-sm text-purple-300 font-semibold">SESSION TIME</p>
                        <p id="sessionTime" class="text-2xl font-bold font-['Orbitron'] text-cyan-300">0s</p>
                    </div>
                </div>

                <!-- Control Panel -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Left Column - Controls -->
                    <div class="space-y-6">
                        <!-- Mode Selection -->
                        <div class="glass-card rounded-2xl p-6 hover-lift transition-all duration-500">
                            <h2 class="text-xl font-bold mb-4 flex items-center font-['Orbitron']">
                                <div class="relative mr-3">
                                    <div class="absolute inset-0 bg-purple-500/20 rounded-full blur"></div>
                                    <i class="fas fa-cog text-purple-300 relative z-10"></i>
                                </div>
                                CLICK MODE
                            </h2>
                            <div class="grid grid-cols-2 gap-3">
                                <button onclick="setMode('click')" class="mode-btn liquid-fill hover:brightness-110 py-3 px-4 rounded-xl font-semibold transition-all duration-300 transform hover:scale-105 border border-purple-400/30" data-mode="click">
                                    LEFT CLICK
                                </button>
                                <button onclick="setMode('right_click')" class="mode-btn liquid-fill hover:brightness-110 py-3 px-4 rounded-xl font-semibold transition-all duration-300 transform hover:scale-105 border border-purple-400/30" data-mode="right_click">
                                    RIGHT CLICK
                                </button>
                                <button onclick="setMode('space')" class="mode-btn liquid-fill hover:brightness-110 py-3 px-4 rounded-xl font-semibold transition-all duration-300 transform hover:scale-105 border border-purple-400/30" data-mode="space">
                                    SPACE BAR
                                </button>
                                <button onclick="setCustomKey()" class="mode-btn liquid-fill hover:brightness-110 py-3 px-4 rounded-xl font-semibold transition-all duration-300 transform hover:scale-105 border border-purple-400/30" data-mode="custom">
                                    CUSTOM KEY
                                </button>
                            </div>
                        </div>

                        <!-- Speed Control -->
                        <div class="glass-card rounded-2xl p-6 hover-lift transition-all duration-500">
                            <h2 class="text-xl font-bold mb-4 flex items-center font-['Orbitron']">
                                <div class="relative mr-3">
                                    <div class="absolute inset-0 bg-green-500/20 rounded-full blur"></div>
                                    <i class="fas fa-tachometer-alt text-green-300 relative z-10"></i>
                                </div>
                                SPEED CONTROL
                            </h2>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm text-purple-300 mb-3 font-semibold">CLICK INTERVAL: <span id="intervalValue" class="text-cyan-300">0.05</span>s</label>
                                    <input type="range" min="1" max="200" value="5" onchange="setInterval(this.value/100)" 
                                           class="w-full h-3 bg-purple-900/50 rounded-2xl appearance-none cursor-pointer slider">
                                </div>
                                <div class="flex justify-between text-xs text-purple-400 font-semibold">
                                    <span>FASTER ←</span>
                                    <span>[0.005s - 2.0s]</span>
                                    <span>→ SLOWER</span>
                                </div>
                                <div class="text-xs text-purple-300 text-center">
                                    <span id="cpsValue">20 CPS</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column - Settings -->
                    <div class="space-y-6">
                        <!-- Behavior Settings -->
                        <div class="glass-card rounded-2xl p-6 hover-lift transition-all duration-500">
                            <h2 class="text-xl font-bold mb-4 flex items-center font-['Orbitron']">
                                <div class="relative mr-3">
                                    <div class="absolute inset-0 bg-blue-500/20 rounded-full blur"></div>
                                    <i class="fas fa-brain text-blue-300 relative z-10"></i>
                                </div>
                                HUMAN BEHAVIOR
                            </h2>
                            <div class="space-y-4">
                                <label class="flex items-center space-x-4 cursor-pointer group">
                                    <div class="relative">
                                        <input type="checkbox" id="jitterToggle" checked onchange="setJitter(this.checked)" 
                                               class="sr-only peer">
                                        <div class="w-12 h-6 bg-purple-900/50 rounded-full peer-checked:bg-purple-600 transition-all duration-300"></div>
                                        <div class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full transition-transform duration-300 peer-checked:translate-x-6"></div>
                                    </div>
                                    <span class="text-purple-200 font-semibold group-hover:text-white transition-colors">MOUSE JITTER</span>
                                </label>
                                <label class="flex items-center space-x-4 cursor-pointer group">
                                    <div class="relative">
                                        <input type="checkbox" id="humanLikeToggle" checked onchange="setHumanLike(this.checked)"
                                               class="sr-only peer">
                                        <div class="w-12 h-6 bg-purple-900/50 rounded-full peer-checked:bg-purple-600 transition-all duration-300"></div>
                                        <div class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full transition-transform duration-300 peer-checked:translate-x-6"></div>
                                    </div>
                                    <span class="text-purple-200 font-semibold group-hover:text-white transition-colors">RANDOM TIMING</span>
                                </label>
                            </div>
                        </div>

                        <!-- Main Control -->
                        <div class="glass-card rounded-2xl p-6 hover-lift transition-all duration-500">
                            <h2 class="text-xl font-bold mb-4 flex items-center font-['Orbitron']">
                                <div class="relative mr-3">
                                    <div class="absolute inset-0 bg-green-500/20 rounded-full blur"></div>
                                    <i class="fas fa-play-circle text-green-300 relative z-10"></i>
                                </div>
                                QUICK CONTROL
                            </h2>
                            <div class="space-y-4">
                                <button onclick="startAutoClicker()" id="startStopBtn"
                                        class="w-full liquid-fill hover:brightness-110 py-4 px-6 rounded-2xl font-bold text-lg font-['Orbitron'] transition-all duration-300 transform hover:scale-105 pulse-glow border border-green-400/30">
                                    <i class="fas fa-play mr-3"></i>
                                    START AUTO CLICKER (F6)
                                </button>
                                <button onclick="stopAutoClicker()" id="panicStopBtn"
                                        class="w-full panic-btn py-3 px-6 rounded-2xl font-bold font-['Orbitron'] transition-all duration-300 transform hover:scale-105 border border-red-400/30 btn-disabled">
                                    <i class="fas fa-skull-crossbones mr-3"></i>
                                    STOP AUTO CLICKER (F6)
                                </button>
                            </div>
                        </div>

                        <!-- Debug Section -->
                        <div class="glass-card rounded-2xl p-6 hover-lift transition-all duration-500">
                            <h2 class="text-xl font-bold mb-4 flex items-center font-['Orbitron']">
                                <div class="relative mr-3">
                                    <div class="absolute inset-0 bg-orange-500/20 rounded-full blur"></div>
                                    <i class="fas fa-bug text-orange-300 relative z-10"></i>
                                </div>
                                DEBUG TOOLS
                            </h2>
                            <div class="space-y-3">
                                <button onclick="testWindowsKey()"
                                        class="w-full debug-btn py-3 px-6 rounded-xl font-semibold text-white transition-all duration-300 transform hover:scale-105">
                                    <i class="fab fa-windows mr-2"></i>
                                    TEST WINDOWS KEY
                                </button>
                                <button onclick="testSingleClick()"
                                        class="w-full bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-600 hover:to-cyan-600 py-3 px-6 rounded-xl font-semibold text-white transition-all duration-300 transform hover:scale-105">
                                    <i class="fas fa-mouse-pointer mr-2"></i>
                                    TEST SINGLE CLICK
                                </button>
                            </div>
                        </div>

                        <!-- System Control -->
                        <div class="glass-card rounded-2xl p-6 hover-lift transition-all duration-500">
                            <h2 class="text-xl font-bold mb-4 flex items-center font-['Orbitron']">
                                <div class="relative mr-3">
                                    <div class="absolute inset-0 bg-orange-500/20 rounded-full blur"></div>
                                    <i class="fas fa-cogs text-orange-300 relative z-10"></i>
                                </div>
                                SYSTEM CONTROL
                            </h2>
                            <div class="grid grid-cols-2 gap-3">
                                <button onclick="restartBackend()" 
                                        class="bg-gradient-to-r from-orange-500 to-amber-500 hover:from-orange-600 hover:to-amber-600 py-3 px-4 rounded-xl font-semibold transition-all duration-300 transform hover:scale-105">
                                    <i class="fas fa-redo mr-2"></i>RESTART
                                </button>
                                <button onclick="shutdownBackend()" 
                                        class="bg-gradient-to-r from-gray-600 to-gray-700 hover:from-gray-700 hover:to-gray-800 py-3 px-4 rounded-xl font-semibold transition-all duration-300 transform hover:scale-105">
                                    <i class="fas fa-power-off mr-2"></i>SHUTDOWN
                                </button>
                            </div>
                        </div>

                        <!-- Hotkeys Info -->
                        <div class="glass-card rounded-2xl p-6 hover-lift transition-all duration-500">
                            <h2 class="text-xl font-bold mb-4 flex items-center font-['Orbitron']">
                                <div class="relative mr-3">
                                    <div class="absolute inset-0 bg-yellow-500/20 rounded-full blur"></div>
                                    <i class="fas fa-keyboard text-yellow-300 relative z-10"></i>
                                </div>
                                HOTKEYS
                            </h2>
                            <div class="space-y-3 text-sm">
                                <div class="flex justify-between items-center">
                                    <span class="text-purple-200 font-semibold">Toggle Start/Stop:</span>
                                    <kbd class="px-3 py-1 bg-purple-600 rounded-lg font-mono font-bold border border-purple-400/30">F6</kbd>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-purple-200 font-semibold">Emergency Stop:</span>
                                    <kbd class="px-3 py-1 bg-red-600 rounded-lg font-mono font-bold border border-red-400/30">F7</kbd>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="mt-8 text-center">
                <div class="glass-card rounded-2xl p-4 inline-block">
                    <p class="text-purple-300 font-semibold">Auto Clicker Pro • Hidden Service • Web Interface</p>
                    <p class="text-purple-400 text-sm mt-1" id="connectionInfo">Checking connection...</p>
                </div>
            </div>
        </div>
    </div>

<script>
let isConnected = false;
let currentStatus = {};
let connectionAttempts = 0;
let isRunning = false;

function showNotification(message, type = "info") {
    console.log(`🔔 [${type.toUpperCase()}] ${message}`);
    
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `fixed bottom-4 right-4 p-4 rounded-lg z-50 transition-all duration-300 ${
        type === 'error' ? 'bg-red-500 text-white' : 
        type === 'success' ? 'bg-green-500 text-white' : 
        'bg-blue-500 text-white'
    }`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    // Remove after 3 seconds
    setTimeout(() => {
        notification.style.opacity = '0';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

async function checkBackendConnection() {
    try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 3000);
        
        const res = await fetch("http://localhost:8080/status.json", {
            signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        
        currentStatus = await res.json();
        connectionAttempts = 0;
        
        if (!isConnected) {
            isConnected = true;
            showConnectedUI();
            showNotification("✅ Connected to Auto Clicker backend", "success");
        }
        
        updateUI();
        
    } catch (err) {
        connectionAttempts++;
        
        if (isConnected || connectionAttempts === 1) {
            console.warn("❌ Backend connection failed:", err.message);
        }
        
        if (isConnected) {
            isConnected = false;
            showDisconnectedUI();
            if (connectionAttempts > 3) {
                showNotification("❌ Lost connection to backend", "error");
            }
        }
        
        // Show download section if not connected after several attempts
        if (connectionAttempts > 2) {
            document.getElementById('downloadSection').classList.remove('hidden');
            document.getElementById('controlPanel').classList.add('hidden');
        }
    }
}

function showConnectedUI() {
    console.log("✅ Connected to backend - updating UI");
    
    document.getElementById('connectionDot').className = 'w-3 h-3 bg-green-500 rounded-full pulse-glow';
    document.getElementById('connectionText').textContent = 'Connected to Auto Clicker Backend';
    document.getElementById('connectionText').className = 'text-green-300 font-semibold';
    document.getElementById('connectionInfo').textContent = 'Connected • Backend Active';
    document.getElementById('serviceStatus').className = 'w-2 h-2 bg-green-500 rounded-full';
    
    document.getElementById('downloadSection').classList.add('hidden');
    document.getElementById('controlPanel').classList.remove('hidden');
}

function showDisconnectedUI() {
    console.log("❌ Disconnected from backend - updating UI");
    
    document.getElementById('connectionDot').className = 'w-3 h-3 bg-red-500 rounded-full pulse-glow';
    document.getElementById('connectionText').textContent = 'Searching for Auto Clicker Backend...';
    document.getElementById('connectionText').className = 'text-red-300 font-semibold';
    document.getElementById('connectionInfo').textContent = 'Disconnected • Check if backend is running';
    document.getElementById('serviceStatus').className = 'w-2 h-2 bg-red-500 rounded-full';
}

function updateUI() {
    if (!isConnected) return;
    
    // Update running state
    isRunning = currentStatus.running;
    
    // Update status display
    document.getElementById('intervalValue').textContent = Number(currentStatus.interval).toFixed(3);
    document.getElementById('statusText').textContent = isRunning ? "RUNNING" : "STOPPED";
    document.getElementById('statusText').className = `text-2xl font-bold font-['Orbitron'] ${
        isRunning ? 'text-green-400' : 'text-red-400'
    }`;
    document.getElementById('statusIndicator').className = `w-5 h-5 rounded-full mx-auto mb-4 border-2 border-white/30 ${
        isRunning ? 'bg-green-500' : 'bg-red-500'
    }`;
    
    document.getElementById('actionCount').textContent = currentStatus.actions;
    document.getElementById('sessionTime').textContent = currentStatus.session_time + "s";

    // Update toggles
    document.getElementById('jitterToggle').checked = currentStatus.jitter_enabled;
    document.getElementById('humanLikeToggle').checked = currentStatus.human_like;

    // Update active mode
    document.querySelectorAll(".mode-btn").forEach(btn => {
        btn.classList.remove("mode-active");
        if (btn.dataset.mode === currentStatus.mode) {
            btn.classList.add("mode-active");
        }
    });

    // Update button states
    updateButtonStates();
    
    // Update CPS display
    updateCPSDisplay();
}

function updateButtonStates() {
    const startBtn = document.getElementById('startStopBtn');
    const stopBtn = document.getElementById('panicStopBtn');
    
    if (isRunning) {
        // When running: disable start button, enable stop button
        startBtn.classList.add('btn-disabled');
        startBtn.classList.remove('liquid-fill', 'pulse-glow');
        startBtn.style.background = 'linear-gradient(135deg, #6b7280 0%, #4b5563 100%)';
        
        stopBtn.classList.remove('btn-disabled');
        stopBtn.style.animation = 'panicPulse 1s ease-in-out infinite';
    } else {
        // When stopped: enable start button, disable stop button
        startBtn.classList.remove('btn-disabled');
        startBtn.classList.add('liquid-fill', 'pulse-glow');
        startBtn.style.background = '';
        
        stopBtn.classList.add('btn-disabled');
        stopBtn.style.animation = 'none';
    }
}

function updateCPSDisplay() {
    const interval = currentStatus.interval;
    const cps = interval > 0 ? (1 / interval).toFixed(1) : "∞";
    document.getElementById('cpsValue').textContent = `${cps} CPS`;
}

async function sendCommand(command, extra = {}) {
    if (!isConnected) {
        showNotification("⚠️ Not connected to backend. Please check if the Auto Clicker application is running.", "error");
        console.warn("⚠️ Not connected, skipping command:", command);
        return null;
    }
    
    console.log("📤 Sending command:", command, extra);
    
    try {
        const response = await fetch("http://localhost:8080/command", {
            method: "POST",
            headers: { 
                "Content-Type": "application/json",
                "Accept": "application/json"
            },
            body: JSON.stringify({ command, ...extra })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        console.log("📥 Command response:", data);
        
        // Refresh status after command
        setTimeout(checkBackendConnection, 100);
        
        return data;
        
    } catch (err) {
        console.error("❌ Command failed:", err);
        showNotification(`❌ Command failed: ${err.message}`, "error");
        return null;
    }
}

// Command functions - SEPARATE functions for start and stop
function startAutoClicker() { 
    if (!isRunning) {
        sendCommand("start_clicker"); 
    }
}

function stopAutoClicker() { 
    if (isRunning) {
        sendCommand("stop_clicker"); 
    }
}

function setMode(m) { 
    sendCommand("set_mode", { mode: m }); 
}

function setInterval(v) { 
    // Allow much smaller intervals for higher CPS (down to 0.005s = 200 CPS)
    const interval = Math.max(0.005, v);
    sendCommand("set_interval", { interval: interval }); 
}

function setJitter(e) { 
    sendCommand("set_jitter", { enabled: e }); 
}

function setHumanLike(e) { 
    sendCommand("set_human_like", { enabled: e }); 
}

function setCustomKey() {
    const k = prompt("Enter custom key (e.g., 'a', 'enter', 'space'):");
    if (k) sendCommand("set_custom_key", { key: k });
}

// Debug functions
async function testWindowsKey() {
    console.log("🪟 Testing Windows key press...");
    const result = await sendCommand("debug_windows_key");
    if (result && result.status === "ok") {
        showNotification("✅ Windows key pressed successfully!", "success");
    } else {
        showNotification("❌ Failed to press Windows key", "error");
    }
}

async function testSingleClick() {
    console.log("🖱️ Testing single click...");
    const result = await sendCommand("debug_single_click");
    if (result && result.status === "ok") {
        showNotification("✅ Single click performed!", "success");
    } else {
        showNotification("❌ Failed to perform click", "error");
    }
}

function restartBackend() {
    if (confirm("Are you sure you want to restart the backend?")) {
        sendCommand("restart");
        showNotification("🔄 Restarting backend service...", "info");
    }
}

function shutdownBackend() {
    if (confirm("Are you sure you want to shutdown the backend?")) {
        sendCommand("shutdown");
        showNotification("🔌 Shutting down backend service...", "info");
    }
}

// Initialize connection checking
console.log("🚀 Auto Clicker Pro Web Interface starting...");
setInterval(checkBackendConnection, 1000); // Check every second for real-time updates
// Initial connection check
setTimeout(checkBackendConnection, 500);
</script>

</body>
</html>
